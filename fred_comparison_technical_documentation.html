<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realtor Comparison Page - Technical Documentation</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 30px;
            border-left: 4px solid #3498db;
            padding-left: 15px;
        }
        h3 {
            color: #2c3e50;
            margin-top: 25px;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .sql-query {
            background-color: #e8f4f8;
            border-left: 4px solid #17a2b8;
        }
        .js-code {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .api-endpoint {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        .flow-diagram {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }
        .arrow {
            font-size: 18px;
            color: #3498db;
            margin: 10px 0;
        }
        .table-schema {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }
        .table-schema th, .table-schema td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .table-schema th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .important-note {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        .warning {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        ul li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Realtor Metrics Comparison - Technical Implementation Guide</h1>
        <div class="important-note">
            <strong>Purpose:</strong> This document explains the Realtor-based county and ZIP comparison implementation. It covers database schemas, API endpoints, SQL queries, frontend logic, and the complete data flow for comparing listing metrics across multiple geographies.
        </div>
        <h2>1. System Architecture Overview</h2>
        <div class="flow-diagram">
            <strong>Data Flow Architecture</strong><br><br>
            Frontend (Report Comparison UI)
            <div class="arrow">↓</div>
            API Endpoints (/api/county-comparison, /api/zip-series, /api/zip-comparison)
            <div class="arrow">↓</div>
            PostgreSQL Database (otherdata.realtor_historic / otherdata.realtor_current_month)
            <div class="arrow">↓</div>
            Chart.js Visualization
        </div>
        <h2>2. Database Schema and SQL Queries</h2>
        <h3>2.1 Realtor Metrics</h3>
        <p>County and ZIP comparisons use Realtor-supplied metrics stored in <code>otherdata.realtor_historic</code> and <code>otherdata.realtor_current_month</code>.</p>
        <table class="table-schema">
            <tr><th>Key</th><th>Label</th><th>Source column(s)</th></tr>
            <tr><td>avg_listing_price</td><td>Average Listing Price</td><td>median_listing_price</td></tr>
            <tr><td>median_listing_price_proxy</td><td>Median Listing Price (proxy)</td><td>median_listing_price</td></tr>
            <tr><td>avg_price_per_sqft</td><td>Average Price per Sq Ft</td><td>median_listing_price_per_square_foot</td></tr>
            <tr><td>avg_days_on_market</td><td>Average Days on Market</td><td>median_days_on_market</td></tr>
            <tr><td>active_listing_count</td><td>Active Listings</td><td>active_listing_count</td></tr>
            <tr><td>new_listing_count</td><td>New Listings</td><td>new_listing_count</td></tr>
            <tr><td>total_listing_count</td><td>Total Listings</td><td>total_listing_count</td></tr>
            <tr><td>pending_ratio</td><td>Pending Ratio</td><td>pending_ratio</td></tr>
            <tr><td>price_increased_share</td><td>Price Increased Share</td><td>price_increased_share</td></tr>
            <tr><td>price_reduced_share</td><td>Price Reduced Share</td><td>price_reduced_share</td></tr>
        </table>
        <h3>2.2 SQL Query: Fetch County Series</h3>
        <div class="code-block sql-query">
SELECT LPAD(cs.county_fips::text, 5, '0') AS county_fips,
       cs.county_name,
       cs.month_date_yyyymm::int AS month_date_yyyymm,
       NULLIF(cs.median_listing_price, -1) AS avg_listing_price,
       NULLIF(cs.median_listing_price_per_square_foot, -1) AS avg_price_per_sqft,
       NULLIF(cs.median_days_on_market, -1) AS avg_days_on_market,
       NULLIF(cs.active_listing_count, -1) AS active_listing_count,
       NULLIF(cs.new_listing_count, -1) AS new_listing_count,
       NULLIF(cs.total_listing_count, -1) AS total_listing_count,
       NULLIF(cs.pending_ratio, -1) AS pending_ratio,
       NULLIF(cs.price_increased_share, -1) AS price_increased_share,
       NULLIF(cs.price_reduced_share, -1) AS price_reduced_share
FROM (
  SELECT * FROM otherdata.realtor_county_historic
  UNION ALL
  SELECT * FROM otherdata.realtor_county_current_month
) cs
WHERE LPAD(cs.county_fips::text, 5, '0') = ANY($1::text[])
  AND COALESCE(cs.quality_flag::numeric, 1) = 1
  AND cs.month_date_yyyymm::int >= $2
ORDER BY county_fips ASC, month_date_yyyymm ASC;
        </div>
        <h2>3. Backend API Endpoints</h2>
        <h3>3.1 /api/county-comparison</h3>
        <div class="code-block api-endpoint">
app.get('/api/county-comparison', async (req, res) => {
  try {
    const { county_fips, months } = req.query;
    if (!county_fips || String(county_fips).trim().length === 0) {
      return res.status(400).json({ success: false, error: 'county_fips (CSV) is required' });
    }
    const list = String(county_fips).split(',').map(s => s.trim()).filter(Boolean);
    const monthsBack = months ? Number(months) : 24;
    const result = await dbQueries.getCountySeriesMultiByFips(list, monthsBack);
    return res.json({ success: true, count: result.rowCount, data: result.rows });
  } catch (error) {
    console.error('Error fetching county comparison:', error);
    return res.status(500).json({ success: false, error: 'Failed to fetch county comparison', message: error.message });
  }
});
        </div>
        <h3>3.2 /api/zip-series & /api/zip-comparison</h3>
        <div class="code-block api-endpoint">
app.get('/api/zip-series', async (req, res) => {
  try {
    const { zip, months } = req.query;
    if (!zip || String(zip).trim().length === 0) {
      return res.status(400).json({ success: false, error: 'zip is required' });
    }
    const monthsBack = months ? Number(months) : 24;
    const result = await dbQueries.getZipSeriesByZip(String(zip).trim(), monthsBack);
    return res.json({ success: true, count: result.rowCount, data: result.rows });
  } catch (error) {
    console.error('Error fetching ZIP series:', error);
    return res.status(500).json({ success: false, error: 'Failed to fetch ZIP series', message: error.message });
  }
});

app.get('/api/zip-comparison', async (req, res) => {
  try {
    const { zips, months } = req.query;
    if (!zips || String(zips).trim().length === 0) {
      return res.status(400).json({ success: false, error: 'zips (CSV) is required' });
    }
    const list = String(zips).split(',').map(s => s.trim()).filter(Boolean);
    const monthsBack = months ? Number(months) : 24;
    const result = await dbQueries.getZipSeriesMultiByZip(list, monthsBack);
    return res.json({ success: true, count: result.rowCount, data: result.rows });
  } catch (error) {
    console.error('Error fetching ZIP comparison series:', error);
    return res.status(500).json({ success: false, error: 'Failed to fetch ZIP comparison', message: error.message });
  }
});
        </div>
        <h2>4. Frontend Implementation</h2>
        <h3>4.1 Series Options Loading</h3>
        <div class="code-block js-code">
const REALTOR_METRICS = [
  { key: 'avg_listing_price', label: 'Average Listing Price', valueType: 'currency', decimals: 0 },
  { key: 'median_listing_price_proxy', label: 'Median Listing Price (proxy)', valueType: 'currency', decimals: 0 },
  { key: 'avg_price_per_sqft', label: 'Average Price per Sq Ft', valueType: 'currency', decimals: 0 },
  { key: 'avg_days_on_market', label: 'Average Days on Market', valueType: 'number' },
  { key: 'active_listing_count', label: 'Active Listings', valueType: 'number' },
  { key: 'new_listing_count', label: 'New Listings', valueType: 'number' },
  { key: 'total_listing_count', label: 'Total Listings', valueType: 'number' },
  { key: 'pending_ratio', label: 'Pending Ratio', valueType: 'ratio', percentDecimals: 1 },
  { key: 'price_increased_share', label: 'Price Increased Share', valueType: 'ratio', percentDecimals: 1 },
  { key: 'price_reduced_share', label: 'Price Reduced Share', valueType: 'ratio', percentDecimals: 1 }
];

function loadSeriesOptions() {
  const select = document.getElementById('series-select');
  select.innerHTML = '';
  REALTOR_METRICS.forEach(metric => {
    const option = document.createElement('option');
    option.value = metric.key;
    option.textContent = metric.label;
    select.appendChild(option);
  });
  select.value = REALTOR_METRICS[0]?.key;
}
        </div>
        <h3>4.2 County Data Fetching</h3>
        <div class="code-block js-code">
async function fetchCountySeriesData(countyIds, metricKey) {
  const params = new URLSearchParams();
  params.set('county_fips', countyIds.join(','));
  params.set('months', '60');
  const response = await fetch(`/api/county-comparison?${params}`);
  if (!response.ok) throw new Error('Failed to fetch county comparison data');
  const json = await response.json();
  if (!json.success) return [];

  const grouped = {};
  json.data.forEach(row => {
    const id = row.county_fips;
    if (!grouped[id]) grouped[id] = { county: id, name: row.county_name, points: [] };
    grouped[id].points.push({
      x: parseYyyymmToDate(row.month_date_yyyymm),
      y: toNumberOrNull(row[metricKey])
    });
  });

  return Object.values(grouped).map(entry => {
    entry.points.sort((a, b) => (a.x?.getTime?.() || 0) - (b.x?.getTime?.() || 0));
    return entry;
  });
}
        </div>
        <h3>4.3 Value Formatting</h3>
        <div class="code-block js-code">
function formatMetricValue(value, meta) {
  if (value == null || Number.isNaN(value)) return '—';
  if (!meta || meta.valueType === 'number') {
    return Number(value).toLocaleString();
  }
  if (meta.valueType === 'currency') {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      maximumFractionDigits: meta.decimals ?? 0,
      minimumFractionDigits: meta.decimals ?? 0
    }).format(value);
  }
  if (meta.valueType === 'ratio') {
    return `${(Number(value) * 100).toFixed(meta.percentDecimals ?? 1)}%`;
  }
  return Number(value).toLocaleString();
}
        </div>
        <h2>5. Realtor Metric Examples</h2>
        <table class="table-schema">
            <tr><th>Key</th><th>Description</th><th>Notes</th></tr>
            <tr><td>avg_listing_price</td><td>Median listing price (currency)</td><td>Displayed in USD</td></tr>
            <tr><td>avg_days_on_market</td><td>Median days on market</td><td>Integer values</td></tr>
            <tr><td>pending_ratio</td><td>Pending listings ÷ total listings</td><td>Rendered as percentage</td></tr>
        </table>
    </div>
</body>
</html> 