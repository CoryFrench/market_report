<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Retrieve Report</title>
	<link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="letterhead">
            <div class="report-title"><img src="logo.png" alt="Waterfront Properties" class="report-logo"></div>
        </div>
        <div class="form-container">
            <div class="form-header">
                <h1>Retrieve Your Report</h1>
                <p>Enter your Report ID or retrieve it by email.</p>
            </div>
            <div class="retrieve-toggle tabs" role="tablist" aria-label="Retrieve options">
                <button id="toggleId" class="toggle-btn tab active" role="tab" aria-selected="true" aria-controls="panelId" type="button">Use Report ID</button>
                <button id="toggleEmail" class="toggle-btn tab" role="tab" aria-selected="false" aria-controls="panelEmail" type="button">Retrieve by Email</button>
            </div>

            <div id="panelId" class="retrieve-panel" role="tabpanel" aria-labelledby="toggleId">
                <div class="retrieve-card integrated">
                    <h3>Have your Report ID?</h3>
                    <p class="muted">Example format: lastname-id (e.g., smith-24)</p>
                    <form id="retrieveByIdForm">
                        <div class="form-group">
                            <label for="referenceId">Report ID</label>
                            <input type="text" id="referenceId" name="referenceId" placeholder="lastname-id" required aria-invalid="false" aria-describedby="refError">
                            <div id="refError" class="field-error" aria-live="polite"></div>
                        </div>
                        <button type="submit" class="form-submit">OPEN REPORT</button>
                    </form>
                </div>
            </div>

            <div id="panelEmail" class="retrieve-panel" role="tabpanel" aria-labelledby="toggleEmail" style="display:none;">
                <div class="retrieve-card integrated">
                    <h3>Forgot your Report ID?</h3>
                    <p class="muted">We’ll email your report link to the address we have on file.</p>
                    <form id="retrieveByEmailForm">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="text" id="email" name="email" placeholder="you@example.com" required aria-invalid="false" aria-describedby="emailError">
                            <div id="emailError" class="field-error" aria-live="polite"></div>
                        </div>
                        <button type="submit" class="form-submit">EMAIL ME MY LINK</button>
                    </form>
                </div>
            </div>

            <div id="message" class="form-message" style="display:none;"></div>
        </div>
    </div>

	<script>
		const byIdForm = document.getElementById('retrieveByIdForm');
		const byEmailForm = document.getElementById('retrieveByEmailForm');
		const messageDiv = document.getElementById('message');

		// Prefer production paths under /report to ensure correct destination URLs
		const PUBLIC_BASE = '/report';
		const API_BASE = '/report/api';
    const panelId = document.getElementById('panelId');
    const panelEmail = document.getElementById('panelEmail');
    const toggleId = document.getElementById('toggleId');
    const toggleEmail = document.getElementById('toggleEmail');

    function showId() {
        panelId.style.display = 'block';
        panelEmail.style.display = 'none';
        toggleId.classList.add('active');
        toggleEmail.classList.remove('active');
        toggleId.setAttribute('aria-selected', 'true');
        toggleEmail.setAttribute('aria-selected', 'false');
        messageDiv.style.display = 'none';
    }
    function showEmail() {
        panelId.style.display = 'none';
        panelEmail.style.display = 'block';
        toggleId.classList.remove('active');
        toggleEmail.classList.add('active');
        toggleId.setAttribute('aria-selected', 'false');
        toggleEmail.setAttribute('aria-selected', 'true');
        messageDiv.style.display = 'none';
    }

    toggleId.addEventListener('click', showId);
    toggleEmail.addEventListener('click', showEmail);

    // Real-time validation for reference ID (keep data on tab switch)
    const refInput = document.getElementById('referenceId');
    const refError = document.getElementById('refError');
    const refPattern = /^[a-z0-9]+-[0-9]+$/;
    refInput.addEventListener('input', () => {
        const v = String(refInput.value || '').trim().toLowerCase();
        if (v.length === 0) {
            refError.textContent = '';
            refInput.setAttribute('aria-invalid', 'false');
            return;
        }
        if (!refPattern.test(v)) {
            refError.textContent = 'Use format lastname-id (e.g., smith-24).';
            refInput.setAttribute('aria-invalid', 'true');
        } else {
            refError.textContent = '';
            refInput.setAttribute('aria-invalid', 'false');
        }
    });

		byIdForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        messageDiv.style.display = 'none';
        messageDiv.className = 'form-message';
			const ref = String(refInput.value || '').trim().toLowerCase();
        if (!refPattern.test(ref)) {
            refError.textContent = 'Use format lastname-id (e.g., smith-24).';
            refInput.setAttribute('aria-invalid', 'true');
            return;
        }
        if (!ref) return;
			const clean = ref.replace(/[^a-z0-9-]/g, '').replace(/-+/g, '-').replace(/^-|-$/g, '');
			// Validate existence before redirect for better UX
			try {
				const resp = await fetch(`${API_BASE}/reports/complete/${clean}`);
				if (resp.ok) {
					window.location.href = `${PUBLIC_BASE}/reports/${clean}`;
					return;
				}
				const json = await resp.json().catch(() => ({}));
                refError.textContent = json.error || 'We could not find a report with that Report ID.';
				refInput.setAttribute('aria-invalid', 'true');
				messageDiv.className = 'form-message error';
                messageDiv.textContent = 'Please check your Report ID or try retrieving by email.';
				messageDiv.style.display = 'block';
			} catch (_) {
				messageDiv.className = 'form-message error';
                messageDiv.textContent = 'Unable to verify the Report ID right now. Please try again.';
				messageDiv.style.display = 'block';
			}
    });

    // Real-time validation for email
		const emailInput = document.querySelector('#retrieveByEmailForm #email');
    const emailError = document.getElementById('emailError');
    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    emailInput.addEventListener('input', () => {
        const v = String(emailInput.value || '').trim();
        if (v.length === 0) {
            emailError.textContent = '';
            emailInput.setAttribute('aria-invalid', 'false');
            return;
        }
        if (!emailPattern.test(v)) {
            emailError.textContent = 'Enter a valid email address.';
            emailInput.setAttribute('aria-invalid', 'true');
        } else {
            emailError.textContent = '';
            emailInput.setAttribute('aria-invalid', 'false');
        }
    });

    byEmailForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        messageDiv.style.display = 'none';
        messageDiv.className = 'form-message';
        const email = String(emailInput.value || '').trim();
        if (!emailPattern.test(email)) {
            emailError.textContent = 'Enter a valid email address.';
            emailInput.setAttribute('aria-invalid', 'true');
            return;
        }
        if (!email) return;
		try {
			const resp = await fetch(`${API_BASE}/reports/retrieve-by-email`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });
            const json = await resp.json();
            if (resp.ok && json.success) {
                messageDiv.className = 'form-message success';
                messageDiv.textContent = 'We’ll email your report link to the address we have on file.';
            } else {
                messageDiv.className = 'form-message error';
                messageDiv.textContent = json.error || 'No report found for this email.';
            }
        } catch (err) {
            messageDiv.className = 'form-message error';
            messageDiv.textContent = 'Failed to process request. Please try again later.';
        } finally {
            messageDiv.style.display = 'block';
        }
    });
	</script>
</body>
</html>

