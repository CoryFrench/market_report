<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Area Analysis Report</title>
    <link rel="stylesheet" href="/styles.css">
    <!-- Chart.js for interactive charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Define API_BASE early so all subsequent scripts can use it
        window.API_BASE = window.location.pathname.startsWith('/report/') ? '/report/api' : '/api';
        const API_BASE = window.API_BASE;
    </script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mobile header fix - highest priority */
        @media screen and (max-width: 768px) {
            .container .letterhead .header-info {
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-around !important;
                align-items: center !important;
                gap: 15px !important;
                padding: 0 !important;
                width: 100% !important;
            }
            
            .container .letterhead .header-info .header-item {
                display: block !important;
                text-align: center !important;
                flex: 1 1 45% !important;
                max-width: 45% !important;
            }
            
            /* Hide ZIP block on mobile */
            #zipHeaderItem {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                position: absolute !important;
                left: -9999px !important;
                width: 0 !important;
                height: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden !important;
            }
        }
        
        @media screen and (max-width: 480px) {
            .container .letterhead .header-info {
                display: flex !important;
                flex-direction: row !important;
                justify-content: space-around !important;
                align-items: center !important;
                gap: 12px !important;
                padding: 0 !important;
                width: 100% !important;
            }
            
            .container .letterhead .header-info .header-item {
                display: block !important;
                text-align: center !important;
                flex: 1 1 45% !important;
                max-width: 45% !important;
            }
            
            /* Hide ZIP block on small mobile */
            #zipHeaderItem {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                position: absolute !important;
                left: -9999px !important;
                width: 0 !important;
                height: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                overflow: hidden !important;
            }
        }

        /* Desktop/tablet header layout */
        .container .letterhead .header-info {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto; /* by | logo | for | zip(hidden) */
            align-items: center;
            gap: 16px;
            padding: 8px 0;
        }
        .container .letterhead .header-info .header-item {
            text-align: center;
        }
        .container .letterhead .header-info .header-logo {
            text-align: center;
        }
        #headerLogo {
            max-height: 60px;
            width: auto;
            display: inline-block;
        }
        
        /* Development Chart Legend Clickable Styling */
        #dev-comparison-chart + div .chartjs-legend li,
        .chartjs-legend-item {
            cursor: pointer !important;
            transition: all 0.2s ease;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        #dev-comparison-chart + div .chartjs-legend li:hover,
        .chartjs-legend-item:hover {
            background-color: rgba(52, 152, 219, 0.1);
            transform: translateY(-1px);
        }
        
        /* Development Actions Popup */
        #developmentActionsPopup {
            position: fixed !important;
            z-index: 9999 !important;
            display: none !important;
            background: white !important;
            border: 1px solid #ddd !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            padding: 12px !important;
            min-width: 160px !important;
            max-width: 200px !important;
        }
        
        #developmentActionsPopup[style*="display: block"] {
            display: block !important;
        }
        
        #developmentActionsPopup button:hover {
            background-color: #f8f9fa !important;
            border-color: #adb5bd !important;
            transform: translateY(-1px) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="letterhead">
            <div class="header-info">
                <div class="header-item">
                    <div class="header-label">Prepared by</div>
                    <div class="header-value" id="agentName">Agent Name</div>
                </div>
                <div class="header-logo">
                    <img id="headerLogo" src="" alt="Logo" />
                </div>
                <div class="header-item">
                    <div class="header-label">Prepared for</div>
                    <div class="header-value" id="buyerName">Buyer Name</div>
                </div>
                <!-- Keep ZIP node in DOM for script compatibility but hide visually -->
                <div class="header-item" id="zipHeaderItem" style="display:none; visibility:hidden;">
                    <div class="header-label">Zip</div>
                    <div class="header-value" id="zipCode">ZIP Code</div>
                </div>
            </div>
        </div>

        <div class="content">
            
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Loading comprehensive market analysis...</p>
            </div>

            <div id="error" class="error" style="display: none;">
                <h3>Analysis Not Found</h3>
                <p>The requested area analysis could not be located. Please verify the report URL.</p>
            </div>

            <div id="reportContent" style="display: none;">

                <div class="section">
                    <h2>National Charts</h2>
                    <div class="section-content">
                        <div id="fredChartsContent" style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div class="chart-container" style="flex: 1; min-width: 300px; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h3 style="margin: 0; color: #333; font-size: 20px;" id="leftChartTitle">Housing Price Index (Source: FRED)</h3>
                                    
                                    <select id="leftChartSelect" style="padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;">
                                        <option value="DGS2">2-Year Treasury</option>
                                        <option value="DGS10">10-Year Treasury</option>
                                        <option value="MORTGAGE15US">15-Year Mortgage</option>
                                        <option value="MORTGAGE30US">30-Year Mortgage</option>
                                        <option value="ACTLISCOUUS">Active Listings</option>
                                        <option value="CPIAUCSL">CPI</option>
                                        <option value="DJIA">Dow Jones Industrial Average</option>
                                        <option value="LREM64TTUSM156S">Employment</option>
                                        <option value="FEDFUNDS">Fed Funds Rate</option>
                                        <option value="GDP">GDP</option>
                                        <option value="GFDEBTN">Government Debt</option>
                                        <option value="USSTHPI">Housing Price Index</option>
                                        <option value="FPCPITOTLZGUSA">Inflation</option>
                                        <option value="MEDDAYONMARUS">Median Days on Market</option>
                                        <option value="MSPUS">Median Sale Price</option>
                                        <option value="M2REAL">Money Stock</option>
                                        <option value="NEWLISCOUUS">New Listings</option>
                                        <option value="POPTHM">Population</option>
                                        <option value="PPIACO">PPI</option>
                                        <option value="UNRATE">Unemployment Rate</option>
                                        <option value="RHVRUSQ156N">Vacancy Rate</option>
                                    </select>
                                </div>
                                <div style="position: relative; width: 100%; height: 300px; background-color: #f9f9f9; border-radius: 4px;">
                                    <canvas id="leftChart" style="width: 100%; height: 100%;"></canvas>
                                    <div id="leftChart-loading" class="loading-spinner" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                        <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 0 auto;"></div>
                                        <p style="margin-top: 10px; color: #666;">Loading chart data...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="chart-container" style="flex: 1; min-width: 300px; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h3 style="margin: 0; color: #333; font-size: 20px;" id="rightChartTitle">Dow Jones Industrial Average (Source: FRED)</h3>
                                    <select id="rightChartSelect" style="padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px;">
                                        <option value="DGS2">2-Year Treasury</option>
                                        <option value="DGS10">10-Year Treasury</option>
                                        <option value="MORTGAGE15US">15-Year Mortgage</option>
                                        <option value="MORTGAGE30US">30-Year Mortgage</option>
                                        <option value="ACTLISCOUUS">Active Listings</option>
                                        <option value="CPIAUCSL">CPI</option>
                                        <option value="DJIA" selected>Dow Jones Industrial Average</option>
                                        <option value="LREM64TTUSM156S">Employment</option>
                                        <option value="FEDFUNDS">Fed Funds Rate</option>
                                        <option value="GDP">GDP</option>
                                        <option value="GFDEBTN">Government Debt</option>
                                        <option value="USSTHPI">Housing Price Index</option>
                                        <option value="FPCPITOTLZGUSA">Inflation</option>
                                        <option value="MEDDAYONMARUS">Median Days on Market</option>
                                        <option value="MSPUS">Median Sale Price</option>
                                        <option value="M2REAL">Money Stock</option>
                                        <option value="NEWLISCOUUS">New Listings</option>
                                        <option value="POPTHM">Population</option>
                                        <option value="PPIACO">PPI</option>
                                        <option value="UNRATE">Unemployment Rate</option>
                                        <option value="RHVRUSQ156N">Vacancy Rate</option>
                                    </select>
                                </div>
                                <div style="position: relative; width: 100%; height: 300px; background-color: #f9f9f9; border-radius: 4px;">
                                    <canvas id="rightChart" style="width: 100%; height: 100%;"></canvas>
                                    <div id="rightChart-loading" class="loading-spinner" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                        <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 0 auto;"></div>
                                        <p style="margin-top: 10px; color: #666;">Loading chart data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Home Stats</h2>
                    <div class="section-content">
                        <div id="homeStatsContent" style="display: flex; gap: 40px; min-height: 200px;">
                            <!-- Left Side - Property Information -->
                            <div style="flex: 1; padding: 25px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 12px; border: 1px solid #e9ecef; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                                <div style="margin-bottom: 20px;">
                                    <div id="propertyAddress" style="color: #34495e; font-size: 20px; font-weight: 500; margin-bottom: 8px; line-height: 1.4;">
                                        Loading address...
                                    </div>
                                    <div id="propertyDevelopment" style="color: #7f8c8d; font-size: 18px; margin-bottom: 6px;">
                                        Development information
                                    </div>
                                    <div id="propertySubdivision" style="color: #7f8c8d; font-size: 18px; margin-bottom: 20px;">
                                        Subdivision details
                                    </div>
                                </div>
                                
                                <!-- Action Icons -->
                                <div style="display: flex; gap: 15px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                                    <div id="mapButton" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3498db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                            <circle cx="12" cy="10" r="3"></circle>
                                        </svg>
                                        <span style="color: #3498db; font-size: 13px; font-weight: 500;">Map</span>
                                    </div>
                                    <div id="chartButton" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#27ae60" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="18" y1="20" x2="18" y2="10"></line>
                                            <line x1="12" y1="20" x2="12" y2="4"></line>
                                            <line x1="6" y1="20" x2="6" y2="14"></line>
                                        </svg>
                                        <span style="color: #27ae60; font-size: 13px; font-weight: 500;">Chart</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Side - Stats -->
                            <div style="flex: 1; padding: 25px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-radius: 12px; border: 1px solid #e9ecef; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; min-height: 150px;">
                                    <div style="text-align: center;">
                                        <h3 style="margin: 0; color: #2c3e50; font-size: 24px; font-weight: 300; letter-spacing: 2px; text-transform: uppercase;">Stats</h3>
                                        <div style="width: 60px; height: 2px; background: linear-gradient(90deg, #3498db, #27ae60); margin: 15px auto;"></div>
                                        <p style="margin: 10px 0 0 0; color: #7f8c8d; font-size: 14px; font-style: italic;">Market analytics coming soon</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 style="text-align: center;">Neighbourhood Charts</h2>
                    <div class="section-content">
                        <!-- Development Comparison Interface -->
                        <div id="developmentComparisonContainer">
                            <div style="border-top: 1px solid #e9ecef; padding-top: 30px;">
                                <h3 id="dev-comp-title" style="text-align: center; color: #2c3e50; margin-bottom: 20px;">Development Comparison Analysis</h3>
                                
                <!-- Development Comparison Controls -->
                <div class="comparison-controls" id="dev-controls-section">
                    <div class="locations-container">
                        <h4 id="dev-controls-title">Development Comparison Analysis</h4>
                        <div id="development-selections">
                            <!-- Dynamic development selectors will be added here -->
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button id="add-development-btn" class="add-location-btn">Add Development</button>
                        <button id="remove-development-btn" class="remove-location-btn" style="display: none;">Remove Development</button>
                        <button id="compare-developments-btn" class="compare-btn">
                            <span>Generate Analysis</span>
                        </button>
                        <button id="reset-development-comparison-btn" class="reset-btn">Reset to Default</button>
                    </div>
                </div>                                <!-- Development Comparison Chart View -->
                                <div class="chart-section" id="dev-chart-section" style="display: none;">
                                    <div class="chart-controls">
                                        <button id="back-to-dev-controls-btn" class="back-to-controls-btn">‚Üê Change Neighbourhood</button>
                                    </div>
                                    <div id="dev-comparison-chart-header" class="chart-header" style="display: none;">
                                        <h3 id="dev-chart-title">Development Sales Comparison</h3>
                                        <p id="dev-chart-subtitle">Comparative analysis of sales volume and pricing across selected developments</p>
                                    </div>
                                    <div id="development-chart-controls" style="display: none; text-align: center; margin-bottom: 20px;">
                                        <label for="development-chart-type-select" style="margin-right: 10px; font-weight: bold;">Chart Type:</label>
                                        <select id="development-chart-type-select" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; min-width: 150px;">
                                            <option value="sales">Sales Count</option>
                                            <option value="price">Average Price</option>
                                            <option value="price_per_sqft">Price Per Square Foot</option>
                                        </select>
                                    </div>
                                    <div id="dev-comparison-chart-container" style="position: relative; height: 500px; width: 100%;">
                                        <canvas id="dev-comparison-chart" class="fred-chart"></canvas>
                                        <div id="dev-chart-loading" class="chart-loading-message" style="display: none;">
                                            <div class="loading-spinner-small"></div>
                                            <p id="dev-chart-loading-text">Generating development comparison analysis...</p>
                                        </div>
                                        <div id="dev-chart-error" class="chart-error-message" style="display: none;">
                                            <p>Comparison temporarily unavailable. Please verify your selections and try again.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>County Charts</h2>
                    <div class="section-content">
                        <div id="chartsContent">
                            <!-- Premium FRED Comparison Interface -->
                            <div class="fred-comparison-container">
                                <div class="comparison-controls" id="controls-section">
                                    <div class="control-group">
                                        <label for="series-select">Economic Indicator Selection</label>
                                        <select id="series-select" class="fred-select">
                                            <option value="loading">Loading available metrics...</option>
                                        </select>
                                    </div>
                                    
                                    <div class="locations-container">
                                        <h4>Regional Comparison Analysis</h4>
                                        <div id="location-selections">
                                            <!-- Dynamic location selectors will be added here -->
                                        </div>
                                    </div>
                                    
                                    <div class="action-buttons">
                                        <button id="add-location-btn" class="add-location-btn">Add Location</button>
                                        <button id="remove-location-btn" class="remove-location-btn" style="display: none;">Remove Location</button>
                                        <button id="compare-btn" class="compare-btn">
                                            <span>Generate Analysis</span>
                                        </button>
                                        <button id="reset-comparison-btn" class="reset-btn">Reset to Default</button>
                                    </div>
                                </div>
                                
                                <div class="chart-section" id="chart-section" style="display: none;">
                                    <div class="chart-controls">
                                        <button id="back-to-controls-btn" class="back-to-controls-btn">‚Üê Change County</button>
                                        <div class="chart-indicator-control" style="margin-left: 20px; display: inline-flex; align-items: center; gap: 10px;">
                                            <label for="chart-series-select" style="font-weight: bold; color: #333;">Indicator:</label>
                                            <select id="chart-series-select" class="fred-select" style="min-width: 200px;">
                                                <option value="">Select Indicator...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="comparison-chart-header" class="chart-header" style="display: none;">
                                        <h3>Comparative Market Analysis</h3>
                                    </div>
                                    <div id="comparison-chart-container" style="position: relative; height: 500px; width: 100%;">
                                        <canvas id="comparison-chart" class="fred-chart"></canvas>
                                        <div id="chart-loading" class="chart-loading-message" style="display: none;">
                                            <div class="loading-spinner-small"></div>
                                            <p>Generating comprehensive market analysis...</p>
                                        </div>
                                        <div id="chart-error" class="chart-error-message" style="display: none;">
                                            <p>Analysis temporarily unavailable. Please verify your selections and try again.</p>
                                        </div>
                                        <div id="data-availability-notice" class="data-notice" style="display: none;">
                                            <!-- Professional notice for unavailable data will be inserted here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Overlay -->
        <div id="chartOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
            <div style="background: white; border-radius: 12px; padding: 30px; max-width: 900px; width: 90%; max-height: 80%; overflow-y: auto; position: relative;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                    <h2 style="margin: 0; color: #2c3e50;" id="chartOverlayTitle">Development Sales Analysis</h2>
                    <button id="closeChartOverlay" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #95a5a6; padding: 5px;">&times;</button>
                </div>
                
                <div id="chartOverlayContent">
                    <div style="text-align: center; padding: 40px;">
                        <div style="border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto 20px;"></div>
                        <p style="color: #7f8c8d; font-size: 16px;">Loading sales chart data...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Development Actions Popup -->
        <div id="developmentActionsPopup" style="display: none; position: fixed; z-index: 9999; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 12px; min-width: 160px;">
            <div style="font-size: 14px; font-weight: 600; color: #2c3e50; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee;" id="developmentPopupTitle">
                Development Name
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
                <button id="developmentPopupMapBtn" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #ffffff; border: 1px solid #dee2e6; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-size: 13px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#3498db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    <span style="color: #3498db; font-weight: 500;">View Map</span>
                </button>
                <button id="developmentPopupChartBtn" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #ffffff; border: 1px solid #dee2e6; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-size: 13px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#27ae60" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="20" x2="18" y2="10"></line>
                        <line x1="12" y1="20" x2="12" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="14"></line>
                    </svg>
                    <span style="color: #27ae60; font-weight: 500;">View Chart</span>
                </button>
            </div>
        </div>

        <div class="footer">
            <div class="footer-content">
                <p>¬© 2025 Waterfront Properties. All rights reserved.</p>
                <p>This report was compiled by Waterfront Properties and provided exclusively for the intended recipient.</p>
            </div>
        </div>
    </div>

    <script>
        // Get report identifier from URL (could be lastname-id format or just ID)
        const urlParams = new URLSearchParams(window.location.search);
        let urlSlug = urlParams.get('id');
        
        // If no query parameter, extract from path
        if (!urlSlug) {
            const pathParts = window.location.pathname.split('/');
            urlSlug = pathParts[pathParts.length - 1]; // Get last part of path
        }
        
        // If still no slug or it's empty, show error
        if (!urlSlug || urlSlug === 'report.html') {
            console.error('No report identifier found in URL');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }

        async function loadReport() {
            // Don't load if no URL slug
            if (!urlSlug || urlSlug === 'report.html') {
                return;
            }
            
            try {
                console.log('Loading report with slug:', urlSlug);
                const response = await fetch(`${API_BASE}/reports/complete/${urlSlug}`);
                const result = await response.json();

                console.log('API Response:', { status: response.status, result });
                document.getElementById('loading').style.display = 'none';

                if (response.ok && result.success) {
                    displayReport(result.data);
                } else {
                    console.error('API Error:', result.error || 'Unknown error');
                    document.getElementById('error').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading report:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        function displayReport(data) {
            console.log('Displaying report data:', data);
            document.getElementById('reportContent').style.display = 'block';
            
            // Update header information
            document.getElementById('agentName').textContent = data.agent_name || 'Agent Name';
            document.getElementById('buyerName').textContent = `${data.first_name} ${data.last_name}` || 'Buyer Name';
            document.getElementById('zipCode').textContent = data.zip_code || 'ZIP Code';
            
            // Charts - Skip overwriting chartsContent since it now contains FRED interface
            // Chart data is now handled by the FRED comparison interface in Area Charts section
            
            // Interest areas
            if (data.interest_areas && data.interest_areas.length > 0) {
                const areasHtml = data.interest_areas.map(area => `
                    <div class="info-item">
                        <div class="info-label">Interest ${area.interest_id}</div>
                        <div class="info-value">${area.city}, ${area.state}</div>
                    </div>
                `).join('');
                document.getElementById('interestAreasContent').innerHTML = `<div class="info-grid">${areasHtml}</div>`;
            }
            
            // Home Stats - Display property information
            displayHomeStats(data);
            
            // FRED Charts - Load the charts after displaying the report
            loadFredCharts(data.report_id);
        }
        
        function displayHomeStats(data) {
            // Format address with each component on separate lines
            let addressLines = [];
            
            // Address Line 1
            if (data.address_line_1 && data.address_line_1.trim()) {
                addressLines.push(data.address_line_1);
            }
            
            // Address Line 2 (if exists)
            if (data.address_line_2 && data.address_line_2.trim()) {
                addressLines.push(data.address_line_2);
            }
            
            // City, State, Zip
            let cityStateZip = [];
            if (data.home_city) cityStateZip.push(data.home_city);
            if (data.home_state) cityStateZip.push(data.home_state);
            if (data.zip_code) cityStateZip.push(data.zip_code);
            if (cityStateZip.length > 0) {
                addressLines.push(cityStateZip.join(', '));
            }
            
            // Development & Subdivision (avoid duplicate when identical)
            const devName = (data.development && data.development.trim()) ? data.development.trim() : '';
            const subName = (data.subdivision && data.subdivision.trim()) ? data.subdivision.trim() : '';
            if (devName) {
                addressLines.push(devName);
            }
            if (subName && subName.toLowerCase() !== devName.toLowerCase()) {
                addressLines.push(subName);
            }
            
            // Update property details with styled formatting
            const addressElement = document.getElementById('propertyAddress');
            if (addressLines.length > 0) {
                let styledAddress = '';
                addressLines.forEach((line, index) => {
                    // Determine line type based on content pattern rather than position
                    const isCityStateZip = line.includes(',') && /\d{5}/.test(line); // Contains comma and 5-digit zip
                    const isStreetAddress = index === 0 || (index === 1 && !isCityStateZip);
                    
                    if (isStreetAddress) {
                        // Street address lines - larger and bolder
                        styledAddress += `<div style="font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 4px; line-height: 1.3;">${line}</div>`;
                    } else if (isCityStateZip) {
                        // City, State, Zip line - medium weight
                        styledAddress += `<div style="font-size: 20px; font-weight: 500; color: #34495e; margin-bottom: 8px; line-height: 1.3;">${line}</div>`;
                    } else {
                        // Development/Subdivision - lighter styling with subtle separation
                        styledAddress += `<div style="font-size: 18px; font-weight: 400; color: #7f8c8d; margin-bottom: 3px; line-height: 1.4; font-style: italic;">${line}</div>`;
                    }
                });
                addressElement.innerHTML = styledAddress;
            } else {
                addressElement.innerHTML = `<div style="font-size: 16px; color: #95a5a6; font-style: italic;">Address information not available</div>`;
            }
            
            // Hide the development and subdivision elements since they're now in the address
            document.getElementById('propertyDevelopment').style.display = 'none';
            document.getElementById('propertySubdivision').style.display = 'none';
            
            // Enrich Home Stats via property lookup (address ‚Üí parcel ‚Üí tax fields)
            (async () => {
                try {
                    const params = new URLSearchParams();
                    if (data.address_line_1) params.set('address', data.address_line_1);
                    if (data.home_city) params.set('city', data.home_city);
                    if (data.zip_code) params.set('zip', data.zip_code);
                    if (data.development) params.set('development', data.development);
                    if (data.subdivision) params.set('subdivision', data.subdivision);
                    const resp = await fetch(`${API_BASE}/property-lookup?${params.toString()}`);
                    if (resp.ok) {
                        const result = await resp.json();
                        if (result && result.success && Array.isArray(result.data) && result.data.length > 0) {
                            const best = result.data[0];
                            const container = document.getElementById('homeStatsContent');
                            if (container) {
                                const infoBlock = document.createElement('div');
                                infoBlock.style.marginTop = '12px';

                                // Helpers to format numeric values from tax table safely
                                const formatInt = (value) => {
                                    if (value === null || value === undefined) return 'N/A';
                                    const trimmed = String(value).trim();
                                    if (trimmed.length === 0) return 'N/A';
                                    const parsed = parseInt(trimmed, 10);
                                    return Number.isNaN(parsed) ? 'N/A' : String(parsed);
                                };

                                const formatQuantity = (value) => {
                                    if (value === null || value === undefined) return 'N/A';
                                    const trimmed = String(value).trim();
                                    if (trimmed.length === 0) return 'N/A';
                                    const parsed = parseInt(trimmed, 10);
                                    return Number.isNaN(parsed) ? 'N/A' : parsed.toLocaleString('en-US');
                                };

                                const formatCurrency0 = (value) => {
                                    if (value === null || value === undefined) return 'N/A';
                                    const num = Number(String(value).replace(/[^0-9.-]/g, ''));
                                    return Number.isFinite(num)
                                        ? new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num)
                                        : 'N/A';
                                };

                                const yearBuilt = formatInt(best.year_built);
                                const livingSqFt = formatQuantity(best.square_foot_living_area);
                                const bedrooms = formatInt(best.number_of_bedrooms);
                                const fullBaths = formatInt(best.number_of_full_bathrooms);
                                const halfBaths = formatInt(best.number_of_half_bathrooms);
                                const halfBathsHtml = (halfBaths !== 'N/A' && parseInt(halfBaths, 10) > 0)
                                    ? `<div><span style=\"color:#7f8c8d\">üöø Half Bath:</span> <strong>${halfBaths}</strong></div>`
                                    : '';
                                const marketValue = formatCurrency0(best.total_market_value);

                                // Build address content to merge into one unified card
                                const addressHtml = addressLines.length > 0
                                    ? addressLines.map((line, idx) => {
                                        const isCityStateZip = line.includes(',') && /\d{5}/.test(line);
                                        const isPrimary = idx === 0 || (idx === 1 && !isCityStateZip);
                                        const style = isPrimary
                                            ? 'font-size:18px;font-weight:600;color:#2c3e50;margin-bottom:4px;line-height:1.3;'
                                            : (isCityStateZip
                                                ? 'font-size:20px;font-weight:500;color:#34495e;margin-bottom:6px;line-height:1.3;'
                                                : 'font-size:16px;font-weight:400;color:#7f8c8d;margin-bottom:3px;line-height:1.4;font-style:italic;');
                                        return `<div style="${style}">${line}</div>`;
                                    }).join('')
                                    : '<div style="font-size:16px;color:#95a5a6;font-style:italic;">Address information not available</div>';

                                infoBlock.innerHTML = `
                                    <div style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid #e9ecef; border-radius: 10px; padding: 16px;">
                                        <div style="display:flex; align-items:flex-start; gap:10px; margin-bottom:12px;">
                                            <div style="font-size:20px; line-height:1;">üìç</div>
                                            <div style="flex:1;">${addressHtml}</div>
                                        </div>
                                        <div style="height:1px; background:#e9ecef; margin:10px 0 14px 0;"></div>
                                        <div style="display: grid; grid-template-columns: repeat(2, minmax(160px, 1fr)); gap: 12px; align-items: center;">
                                            <div><span style=\"color:#7f8c8d\">üõèÔ∏è Bedrooms:</span> <strong>${bedrooms}</strong></div>
                                            <div><span style=\"color:#7f8c8d\">üìê Living SqFt:</span> <strong>${livingSqFt}</strong></div>
                                            <div><span style=\"color:#7f8c8d\">üõÅ Bath:</span> <strong>${fullBaths}</strong></div>
                                            <div><span style=\"color:#7f8c8d\">üèóÔ∏è Year Built:</span> <strong>${yearBuilt}</strong></div>
                                            ${halfBathsHtml}
                                            <div><span style=\"color:#7f8c8d\">üí≤ Tax Value:</span> <strong>${marketValue}</strong></div>
                                        </div>
                                    </div>
                                `;

                                const leftPanel = container.firstElementChild;
                                if (leftPanel) {
                                    const buttonsRow = leftPanel.querySelector('#mapButton') ? leftPanel.querySelector('#mapButton').parentElement : null;
                                    if (buttonsRow) {
                                        leftPanel.insertBefore(infoBlock, buttonsRow);
                                    } else {
                                        leftPanel.appendChild(infoBlock);
                                    }
                                    // Hide the original separate address block to avoid duplication
                                    const addressBlock = leftPanel.querySelector('#propertyAddress');
                                    if (addressBlock) addressBlock.style.display = 'none';
                                }
                            }
                        }
                    }
                } catch (lookupErr) {
                    console.warn('Property lookup failed:', lookupErr);
                }
            })();
            
            // Load development stats if development name is available
            if (data.development && data.development.trim()) {
                loadDevelopmentStats(data.development.trim());
            }
            
            // Setup chart button click handler
            setupChartButton(data.development && data.development.trim() ? data.development.trim() : null);
        }
        
        // Function to setup chart button click handler
        function setupChartButton(developmentName) {
            const chartButton = document.getElementById('chartButton');
            if (chartButton && developmentName) {
                chartButton.addEventListener('click', () => {
                    showChartOverlay(developmentName);
                });
                
                // Add hover effect
                chartButton.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8f9fa';
                    this.style.borderColor = '#27ae60';
                    this.style.transform = 'translateY(-1px)';
                });
                
                chartButton.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '#ffffff';
                    this.style.borderColor = '#dee2e6';
                    this.style.transform = 'translateY(0)';
                });
            } else if (chartButton) {
                // Disable chart button if no development
                chartButton.style.opacity = '0.5';
                chartButton.style.cursor = 'not-allowed';
                chartButton.title = 'Chart data not available for this property';
            }
        }
        
        // Function to show chart overlay
        async function showChartOverlay(developmentName) {
            const overlay = document.getElementById('chartOverlay');
            const title = document.getElementById('chartOverlayTitle');
            const content = document.getElementById('chartOverlayContent');
            
            // Show overlay
            overlay.style.display = 'flex';
            title.textContent = `${developmentName} - Sales Analysis`;
            
            // Show loading state
            content.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto 20px;"></div>
                    <p style="color: #7f8c8d; font-size: 16px;">Loading sales chart data...</p>
                </div>
            `;
            
            try {
                // Fetch chart data
                const response = await fetch(`${API_BASE}/development-chart/${encodeURIComponent(developmentName)}`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    displayChartData(result.data);
                } else {
                    throw new Error(result.error || 'Failed to load chart data');
                }
            } catch (error) {
                console.error('Error loading chart data:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="color: #e74c3c; font-size: 48px; margin-bottom: 20px;">üìä</div>
                        <h3 style="color: #2c3e50; margin-bottom: 10px;">Chart Data Unavailable</h3>
                        <p style="color: #7f8c8d;">Unable to load sales data for this development.</p>
                    </div>
                `;
            }
        }
        
        // Function to display chart data
        function displayChartData(data) {
            const content = document.getElementById('chartOverlayContent');
            const chartData = data.chartData;
            
            if (!chartData || chartData.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div style="color: #f39c12; font-size: 48px; margin-bottom: 20px;">üìà</div>
                        <h3 style="color: #2c3e50; margin-bottom: 10px;">No Sales Data</h3>
                        <p style="color: #7f8c8d;">No recorded sales found for ${data.developmentName} in the last 10 years.</p>
                    </div>
                `;
                return;
            }
            
            // Create chart HTML
            let chartHtml = `
                <div style="margin-bottom: 30px;">
                    <h3 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">Annual Sales Summary - Last 10 Years</h3>
                    <div style="display: flex; gap: 30px;">
                        <!-- Sales Count Chart -->
                        <div style="flex: 1;">
                            <h4 style="text-align: center; color: #34495e; margin-bottom: 15px;">Number of Sales per Year</h4>
                            <div style="height: 300px; position: relative;">
                                <canvas id="salesCountChart" style="width: 100%; height: 100%;"></canvas>
                            </div>
                        </div>
                        
                        <!-- Average Price Chart -->
                        <div style="flex: 1;">
                            <h4 style="text-align: center; color: #34495e; margin-bottom: 15px;">Average Sale Price per Year</h4>
                            <div style="height: 300px; position: relative;">
                                <canvas id="avgPriceChart" style="width: 100%; height: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Data Table -->
                <div style="margin-top: 20px;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Detailed Sales Data</h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; border: 1px solid #ddd;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 12px; text-align: left; border: 1px solid #ddd; color: #2c3e50;">Year</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd; color: #2c3e50;">Sales Count</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd; color: #2c3e50;">Average Price</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd; color: #2c3e50;">Median Price</th>
                                    <th style="padding: 12px; text-align: right; border: 1px solid #ddd; color: #2c3e50;">Price Range</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Sort chartData by year in descending order (newest first)
            const sortedChartData = [...chartData].sort((a, b) => parseInt(b.sale_year) - parseInt(a.sale_year));
            
            sortedChartData.forEach(row => {
                const avgPrice = row.avg_price ? `$${parseInt(row.avg_price).toLocaleString()}` : 'N/A';
                const medianPrice = row.median_price ? `$${parseInt(row.median_price).toLocaleString()}` : 'N/A';
                const minPrice = row.min_price ? `$${parseInt(row.min_price).toLocaleString()}` : 'N/A';
                const maxPrice = row.max_price ? `$${parseInt(row.max_price).toLocaleString()}` : 'N/A';
                const priceRange = (row.min_price && row.max_price) ? `${minPrice} - ${maxPrice}` : 'N/A';
                
                chartHtml += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd; font-weight: 500;">${row.sale_year}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${row.sales_count}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${avgPrice}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${medianPrice}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 12px;">${priceRange}</td>
                    </tr>
                `;
            });
            
            chartHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            content.innerHTML = chartHtml;
            
            // Render Chart.js charts
            setTimeout(() => {
                renderPopupChart('salesCountChart', chartData, 'sales_count', '#3498db', 'Number of Sales');
                renderPopupChart('avgPriceChart', chartData, 'avg_price', '#27ae60', 'Average Sale Price');
            }, 100);
        }
        
        // Function to render simple bar chart
        function renderBarChart(data, valueField, color, prefix = '') {
            if (!data || data.length === 0) return '<p>No data available</p>';
            
            const maxValue = Math.max(...data.map(d => parseFloat(d[valueField]) || 0));
            const minValue = Math.min(...data.map(d => parseFloat(d[valueField]) || 0));
            
            let chartHtml = `
                <div style="display: flex; align-items: end; height: 100%; gap: 8px; padding: 20px 10px 30px;">
            `;
            
            data.forEach(item => {
                const value = parseFloat(item[valueField]) || 0;
                const height = maxValue > 0 ? (value / maxValue) * 200 : 0;
                const displayValue = valueField === 'avg_price' ? 
                    `${prefix}${Math.round(value).toLocaleString()}` : 
                    `${value}${prefix}`;
                
                chartHtml += `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                        <div style="position: relative; margin-bottom: 8px;">
                            <div style="
                                width: 100%; 
                                height: ${height}px; 
                                background: ${color}; 
                                border-radius: 4px 4px 0 0;
                                min-height: 2px;
                                position: relative;
                                display: flex;
                                align-items: end;
                                justify-content: center;
                                padding-bottom: 5px;
                            ">
                                <span style="
                                    color: white; 
                                    font-size: 10px; 
                                    font-weight: bold;
                                    text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
                                    writing-mode: vertical-rl;
                                    text-orientation: mixed;
                                ">${displayValue}</span>
                            </div>
                        </div>
                        <div style="font-size: 12px; font-weight: 500; color: #2c3e50;">${item.sale_year}</div>
                    </div>
                `;
            });
            
            chartHtml += `</div>`;
            return chartHtml;
        }
        
        // Function to render popup charts using Chart.js
        function renderPopupChart(canvasId, data, valueField, color, label) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error(`Canvas ${canvasId} not found`);
                return;
            }
            
            // Destroy existing chart instance
            if (canvasId === 'salesCountChart' && salesCountChartInstance) {
                salesCountChartInstance.destroy();
            } else if (canvasId === 'avgPriceChart' && avgPriceChartInstance) {
                avgPriceChartInstance.destroy();
            }
            
            // Prepare data for Chart.js
            const chartData = data.map(item => ({
                x: item.sale_year.toString(),
                y: parseFloat(item[valueField]) || 0
            }));
            
            const ctx = canvas.getContext('2d');
            
            // Determine if this is a price chart for formatting
            const isPrice = valueField === 'avg_price';
            
            // Create Chart.js configuration
            const config = {
                type: 'line',
                data: {
                    datasets: [{
                        label: label,
                        data: chartData,
                        backgroundColor: color + '20', // 20% opacity for fill
                        borderColor: color,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: color,
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointHoverBackgroundColor: color,
                        pointHoverBorderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(tooltipItems) {
                                    return `Year ${tooltipItems[0].label}`;
                                },
                                label: function(context) {
                                    const value = context.parsed.y;
                                    if (isPrice) {
                                        return `${label}: $${Math.round(value).toLocaleString()}`;
                                    } else {
                                        return `${label}: ${value}`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            title: {
                                display: true,
                                text: 'Year',
                                color: '#2c3e50',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#2c3e50',
                                font: {
                                    weight: '500'
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: label,
                                color: '#2c3e50',
                                font: {
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: '#f0f0f0'
                            },
                            ticks: {
                                color: '#666',
                                callback: function(value) {
                                    if (isPrice) {
                                        return '$' + Math.round(value).toLocaleString();
                                    } else {
                                        return value;
                                    }
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeOutQuart'
                    }
                }
            };
            
            // Create the chart and store the instance
            const newChart = new Chart(ctx, config);
            
            if (canvasId === 'salesCountChart') {
                salesCountChartInstance = newChart;
            } else if (canvasId === 'avgPriceChart') {
                avgPriceChartInstance = newChart;
            }
        }
        
        // Function to close chart overlay and clean up chart instances
        function closeChartOverlay() {
            const overlay = document.getElementById('chartOverlay');
            overlay.style.display = 'none';
            
            // Destroy chart instances to free memory
            if (salesCountChartInstance) {
                salesCountChartInstance.destroy();
                salesCountChartInstance = null;
            }
            if (avgPriceChartInstance) {
                avgPriceChartInstance.destroy();
                avgPriceChartInstance = null;
            }
        }
        
        // Setup chart overlay close handlers
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('chartOverlay');
            const closeButton = document.getElementById('closeChartOverlay');
            
            // Close overlay when clicking close button
            closeButton.addEventListener('click', () => {
                closeChartOverlay();
            });
            
            // Close overlay when clicking outside the content
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeChartOverlay();
                }
            });
            
            // Close overlay with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && overlay.style.display === 'flex') {
                    closeChartOverlay();
                }
            });
            
            // Initialize development actions popup
            initializeDevelopmentActionsPopup();
        });
        
        // Initialize development actions popup functionality
        function initializeDevelopmentActionsPopup() {
            const popup = document.getElementById('developmentActionsPopup');
            
            // Close popup when clicking outside
            document.addEventListener('click', function(e) {
                if (__suppressNextDocumentClick) {
                    // Skip one document click that originated from legend click
                    __suppressNextDocumentClick = false;
                    return;
                }
                if (popup && popup.style.display !== 'none' && !popup.contains(e.target)) {
                    // Check if the click was on the chart legend (which should open the popup)
                    const isLegendClick = e.target.closest('.chartjs-legend') || 
                                         e.target.closest('canvas') || 
                                         e.target.tagName === 'CANVAS';
                    
                    if (!isLegendClick) {
                        hideDevelopmentActionsPopup();
                    }
                }
            });
            
            // Close popup with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && popup && popup.style.display !== 'none') {
                    hideDevelopmentActionsPopup();
                }
            });
        }
        
        // Function to load development statistics
        async function loadDevelopmentStats(developmentName) {
            try {
                console.log('Loading stats for development:', developmentName);
                
                // Show loading state in stats section
                const statsSection = document.querySelector('#homeStatsContent > div:last-child');
                if (statsSection) {
                    statsSection.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; min-height: 150px;">
                            <div style="text-align: center;">
                                <div style="border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 0 auto 15px;"></div>
                                <p style="margin: 0; color: #7f8c8d; font-size: 14px;">Loading ${developmentName} statistics...</p>
                            </div>
                        </div>
                    `;
                }
                
                const response = await fetch(`${API_BASE}/development-stats/${encodeURIComponent(developmentName)}`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    displayDevelopmentStats(result.data);
                } else {
                    console.error('Error loading development stats:', result.error);
                    displayStatsError('Unable to load development statistics');
                }
            } catch (error) {
                console.error('Error fetching development stats:', error);
                displayStatsError('Error loading statistics');
            }
        }
        
        // Function to display development statistics
        function displayDevelopmentStats(stats) {
            const statsSection = document.querySelector('#homeStatsContent > div:last-child');
            if (!statsSection) return;
            
            // Format large numbers for display
            const formatPrice = (price) => {
                if (!price || price === 0) return 'N/A';
                if (price >= 1000000) {
                    return `$${(price / 1000000).toFixed(1)}M`;
                } else if (price >= 1000) {
                    return `$${(price / 1000).toFixed(0)}K`;
                } else {
                    return `$${price.toLocaleString()}`;
                }
            };
            
            statsSection.innerHTML = `
                <div style="padding: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #2c3e50; font-size: 22px; font-weight: 600; margin-bottom: 5px;">${stats.developmentName}</h3>
                        <div style="width: 60px; height: 2px; background: linear-gradient(90deg, #3498db, #27ae60); margin: 8px auto;"></div>
                        <p style="margin: 0; color: #7f8c8d; font-size: 16px; text-transform: uppercase; letter-spacing: 1px;">Development Statistics</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 18px;">
                        <!-- Left Column -->
                        <div>
                            <div style="margin-bottom: 8px;">
                                <strong>Tax:</strong> <span style="color: #2c3e50;">${stats.totalProperties}</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Active:</strong> <span style="color: #e74c3c;">${stats.activeListings}</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Active Under Contract:</strong> <span style="color: #f39c12;">${stats.underContract}</span>
                            </div>
                            ${stats.pending > 0 ? `<div style="margin-bottom: 8px;"><strong>Pending:</strong> <span style="color: #8e44ad;">${stats.pending}</span></div>` : ''}
                            <div style="margin-bottom: 8px;">
                                <strong>Closed (&lt; 3 Mos.):</strong> <span style="color: #27ae60;">${stats.closedLast3Months}</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Closed (&lt; 12 Mos.):</strong> <span style="color: #27ae60;">${stats.closedLast12Months}</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Active %:</strong> <span style="color: #2c3e50;">${stats.activePercentage}%</span>
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div>
                            <div style="margin-bottom: 12px;">
                                <strong>MLS Median Sale Price (YTD):</strong>
                            </div>
                            ${Object.keys(stats.medianPrices).length > 0 ? 
                                Object.entries(stats.medianPrices)
                                    .sort(([a], [b]) => parseInt(a) - parseInt(b))
                                    .map(([year, price]) => {
                                        const count = stats.saleCounts[year] || 0;
                                        return `<div style="margin-bottom: 6px; margin-left: 10px;">
                                            <strong>${year}:</strong> <span style="color: ${year === '2025' ? '#3498db' : '#2c3e50'};">${formatPrice(price)} (${count})</span>
                                        </div>`;
                                    }).join('') 
                                : '<div style="margin-left: 10px; color: #95a5a6; font-style: italic;">No recent sales data</div>'
                            }
                            
                            <div style="margin-top: 15px;">
                                <div style="margin-bottom: 6px;">
                                    <strong>Months of Inventory (3mo):</strong> <span style="color: #8e44ad;">${stats.inventoryMonths.threeMonth}</span>
                                </div>
                                <div style="margin-bottom: 6px;">
                                    <strong>Months of Inventory (12mo):</strong> <span style="color: #8e44ad;">${stats.inventoryMonths.twelveMonth}</span>
                                </div>
                            </div>
                            
                            ${stats.avgDaysOnMarket > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong>Avg DOM (Active):</strong> <span style="color: #34495e;">${stats.avgDaysOnMarket} days</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Function to display stats error
        function displayStatsError(message) {
            const statsSection = document.querySelector('#homeStatsContent > div:last-child');
            if (statsSection) {
                statsSection.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; min-height: 150px;">
                        <div style="text-align: center;">
                            <div style="color: #e74c3c; font-size: 32px; margin-bottom: 15px;">üìä</div>
                            <h3 style="margin: 0; color: #2c3e50; font-size: 18px; font-weight: 300; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px;">Stats</h3>
                            <div style="width: 60px; height: 2px; background: linear-gradient(90deg, #3498db, #27ae60); margin: 8px auto 15px;"></div>
                            <p style="margin: 0; color: #e74c3c; font-size: 13px;">${message}</p>
                        </div>
                    </div>
                `;
            }
        }

        // FRED series configuration
        const FRED_SERIES = {
            'GDP': 'GDP',
            'CPIAUCSL': 'CPI',
            'PPIACO': 'PPI',
            'FEDFUNDS': 'Fed Funds Rate',
            'MORTGAGE30US': '30-Year Mortgage',
            'MORTGAGE15US': '15-Year Mortgage',
            'RHVRUSQ156N': 'Vacancy Rate',
            'LREM64TTUSM156S': 'Employment',
            'POPTHM': 'Population',
            'M2REAL': 'Money Stock',
            'FPCPITOTLZGUSA': 'Inflation',
            'GFDEBTN': 'Government Debt',
            'DGS10': '10-Year Treasury',
            'DGS2': '2-Year Treasury',
            'ACTLISCOUUS': 'Active Listings',
            'MSPUS': 'Median Sale Price',
            'NEWLISCOUUS': 'New Listings',
            'MEDDAYONMARUS': 'Median Days on Market',
            'USSTHPI': 'Housing Price Index',
            'UNRATE': 'Unemployment Rate',
            'DJIA': 'Dow Jones Industrial Average'
        };

        // Function to fetch and display FRED charts
        async function loadFredCharts(reportId) {
            let leftSeriesId = 'USSTHPI';  // Default
            let rightSeriesId = 'DJIA';    // Default
            
            try {
                // Load saved FRED charts from database
                const response = await fetch(`${API_BASE}/reports/${reportId}/fred-charts`);
                const result = await response.json();
                
                if (response.ok && result.success && result.data.length > 0) {
                    // Find left and right charts by chart_id (smaller = left, larger = right)
                    const sortedCharts = result.data.sort((a, b) => a.chart_id - b.chart_id);
                    const leftChart = sortedCharts[0];
                    const rightChart = sortedCharts[1];
                    
                    if (leftChart) leftSeriesId = leftChart.series_id;
                    if (rightChart) rightSeriesId = rightChart.series_id;
                }
            } catch (error) {
                console.error('Error loading FRED charts from database:', error);
                // Continue with defaults
            }
            
            // Set dropdown values and titles
            document.getElementById('leftChartSelect').value = leftSeriesId;
            document.getElementById('rightChartSelect').value = rightSeriesId;
            document.getElementById('leftChartTitle').textContent = (FRED_SERIES[leftSeriesId] || leftSeriesId) + ' (Source: Federal Reserve)';
            document.getElementById('rightChartTitle').textContent = (FRED_SERIES[rightSeriesId] || rightSeriesId) + ' (Source: Federal Reserve)';
            
            // Setup dropdown event listeners with save functionality
            document.getElementById('leftChartSelect').addEventListener('change', async function() {
                const seriesId = this.value;
                const title = FRED_SERIES[seriesId] || seriesId;
                document.getElementById('leftChartTitle').textContent = title + ' (Source: FRED)';
                loadChartData('leftChart', seriesId, '#2E8B57');
                
                // Save to database
                await saveFredCharts(reportId);
            });
            
            document.getElementById('rightChartSelect').addEventListener('change', async function() {
                const seriesId = this.value;
                const title = FRED_SERIES[seriesId] || seriesId;
                document.getElementById('rightChartTitle').textContent = title + ' (Source: FRED)';
                loadChartData('rightChart', seriesId, '#1E90FF');
                
                // Save to database
                await saveFredCharts(reportId);
            });

            // Load initial charts
            loadChartData('leftChart', leftSeriesId, '#2E8B57');
            loadChartData('rightChart', rightSeriesId, '#1E90FF');
        }
        
        // Function to save FRED charts to database
        async function saveFredCharts(reportId) {
            try {
                const leftSeriesId = document.getElementById('leftChartSelect').value;
                const rightSeriesId = document.getElementById('rightChartSelect').value;
                
                const response = await fetch(`${API_BASE}/reports/${reportId}/fred-charts`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        leftSeriesId: leftSeriesId,
                        rightSeriesId: rightSeriesId
                    })
                });
                
                const result = await response.json();
                if (!response.ok || !result.success) {
                    console.error('Error saving FRED charts:', result.error);
                }
            } catch (error) {
                console.error('Error saving FRED charts:', error);
            }
        }

        // Function to load chart data
        function loadChartData(containerId, seriesId, color) {
            const currentDate = new Date();
            const fiveYearsAgo = new Date(currentDate.getFullYear() - 5, currentDate.getMonth(), currentDate.getDate());
            
            const startDate = fiveYearsAgo.toISOString().split('T')[0];
            const endDate = currentDate.toISOString().split('T')[0];
            
            const title = FRED_SERIES[seriesId] || seriesId;
            loadFredChart(seriesId, containerId, startDate, endDate, title, color);
        }

        // Function to load individual FRED chart
        async function loadFredChart(seriesId, containerId, startDate, endDate, title, color) {
            try {
                const response = await fetch(`${API_BASE}/fred-data?seriesId=${seriesId}&startDate=${startDate}&endDate=${endDate}`);
                const data = await response.json();
                
                if (data.observations && data.observations.length > 0) {
                    renderChart(containerId, data.observations, title, color);
                } else {
                    // Show no data message
                    const canvas = document.getElementById(containerId);
                    const loadingDiv = document.getElementById(containerId + '-loading');
                    if (loadingDiv) {
                        loadingDiv.style.display = 'none';
                    }
                    if (canvas) {
                        const parent = canvas.parentElement;
                        parent.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; text-align: center; color: #666;">
                                <p>No data available for ${title}</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error(`Error loading ${seriesId} data:`, error);
                const canvas = document.getElementById(containerId);
                const loadingDiv = document.getElementById(containerId + '-loading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
                if (canvas) {
                    const parent = canvas.parentElement;
                    parent.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; text-align: center; color: #e74c3c;">
                            <p>Error loading ${title} data</p>
                        </div>
                    `;
                }
            }
        }

        // Function to render a simple line chart using Chart.js
        function renderChart(containerId, observations, title, color) {
            const canvas = document.getElementById(containerId);
            const loadingDiv = document.getElementById(containerId + '-loading');
            
            if (!canvas) {
                console.error(`Canvas element ${containerId} not found`);
                return;
            }
            
            // Hide loading spinner
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }
            
            const validData = observations.filter(obs => obs.value !== '.' && !isNaN(parseFloat(obs.value)));
            
            if (validData.length === 0) {
                // Show error message
                const parent = canvas.parentElement;
                parent.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; text-align: center; color: #666;">
                        <p>No valid data available for ${title}</p>
                    </div>
                `;
                return;
            }

            // Get chart instance based on container ID
            let chartInstance;
            if (containerId === 'leftChart') {
                chartInstance = leftChartInstance;
            } else if (containerId === 'rightChart') {
                chartInstance = rightChartInstance;
            }

            // Destroy existing chart if it exists
            if (chartInstance) {
                chartInstance.destroy();
            }

            // Prepare data for Chart.js
            const chartData = validData.map(obs => ({
                x: obs.date,
                y: parseFloat(obs.value)
            }));

            const ctx = canvas.getContext('2d');
            
            // Create Chart.js configuration
            const config = {
                type: 'line',
                data: {
                    datasets: [{
                        label: title,
                        data: chartData,
                        backgroundColor: color + '20', // 20% opacity for fill
                        borderColor: color,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: color,
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: color,
                        pointHoverBorderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    const date = new Date(tooltipItems[0].parsed.x);
                                    return date.toLocaleDateString();
                                },
                                label: function(context) {
                                    return `${title}: ${context.parsed.y.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                displayFormats: {
                                    month: 'MMM yyyy'
                                }
                            },
                            grid: {
                                display: true,
                                color: '#f0f0f0'
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            grid: {
                                display: true,
                                color: '#f0f0f0'
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false
                    },
                    elements: {
                        line: {
                            tension: 0.4
                        }
                    }
                }
            };

            // Create the chart and store the instance
            const newChart = new Chart(ctx, config);
            
            if (containerId === 'leftChart') {
                leftChartInstance = newChart;
            } else if (containerId === 'rightChart') {
                rightChartInstance = newChart;
            }
        }

        // FRED Comparison Functionality for Area Charts
        let seriesOptionsCache = null;
        let selectionCount = 1;
        const maxSelections = 5;
        
        // Chart.js instances for FRED charts
        let leftChartInstance = null;
        let rightChartInstance = null;
        let comparisonChartInstance = null;
        
        // Chart.js instances for popup charts
        let salesCountChartInstance = null;
        let avgPriceChartInstance = null;
        
        // Available states for county selection (alphabetically sorted)
        const availableStates = [
            'Alabama', 'Arizona', 'California', 'Colorado', 'Connecticut', 'Florida',
            'Georgia', 'Illinois', 'Indiana', 'Kentucky', 'Louisiana', 'Maryland',
            'Massachusetts', 'Michigan', 'Minnesota', 'Missouri', 'New Jersey', 'New York',
            'North Carolina', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania', 'South Carolina',
            'Tennessee', 'Texas', 'Utah', 'Virginia', 'Washington', 'Wisconsin'
        ];
        
        // Initialize FRED comparison functionality
        async function initializeFredComparison() {
            try {
                // Load series options
                await loadSeriesOptions();
                
                // Load saved comparison data for this report
                await loadSavedComparison();
                
                // Setup event listeners
                setupEventListeners();
                
            } catch (error) {
                console.error('Error initializing FRED comparison:', error);
                document.getElementById('chartsContent').innerHTML = `
                    <div class="info-item">
                        <div class="info-label">Area Charts</div>
                        <div class="info-value">Unable to load comparison tools. Please try refreshing the page.</div>
                    </div>
                `;
            }
        }
        
        // Load available FRED series from database
        async function loadSeriesOptions() {
            try {
                const response = await fetch('/api/fred-series?level=COUNTY');
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error('Failed to fetch series options');
                }
                
                const seriesSelect = document.getElementById('series-select');
                if (!seriesSelect) {
                    console.error('series-select element not found');
                    throw new Error('series-select element not found in DOM');
                }
                seriesSelect.innerHTML = '';
                
                // Convert to the expected format
                const options = {};
                result.data.forEach(item => {
                    options[item.key_name] = {
                        series: item.series_pattern,
                        lead_zero: item.lead_zero,
                        display_name: item.display_name,
                        sort_order: item.sort_order || 999,
                        description: item.description || ''
                    };
                    
                    // Add option to select element
                    const option = document.createElement('option');
                    option.value = item.key_name;
                    option.textContent = item.display_name;
                    seriesSelect.appendChild(option);
                });
                
                seriesOptionsCache = options;
                
                // Set default selection to Active County Inventory or first available
                const defaultSeries = 'ACTIVE_COUNTY_INVENTORY';
                if (options[defaultSeries]) {
                    seriesSelect.value = defaultSeries;
                } else if (result.data.length > 0) {
                    seriesSelect.value = result.data[0].key_name;
                }
                
            } catch (error) {
                console.error('Error loading series options:', error);
                // Fallback options
                const seriesSelect = document.getElementById('series-select');
                if (seriesSelect) {
                    seriesSelect.innerHTML = `
                        <option value="ACTLISCOU{COUNTY}">Active County Inventory</option>
                        <option value="ATNHPIUS{COUNTY}A">All Transactions HPI</option>
                        <option value="GDPALL{COUNTY}">County GDP</option>
                    `;
                }
            }
        }
        
        // Load saved comparison data for this report
        async function loadSavedComparison() {
            try {
                console.log('Loading saved comparison for report:', urlSlug);
                const response = await fetch(`${API_BASE}/reports/${urlSlug}/area-comparison`);
                const result = await response.json();
                
                if (response.ok && result.success && result.data) {
                    const savedData = result.data;
                    console.log('Found saved comparison:', savedData);
                    
                    // Set the series selection
                    if (savedData.series_id) {
                        document.getElementById('series-select').value = savedData.series_id;
                    }
                    
                    // Load the county locations and populate dropdowns
                    if (savedData.locations && savedData.locations.length > 0) {
                        await loadSavedLocations(savedData.locations);
                        // Auto-generate the chart with the loaded data
                        await generateComparison();
                    } else {
                        // No saved data, initialize with default Palm Beach County
                        resetToDefault();
                    }
                } else {
                    console.log('No saved comparison found, using defaults');
                    // No saved data, initialize with default Palm Beach County
                    resetToDefault();
                }
            } catch (error) {
                console.error('Error loading saved comparison:', error);
                // Fallback to default
                resetToDefault();
            }
        }
        
        // Load saved locations and populate the dropdowns
        async function loadSavedLocations(countyIds) {
            try {
                // Set the selection count based on saved locations
                selectionCount = countyIds.length;
                
                // Update the location selections UI
                await updateLocationSelections();
                
                // For each saved county ID, we need to find the state and set the dropdowns
                for (let i = 0; i < countyIds.length; i++) {
                    const countyId = countyIds[i];
                    const selectionIndex = i + 1;
                    
                    // Get state and county info for this county ID
                    await loadCountyById(countyId, selectionIndex);
                }
                
                updateButtons();
                
            } catch (error) {
                console.error('Error loading saved locations:', error);
                await resetToDefault();
            }
        }
        
        // Load county info by ID and set the appropriate dropdowns
        async function loadCountyById(countyId, selectionIndex) {
            try {
                // We need to find which state this county belongs to
                // We'll try each state until we find the county
                for (const state of availableStates) {
                    const response = await fetch(`${API_BASE}/counties?state=${encodeURIComponent(state)}`);
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        const county = result.data.find(c => c.id === countyId);
                        if (county) {
                            // Found the county in this state
                            const stateSelect = document.getElementById(`state-select-${selectionIndex}`);
                            const countySelect = document.getElementById(`county-select-${selectionIndex}`);
                            
                            if (stateSelect && countySelect) {
                                // Set the state
                                stateSelect.value = state;
                                
                                // Populate and set the county
                                countySelect.innerHTML = '<option value="">Select County</option>';
                                const sortedCounties = result.data.sort((a, b) => a.name.localeCompare(b.name));
                                sortedCounties.forEach(countyOption => {
                                    const option = document.createElement('option');
                                    option.value = countyOption.id;
                                    option.textContent = countyOption.name;
                                    if (countyOption.id === countyId) {
                                        option.selected = true;
                                    }
                                    countySelect.appendChild(option);
                                });
                            }
                            
                            return; // Found and set, exit the function
                        }
                    }
                }
                
                console.warn(`County ID ${countyId} not found in any state`);
            } catch (error) {
                console.error(`Error loading county by ID ${countyId}:`, error);
            }
        }
        
        // Setup event listeners for the comparison controls
        function setupEventListeners() {
            document.getElementById('add-location-btn').addEventListener('click', async () => {
                await addLocationSelection();
            });
            document.getElementById('remove-location-btn').addEventListener('click', async () => {
                await removeLocationSelection();
            });
            document.getElementById('compare-btn').addEventListener('click', generateComparison);
            document.getElementById('reset-comparison-btn').addEventListener('click', resetToDefault);
            document.getElementById('back-to-controls-btn').addEventListener('click', showControlsView);
            document.getElementById('chart-series-select').addEventListener('change', refreshChartWithNewIndicator);
        }
        
        // Show the controls view and hide the chart view
        function showControlsView() {
            document.getElementById('controls-section').style.display = 'block';
            document.getElementById('chart-section').style.display = 'none';
        }
        
        // Show the chart view and hide the controls view  
        function showChartView() {
            document.getElementById('controls-section').style.display = 'none';
            document.getElementById('chart-section').style.display = 'block';
            
            // Populate the chart view indicator selector
            populateChartSeriesSelector();
        }
        
        // Add a new location selection dropdown
        async function addLocationSelection() {
            if (selectionCount >= maxSelections) return;
            
            selectionCount++;
            await updateLocationSelections();
            updateButtons();
        }
        
        // Remove the last location selection
        async function removeLocationSelection() {
            if (selectionCount <= 1) return;
            
            selectionCount--;
            await updateLocationSelections();
            updateButtons();
        }
        
        // Update the location selection interface
        async function updateLocationSelections() {
            const container = document.getElementById('location-selections');
            
            // Store current selections before updating
            const currentSelections = {};
            for (let i = 1; i <= Math.max(selectionCount, container.children.length); i++) {
                const stateSelect = document.getElementById(`state-select-${i}`);
                const countySelect = document.getElementById(`county-select-${i}`);
                if (stateSelect && countySelect) {
                    currentSelections[i] = {
                        state: stateSelect.value,
                        county: countySelect.value
                    };
                }
            }
            
            // Only rebuild if we need more elements or fewer elements
            const currentCount = container.children.length;
            
            if (selectionCount > currentCount) {
                // Add new location selections
                for (let i = currentCount + 1; i <= selectionCount; i++) {
                    const locationDiv = document.createElement('div');
                    locationDiv.className = 'location-selection';
                    locationDiv.id = `location-${i}`;
                    locationDiv.innerHTML = `
                        <div>
                            <label>State Selection</label>
                            <select id="state-select-${i}" onchange="updateCounties(${i})">
                                <option value="">Choose State</option>
                                ${availableStates.map(state => 
                                    `<option value="${state}"${state === 'Florida' && i === 1 ? ' selected' : ''}>${state}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label>County Selection</label>
                            <select id="county-select-${i}">
                                <option value="">Choose County</option>
                            </select>
                        </div>
                    `;
                    container.appendChild(locationDiv);
                }
            } else if (selectionCount < currentCount) {
                // Remove excess location selections
                for (let i = currentCount; i > selectionCount; i--) {
                    const locationDiv = document.getElementById(`location-${i}`);
                    if (locationDiv) {
                        locationDiv.remove();
                    }
                }
            }
            
            // Restore previous selections
            for (let i = 1; i <= selectionCount; i++) {
                const stateSelect = document.getElementById(`state-select-${i}`);
                const countySelect = document.getElementById(`county-select-${i}`);
                
                if (currentSelections[i] && currentSelections[i].state) {
                    // Restore state selection
                    stateSelect.value = currentSelections[i].state;
                    
                    // Load counties for this state and then restore county selection
                    await updateCounties(i);
                    
                    // Restore county selection
                    if (currentSelections[i].county) {
                        countySelect.value = currentSelections[i].county;
                    }
                } else if (i === 1 && !currentSelections[i]) {
                    // Default first selection to Florida if no previous selection
                    stateSelect.value = 'Florida';
                    await updateCounties(i);
                }
            }
        }
        
        // Update counties dropdown when state changes
        async function updateCounties(selectionIndex) {
            const stateSelect = document.getElementById(`state-select-${selectionIndex}`);
            const countySelect = document.getElementById(`county-select-${selectionIndex}`);
            
            if (!stateSelect.value) {
                countySelect.innerHTML = '<option value="">Select County</option>';
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/counties?state=${encodeURIComponent(stateSelect.value)}`);
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error('Failed to fetch counties');
                }
                
                countySelect.innerHTML = '<option value="">Select County</option>';
                
                // Sort counties alphabetically by name
                const sortedCounties = result.data.sort((a, b) => a.name.localeCompare(b.name));
                
                sortedCounties.forEach(county => {
                    const option = document.createElement('option');
                    option.value = county.id;
                    option.textContent = county.name;
                    
                    // Default Palm Beach County for Florida
                    if (selectionIndex === 1 && stateSelect.value === 'Florida' && county.name === 'Palm Beach County') {
                        option.selected = true;
                    }
                    
                    countySelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error fetching counties:', error);
                countySelect.innerHTML = '<option value="">Error loading counties</option>';
            }
        }
        
        // Update button visibility
        function updateButtons() {
            const addBtn = document.getElementById('add-location-btn');
            const removeBtn = document.getElementById('remove-location-btn');
            
            addBtn.style.display = selectionCount >= maxSelections ? 'none' : 'inline-block';
            removeBtn.style.display = selectionCount <= 1 ? 'none' : 'inline-block';
        }
        
        // Reset to default (Palm Beach County only)
        async function resetToDefault() {
            selectionCount = 1;
            await updateLocationSelections();
            updateButtons();
            
            // Clear any existing chart, header, and notices
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
                comparisonChartInstance = null;
            }
            document.getElementById('chart-loading').style.display = 'none';
            document.getElementById('chart-error').style.display = 'none';
            document.getElementById('comparison-chart-header').style.display = 'none';
            document.getElementById('data-availability-notice').style.display = 'none';
            
            // Reset series selection to default
            const seriesSelect = document.getElementById('series-select');
            const defaultSeries = 'ACTIVE_COUNTY_INVENTORY';
            if (seriesOptionsCache && seriesOptionsCache[defaultSeries]) {
                seriesSelect.value = defaultSeries;
            } else if (seriesSelect.options.length > 1) {
                seriesSelect.selectedIndex = 1; // First non-empty option
            }
            
            // Clear saved comparison data
            await clearSavedComparison();
            
            // Switch back to controls view
            showControlsView();
        }
        
        // Clear saved comparison data from database
        async function clearSavedComparison() {
            try {
                // Save empty data to effectively clear the comparison
                const response = await fetch(`${API_BASE}/reports/${urlSlug}/area-comparison`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        seriesId: 'ACTIVE_COUNTY_INVENTORY',
                        countyIds: ['12099'] // Default Palm Beach County
                    })
                });
                
                if (!response.ok) {
                    console.warn('Failed to clear saved comparison data');
                }
            } catch (error) {
                console.error('Error clearing saved comparison data:', error);
            }
        }
        
        // Generate the comparison chart
        async function generateComparison() {
            const seriesSelect = document.getElementById('series-select');
            const selectedSeries = seriesSelect.value;
            
            if (!selectedSeries || !seriesOptionsCache) {
                alert('Please select a metric to compare');
                return;
            }
            
            // Collect all selections  
            const selections = [];
            let hasValidSelections = false;
            
            for (let i = 1; i <= selectionCount; i++) {
                const stateSelect = document.getElementById(`state-select-${i}`);
                const countySelect = document.getElementById(`county-select-${i}`);
                
                if (stateSelect && countySelect && stateSelect.value && countySelect.value) {
                    selections.push({
                        state: stateSelect.value,
                        county: countySelect.value,
                        countyName: countySelect.options[countySelect.selectedIndex].text
                    });
                    hasValidSelections = true;
                }
            }
            
            if (!hasValidSelections) {
                alert('Please select at least one location to compare');
                return;
            }
            
            // Save the comparison data before generating chart
            await saveComparisonData(selectedSeries, selections);
            
            // Switch to chart view and show loading state
            showChartView();
            document.getElementById('chart-loading').style.display = 'flex';
            document.getElementById('chart-error').style.display = 'none';
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
                comparisonChartInstance = null;
            }
            
            try {
                const seriesOption = seriesOptionsCache[selectedSeries];
                const chartData = {};
                const countyNames = {};
                const unavailableLocations = [];
                
                // Fetch data for each selected location
                for (const selection of selections) {
                    // Apply leading zeros based on series configuration
                    const countyCode = seriesOption.lead_zero ? 
                        selection.county.padStart(5, '0') : 
                        selection.county.replace(/^0+/, '');
                    
                    // Replace {COUNTY} placeholder with actual county code
                    const seriesId = seriesOption.series.replace('{COUNTY}', countyCode);
                    
                    try {
                        const fredData = await fetchFredData(seriesId);
                        if (fredData && fredData.length > 0) {
                            chartData[selection.county] = fredData.map(obs => ({
                                date: new Date(obs.date),
                                value: parseFloat(obs.value)
                            })).filter(obs => !isNaN(obs.value));
                            countyNames[selection.county] = selection.countyName;
                        } else {
                            unavailableLocations.push({
                                name: selection.countyName,
                                seriesId: seriesId
                            });
                        }
                    } catch (error) {
                        console.warn(`Failed to fetch data for ${selection.countyName}:`, error);
                        unavailableLocations.push({
                            name: selection.countyName,
                            seriesId: seriesId,
                            error: error.message
                        });
                    }
                }
                
                // Hide loading state
                document.getElementById('chart-loading').style.display = 'none';
                
                if (Object.keys(chartData).length === 0) {
                    document.getElementById('chart-error').style.display = 'flex';
                    document.getElementById('comparison-chart-header').style.display = 'none';
                    return;
                }
                
                // Show chart header and create the comparison chart
                document.getElementById('comparison-chart-header').style.display = 'block';
                createSimpleComparisonChart(chartData, countyNames, seriesOption.display_name);
                
                // Display professional notification for unavailable data
                if (unavailableLocations.length > 0) {
                    displayDataAvailabilityNotice(unavailableLocations, seriesOption.display_name);
                }
                
            } catch (error) {
                console.error('Error generating comparison:', error);
                document.getElementById('chart-loading').style.display = 'none';
                document.getElementById('chart-error').style.display = 'flex';
            }
        }
        
        // Save comparison data to database
        async function saveComparisonData(seriesId, selections) {
            try {
                console.log('Saving comparison data:', { seriesId, selections });
                
                // Extract county IDs from selections
                const countyIds = selections.map(selection => selection.county);
                
                const response = await fetch(`${API_BASE}/reports/${urlSlug}/area-comparison`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        seriesId: seriesId,
                        countyIds: countyIds
                    })
                });
                
                const result = await response.json();
                if (!response.ok || !result.success) {
                    console.error('Error saving comparison data:', result.error);
                } else {
                    console.log('Comparison data saved successfully');
                }
            } catch (error) {
                console.error('Error saving comparison data:', error);
                // Don't block the chart generation if save fails
            }
        }
        
        // Fetch FRED data for a specific series
        async function fetchFredData(seriesId) {
            const endDate = new Date().toISOString().split('T')[0];
            const startDate = new Date(new Date().setFullYear(new Date().getFullYear() - 5))
                .toISOString().split('T')[0];
            
            const response = await fetch(`${API_BASE}/fred-data?seriesId=${seriesId}&startDate=${startDate}&endDate=${endDate}`);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to fetch FRED data');
            }
            
            return data.observations || [];
        }
        
        // Create a simple comparison chart using Chart.js
        function createSimpleComparisonChart(data, countyNames, title) {
            const canvas = document.getElementById('comparison-chart');
            
            if (!canvas) {
                console.error('Comparison chart canvas not found');
                return;
            }
            
            // Function to get color for a county
            function getCountyColor(countyId) {
                // Check if this is Palm Beach County (ID: 12099 or name contains "Palm Beach")
                const countyName = countyNames[countyId] || '';
                if (countyId === '12099' || countyName.includes('Palm Beach')) {
                    return '#003366'; // Dark blue for Palm Beach County
                }
                
                // Distinct, bright colors for other counties - easy to differentiate
                const otherColors = [
                    '#e74c3c',  // Bright red
                    '#f39c12',  // Orange
                    '#27ae60',  // Green  
                    '#9b59b6',  // Purple
                    '#3498db',  // Light blue (distinct from Palm Beach dark blue)
                    '#e67e22',  // Dark orange
                    '#1abc9c',  // Teal
                    '#34495e',  // Dark gray
                    '#f1c40f',  // Yellow
                    '#8e44ad'   // Dark purple
                ];
                
                // Assign colors to non-Palm Beach counties in order
                const nonPalmBeachIds = Object.keys(countyNames).filter(id => 
                    id !== '12099' && !countyNames[id].includes('Palm Beach')
                );
                const colorIndex = nonPalmBeachIds.indexOf(countyId);
                return otherColors[colorIndex % otherColors.length];
            }
            
            // Destroy existing chart if it exists
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
            }
            
            // Prepare datasets for Chart.js
            const datasets = Object.entries(data).map(([countyId, countyData]) => {
                const color = getCountyColor(countyId);
                const countyName = countyNames[countyId] || `County ${countyId}`;
                
                return {
                    label: countyName.replace(' County', ''),
                    data: countyData.map(d => ({
                        x: d.date,
                        y: d.value
                    })),
                    backgroundColor: color + '20', // 20% opacity for fill
                    borderColor: color,
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointBackgroundColor: color,
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: color,
                    pointHoverBorderColor: '#ffffff'
                };
            });
            
            const ctx = canvas.getContext('2d');
            
            // Create Chart.js configuration
            const config = {
                type: 'line',
                data: {
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#333'
                        },
                        legend: {
                            display: true,
                            position: 'right',
                            labels: {
                                usePointStyle: false,
                                boxWidth: 14,
                                boxHeight: 4,
                                font: {
                                    size: 11
                                },
                                color: '#333'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(tooltipItems) {
                                    const date = new Date(tooltipItems[0].parsed.x);
                                    return date.toLocaleDateString();
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                displayFormats: {
                                    month: 'MMM yyyy'
                                }
                            },
                            grid: {
                                display: true,
                                color: '#f0f0f0'
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                }
                            }
                        },
                        y: {
                            grid: {
                                display: true,
                                color: '#f0f0f0'
                            },
                            ticks: {
                                color: '#666',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false
                    },
                    elements: {
                        line: {
                            tension: 0.4
                        }
                    }
                }
            };

            // Create the chart and store the instance
            comparisonChartInstance = new Chart(ctx, config);
        }
        
        // Display professional notice for unavailable data series
        function displayDataAvailabilityNotice(unavailableLocations, seriesName) {
            const noticeContainer = document.getElementById('data-availability-notice');
            
            if (unavailableLocations.length === 0) {
                noticeContainer.style.display = 'none';
                return;
            }
            
            const locationsList = unavailableLocations.map(location => 
                `<li>${location.name}</li>`
            ).join('');
            
            const pluralText = unavailableLocations.length === 1 ? 'location' : 'locations';
            const verbText = unavailableLocations.length === 1 ? 'is' : 'are';
            
            noticeContainer.innerHTML = `
                <div class="data-notice-header">
                    <svg class="data-notice-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <h4 class="data-notice-title">Data Availability Notice</h4>
                </div>
                <p class="data-notice-content">
                    The <strong>${seriesName}</strong> indicator ${verbText} currently unavailable for the following ${pluralText}. 
                    This may be due to data collection schedules or regional reporting variations. 
                    The analysis above reflects all available data sources.
                </p>
                <ul class="unavailable-locations">
                    ${locationsList}
                </ul>
            `;
            
            noticeContainer.style.display = 'block';
        }
        
        // Populate the chart view series selector with the same options as the main selector
        function populateChartSeriesSelector() {
            const mainSeriesSelect = document.getElementById('series-select');
            const chartSeriesSelect = document.getElementById('chart-series-select');
            
            if (!mainSeriesSelect || !chartSeriesSelect) {
                console.error('Series select elements not found');
                return;
            }
            
            // Clear existing options except the first placeholder
            chartSeriesSelect.innerHTML = '<option value="">Select Indicator...</option>';
            
            // Copy options from main selector, skipping the first loading option
            for (let i = 1; i < mainSeriesSelect.options.length; i++) {
                const option = mainSeriesSelect.options[i];
                const newOption = document.createElement('option');
                newOption.value = option.value;
                newOption.textContent = option.textContent;
                
                // Set selected if this matches the main selector's value
                if (option.value === mainSeriesSelect.value) {
                    newOption.selected = true;
                }
                
                chartSeriesSelect.appendChild(newOption);
            }
        }
        
        // Handle indicator change in chart view - refresh the chart with new indicator
        async function refreshChartWithNewIndicator() {
            const chartSeriesSelect = document.getElementById('chart-series-select');
            const selectedSeries = chartSeriesSelect.value;
            
            if (!selectedSeries || !seriesOptionsCache) {
                return;
            }
            
            // Also update the main series selector to keep them in sync
            const mainSeriesSelect = document.getElementById('series-select');
            if (mainSeriesSelect) {
                mainSeriesSelect.value = selectedSeries;
            }
            
            // Get current location selections (they should still be available from the previous generation)
            const selections = [];
            
            for (let i = 1; i <= selectionCount; i++) {
                const stateSelect = document.getElementById(`state-select-${i}`);
                const countySelect = document.getElementById(`county-select-${i}`);
                
                if (stateSelect && countySelect && stateSelect.value && countySelect.value) {
                    selections.push({
                        state: stateSelect.value,
                        county: countySelect.value,
                        countyName: countySelect.options[countySelect.selectedIndex].text
                    });
                }
            }
            
            if (selections.length === 0) {
                console.error('No location selections found for chart refresh');
                return;
            }
            
            // Save the new comparison data
            await saveComparisonData(selectedSeries, selections);
            
            // Show loading state
            document.getElementById('chart-loading').style.display = 'flex';
            document.getElementById('chart-error').style.display = 'none';
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
                comparisonChartInstance = null;
            }
            
            try {
                const seriesOption = seriesOptionsCache[selectedSeries];
                const chartData = {};
                const countyNames = {};
                const unavailableLocations = [];
                
                // Fetch data for each selected location
                for (const selection of selections) {
                    // Apply leading zeros based on series configuration
                    const countyCode = seriesOption.lead_zero ? 
                        selection.county.padStart(5, '0') : 
                        selection.county.replace(/^0+/, '');
                    
                    // Replace {COUNTY} placeholder with actual county code
                    const seriesId = seriesOption.series.replace('{COUNTY}', countyCode);
                    
                    try {
                        const fredData = await fetchFredData(seriesId);
                        if (fredData && fredData.length > 0) {
                            chartData[selection.county] = fredData.map(obs => ({
                                date: new Date(obs.date),
                                value: parseFloat(obs.value)
                            })).filter(obs => !isNaN(obs.value));
                            countyNames[selection.county] = selection.countyName;
                        } else {
                            unavailableLocations.push({
                                name: selection.countyName,
                                seriesId: seriesId
                            });
                        }
                    } catch (error) {
                        console.warn(`Failed to fetch data for ${selection.countyName}:`, error);
                        unavailableLocations.push({
                            name: selection.countyName,
                            seriesId: seriesId,
                            error: error.message
                        });
                    }
                }
                
                // Hide loading state
                document.getElementById('chart-loading').style.display = 'none';
                
                if (Object.keys(chartData).length === 0) {
                    document.getElementById('chart-error').style.display = 'flex';
                    document.getElementById('comparison-chart-header').style.display = 'none';
                    return;
                }
                
                // Show chart header and create the comparison chart
                document.getElementById('comparison-chart-header').style.display = 'block';
                createSimpleComparisonChart(chartData, countyNames, seriesOption.display_name);
                
                // Display professional notification for unavailable data
                if (unavailableLocations.length > 0) {
                    displayDataAvailabilityNotice(unavailableLocations, seriesOption.display_name);
                } else {
                    // Hide the notice if all data is available
                    document.getElementById('data-availability-notice').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error refreshing chart with new indicator:', error);
                document.getElementById('chart-loading').style.display = 'none';
                document.getElementById('chart-error').style.display = 'flex';
            }
        }
        
        // Map functionality
        let map = null;
        let currentDevelopmentName = null;
        
        // Initialize map button click handler
        function initializeMapButton() {
            const mapButton = document.getElementById('mapButton');
            if (mapButton) {
                mapButton.addEventListener('click', openDevelopmentMap);
            }
        }
        
        // Open development map in modal
        async function openDevelopmentMap() {
            const modal = document.getElementById('mapModal');
            const loading = document.getElementById('mapLoading');
            const error = document.getElementById('mapError');
            const subtitle = document.getElementById('mapSubtitle');
            
            // Get development name from current report data
            const reportData = getCurrentReportData();
            if (!reportData || !reportData.development) {
                showMapError('No development information available for this property.');
                return;
            }
            
            currentDevelopmentName = reportData.development.trim();
            subtitle.textContent = `Showing parcels for ${currentDevelopmentName}`;
            
            // Show modal and loading state
            modal.style.display = 'block';
            loading.style.display = 'flex';
            error.style.display = 'none';
            
            try {
                // Fetch parcel data
                const response = await fetch(`${API_BASE}/development-parcels/${encodeURIComponent(currentDevelopmentName)}`);
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to load parcel data');
                }
                
                if (!result.data || !result.data.features || result.data.features.length === 0) {
                    throw new Error('No parcels found for this development');
                }
                
                // Initialize map
                await initializeMap(result.data);
                
            } catch (error) {
                console.error('Error loading development map:', error);
                showMapError(error.message);
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // Initialize Leaflet map with parcel data
        async function initializeMap(geojsonData) {
            const mapContainer = document.getElementById('developmentMap');
            
            // Clear existing map
            if (map) {
                map.remove();
                map = null;
            }
            
            // Create new map
            map = L.map('developmentMap', {
                zoomControl: true,
                scrollWheelZoom: true
            });
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Color mode state and helpers
            let colorMode = 'none';
            let valueThresholds = null; // used for price/value modes
            let valueMin = null;
            let valueMax = null;
            const COLOR_MAP = {
                gray: '#6c757d',
                yellow: '#FFD54F',
                green: '#2ECC71',
                blue: '#3498DB',
                red: '#E74C3C',
                orange: '#F39C12',
                darkGreen: '#006400',
                lightGreen: '#90EE90',
                purple: '#8E44AD'
            };

            function parseDateSafe(value) {
                if (!value) return null;
                let v = String(value).trim();
                if (!v) return null;
                // Normalize common formats: YYYYMMDD, MM/DD/YYYY, YYYY-MM-DD
                if (/^\d{8}$/.test(v)) {
                    // Assume YYYYMMDD
                    v = `${v.slice(0,4)}-${v.slice(4,6)}-${v.slice(6,8)}`;
                } else if (/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(v)) {
                    const [m, d, y] = v.split('/');
                    const year = y.length === 2 ? `20${y}` : y;
                    v = `${year}-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
                }
                const d = new Date(v);
                return isNaN(d.getTime()) ? null : d;
            }

            function monthsBetween(fromDate, toDate) {
                const years = toDate.getFullYear() - fromDate.getFullYear();
                const months = toDate.getMonth() - fromDate.getMonth();
                const total = years * 12 + months + (toDate.getDate() >= fromDate.getDate() ? 0 : -1);
                return total;
            }

            function currencyFormat(n) {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n);
            }

            function computeQuantileThresholds(values) {
                const nums = values.filter(v => typeof v === 'number' && !isNaN(v)).sort((a, b) => a - b);
                if (nums.length === 0) return null;
                function quantile(p) {
                    const idx = Math.floor((nums.length - 1) * p);
                    return nums[idx];
                }
                return {
                    q50: quantile(0.50),
                    q75: quantile(0.75),
                    q85: quantile(0.85),
                    q95: quantile(0.95)
                };
            }

            function colorByTaxSaleDate(props) {
                const now = new Date();
                const d = parseDateSafe(props.last_sale_date);
                if (!d) return COLOR_MAP.gray;
                const m = monthsBetween(d, now);
                if (m < 6) return COLOR_MAP.yellow;
                if (m < 12) return COLOR_MAP.green;
                if (m < 24) return COLOR_MAP.blue;
                if (m < 60) return COLOR_MAP.red;
                return COLOR_MAP.orange; // 5+ years
            }

            function colorBySoldSinceCovid(props) {
                const d = parseDateSafe(props.last_sale_date);
                if (!d) return COLOR_MAP.gray;
                const covid = new Date('2020-01-01');
                return d >= covid ? COLOR_MAP.green : COLOR_MAP.gray;
            }

            function colorByValue(value) {
                if (value == null) return COLOR_MAP.gray;
                const num = typeof value === 'number' ? value : parseFloat(String(value).replace(/[$,]/g, ''));
                if (isNaN(num) || !valueThresholds) return COLOR_MAP.gray;
                const { q50, q75, q85, q95 } = valueThresholds;
                if (num >= q95) return COLOR_MAP.darkGreen;   // top 5%
                if (num >= q85) return COLOR_MAP.lightGreen;  // top 15%
                if (num >= q75) return COLOR_MAP.yellow;      // top 25%
                if (num >= q50) return COLOR_MAP.orange;      // top 50%
                return COLOR_MAP.red;                           // remaining
            }

            function colorByMlsStatus(props) {
                const status = (props.mls_status || '').toLowerCase();
                if (!status) return COLOR_MAP.gray;
                if (status === 'coming soon') return COLOR_MAP.purple;
                if (status === 'active') return COLOR_MAP.green;
                if (status === 'active under contract') return COLOR_MAP.orange;
                if (status === 'pending') return COLOR_MAP.blue;
                if (status === 'closed') {
                    // last 6 months yellow, older red
                    const sd = parseDateSafe(props.mls_sold_date);
                    if (!sd) return COLOR_MAP.gray;
                    const m = monthsBetween(sd, new Date());
                    return m <= 6 ? COLOR_MAP.yellow : COLOR_MAP.red;
                }
                return COLOR_MAP.gray;
            }

            function defaultLandUseStyle(props) {
                const landUse = (props.land_use_description || '').toString();
                const isCondo = landUse.toUpperCase().includes('CONDOMINIUM');
                return {
                    color: isCondo ? COLOR_MAP.purple : '#3498db',
                    weight: 2,
                    fillColor: isCondo ? COLOR_MAP.purple : '#3498db',
                    fillOpacity: 0.6
                };
            }

            function computeStyleByMode(props) {
                if (colorMode === 'none') {
                    return defaultLandUseStyle(props);
                }
                let outline = '#333';
                let fill = COLOR_MAP.blue;
                switch (colorMode) {
                    case 'tax_sale_date':
                        fill = colorByTaxSaleDate(props);
                        break;
                    case 'tax_sale_price':
                        fill = colorByValue(parseFloat(props.last_sale_price));
                        break;
                    case 'tax_market_value':
                        fill = colorByValue(parseFloat(props.market_value));
                        break;
                    case 'sold_since_covid':
                        fill = colorBySoldSinceCovid(props);
                        break;
                    case 'mls_status':
                        fill = colorByMlsStatus(props);
                        break;
                    default:
                        break;
                }
                return { color: outline, weight: 2, fillColor: fill, fillOpacity: 0.75 };
            }

            // Legend UI
            const legend = document.createElement('div');
            legend.id = 'mapLegend';
            legend.style.position = 'absolute';
            legend.style.bottom = '16px';
            legend.style.right = '16px';
            legend.style.background = 'rgba(255,255,255,0.95)';
            legend.style.border = '1px solid #dee2e6';
            legend.style.borderRadius = '8px';
            legend.style.boxShadow = '0 2px 6px rgba(0,0,0,0.15)';
            legend.style.padding = '12px 14px';
            legend.style.minWidth = '220px';
            legend.style.fontSize = '12px';
            legend.style.zIndex = '1200';
            legend.innerHTML = '';
            mapContainer.parentElement.appendChild(legend);

            function renderLegend() {
                function swatch(color, label) {
                    return `<div style="display:flex;align-items:center;gap:8px;margin:4px 0;">
                        <span style="display:inline-block;width:14px;height:14px;background:${color};border:1px solid #999;border-radius:3px;"></span>
                        <span>${label}</span>
                    </div>`;
                }

                if (colorMode === 'none') {
                    legend.innerHTML = '';
                    return;
                }

                if (colorMode === 'tax_sale_date') {
                    legend.innerHTML = `
                        <div style="font-weight:600;margin-bottom:6px;">Legend: Tax Last Sale Date</div>
                        ${swatch(COLOR_MAP.yellow, 'Less than 6 months')}
                        ${swatch(COLOR_MAP.green, '6 months to 1 year')}
                        ${swatch(COLOR_MAP.blue, '1 to 2 years')}
                        ${swatch(COLOR_MAP.red, '2 to 5 years')}
                        ${swatch(COLOR_MAP.orange, 'More than 5 years')}
                        ${swatch(COLOR_MAP.gray, 'No data')}
                    `;
                } else if (colorMode === 'sold_since_covid') {
                    legend.innerHTML = `
                        <div style="font-weight:600;margin-bottom:6px;">Legend: Sold Since Jan 1, 2020</div>
                        ${swatch(COLOR_MAP.green, 'Sold since 2020-01-01')}
                        ${swatch(COLOR_MAP.gray, 'Not sold since 2020-01-01 or no data')}
                    `;
                } else if (colorMode === 'tax_sale_price' || colorMode === 'tax_market_value') {
                    if (!valueThresholds || valueMin == null || valueMax == null) { legend.innerHTML = ''; return; }
                    const { q50, q75, q85, q95 } = valueThresholds;
                    const range = (a, b) => `${currencyFormat(a)} - ${currencyFormat(b)}`;
                    legend.innerHTML = `
                        <div style="font-weight:600;margin-bottom:6px;">Legend: ${colorMode === 'tax_sale_price' ? 'Tax Last Sale Price' : 'Tax Market Value'}</div>
                        ${swatch(COLOR_MAP.darkGreen, range(q95, valueMax))}
                        ${swatch(COLOR_MAP.lightGreen, range(q85, q95))}
                        ${swatch(COLOR_MAP.yellow, range(q75, q85))}
                        ${swatch(COLOR_MAP.orange, range(q50, q75))}
                        ${swatch(COLOR_MAP.red, range(valueMin, q50))}
                        ${swatch(COLOR_MAP.gray, 'No data')}
                    `;
                } else if (colorMode === 'mls_status') {
                    legend.innerHTML = `
                        <div style="font-weight:600;margin-bottom:6px;">Legend: MLS Status</div>
                        ${swatch(COLOR_MAP.green, 'Active')}
                        ${swatch(COLOR_MAP.orange, 'Active Under Contract')}
                        ${swatch(COLOR_MAP.yellow, 'Closed (Last 6 months)')}
                        ${swatch(COLOR_MAP.red, 'Closed (Older)')}
                        ${swatch(COLOR_MAP.purple, 'Coming Soon')}
                        ${swatch(COLOR_MAP.blue, 'Pending')}
                        ${swatch(COLOR_MAP.gray, 'No Data')}
                    `;
                } else {
                    legend.innerHTML = '';
                }
            }

            function recomputeThresholdsIfNeeded(features) {
                if (colorMode === 'tax_sale_price') {
                    const vals = features.map(f => parseFloat(String(f.properties.last_sale_price || '').toString().replace(/[$,]/g, ''))).filter(v => !isNaN(v));
                    valueThresholds = computeQuantileThresholds(vals);
                    if (vals.length > 0) { valueMin = Math.min(...vals); valueMax = Math.max(...vals); } else { valueMin = valueMax = null; }
                } else if (colorMode === 'tax_market_value') {
                    const vals = features.map(f => parseFloat(String(f.properties.market_value || '').toString().replace(/[$,]/g, ''))).filter(v => !isNaN(v));
                    valueThresholds = computeQuantileThresholds(vals);
                    if (vals.length > 0) { valueMin = Math.min(...vals); valueMax = Math.max(...vals); } else { valueMin = valueMax = null; }
                } else {
                    valueThresholds = null; valueMin = valueMax = null;
                }
            }

            function updateParcelStyles() {
                parcelLayer.eachLayer(function(layer) {
                    const props = layer.feature.properties;
                    const style = computeStyleByMode(props);
                    layer.setStyle(style);
                });
                renderLegend();
            }

            // Add parcel polygons
            const parcelLayer = L.geoJSON(geojsonData, {
                style: function(feature) {
                    return computeStyleByMode(feature.properties);
                },
                onEachFeature: function(feature, layer) {
                    // Create popup content using tax record template
                    const props = feature.properties;
                    const landUse = props.land_use_description || '';
                    const isCondominium = landUse.toUpperCase().includes('CONDOMINIUM');
                    
                    let popupContent;
                    
                    if (isCondominium) {
                        // Simplified popup for condominiums - subdivision info (no MLS waterfrontage shown)
                        popupContent = `
                            <div style="min-width: 280px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.4;">
                                <div style="margin-bottom: 8px; font-size: 16px; font-weight: 600; color: #8e44ad;">Condominium Building</div>
                                <div style="margin-bottom: 8px;"><strong>Development:</strong> ${props.development_name || 'N/A'}</div>
                                <div style="margin-bottom: 8px;"><strong>Subdivision:</strong> ${props.subdivision_name || 'N/A'}</div>
                        `;
                        
                        // Add unit count info
                        if (props.unit_count && props.unit_count > 1) {
                            popupContent += `<div style="margin-top: 12px; padding: 8px; background-color: #f8f4ff; border-left: 3px solid #8e44ad; font-size: 12px; color: #666;">
                                <strong>Building Info:</strong> This building contains ${props.unit_count} condominium units
                            </div>`;
                        }
                        
                        popupContent += '</div>';
                    } else {
                        // Full popup for non-condominium properties
                        
                        // Format address
                        let address = 'N/A';
                        if (props.address) {
                            let fullAddress = props.address;
                            if (props.city) fullAddress += ` ${props.city}`;
                            if (props.zip_code) fullAddress += `, FL ${props.zip_code}`;
                            address = fullAddress;
                        }
                        
                        // Format market value
                        let marketValue = 'N/A';
                        if (props.market_value) {
                            marketValue = new Intl.NumberFormat('en-US', {
                                style: 'currency',
                                currency: 'USD',
                                minimumFractionDigits: 0
                            }).format(props.market_value);
                        }
                        
                        // Format last sale price
                        let lastSalePrice = 'N/A';
                        if (props.last_sale_price) {
                            lastSalePrice = new Intl.NumberFormat('en-US', {
                                style: 'currency',
                                currency: 'USD',
                                minimumFractionDigits: 0
                            }).format(props.last_sale_price);
                        }
                        
                        // Format bathrooms (convert to numbers to remove leading zeros)
                        let bathrooms = 'N/A';
                        if (props.full_baths || props.half_baths) {
                            const full = parseInt(props.full_baths) || 0;
                            const half = parseInt(props.half_baths) || 0;
                            if (half > 0) {
                                bathrooms = `${full} full, ${half} half`;
                            } else {
                                bathrooms = `${full} full`;
                            }
                        }
                        
                        popupContent = `
                            <div style="min-width: 280px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; line-height: 1.4;">
                                <div style="margin-bottom: 8px;"><strong>Address:</strong> ${address}</div>
                                <div style="margin-bottom: 8px;"><strong>Parcel ID:</strong> ${props.property_control_number || 'N/A'} [TAX]</div>
                                <div style="margin-bottom: 8px;"><strong>Year Built:</strong> ${props.year_built || 'N/A'}</div>
                                <div style="margin-bottom: 8px;"><strong>Development:</strong> ${props.development_name || 'N/A'}</div>
                                <div style="margin-bottom: 8px;"><strong>Subdivision:</strong> ${props.subdivision_name || 'N/A'}</div>
                                <div style="margin-bottom: 8px;"><strong>Bedrooms:</strong> ${props.bedrooms ? parseInt(props.bedrooms) : 'N/A'}</div>
                                <div style="margin-bottom: 8px;"><strong>Bathrooms:</strong> ${bathrooms}</div>
                                <div style="margin-bottom: 8px;"><strong>Market Value:</strong> <span style="color: #27ae60; font-weight: 600;">${marketValue}</span></div>
                                <div style="margin-bottom: 8px;"><strong>Last Sale Date:</strong> ${props.last_sale_date || 'N/A'}</div>
                                <div style="margin-bottom: 8px;"><strong>Last Sale Price:</strong> ${lastSalePrice}</div>
                                <div style="margin-bottom: 0;"><strong>Waterfrontage (MLS):</strong> ${props.waterfrontage || 'N/A'}</div>
                        `;
                        
                        // Add unit count info for multi-unit buildings
                        if (props.unit_count && props.unit_count > 1) {
                            popupContent += `<div style="margin-top: 12px; padding: 8px; background-color: #f8f9fa; border-left: 3px solid #3498db; font-size: 12px; color: #666;">
                                <strong>Building Info:</strong> This building contains ${props.unit_count} units
                            </div>`;
                        }
                        
                        popupContent += '</div>';
                    }
                    
                    layer.bindPopup(popupContent);
                    
                    // Add hover effects
                    layer.on('mouseover', function() {
                        this.setStyle({
                            weight: 3,
                            fillOpacity: 0.9
                        });
                    });
                    
                    layer.on('mouseout', function() {
                        // Restore style based on current mode
                        this.setStyle(computeStyleByMode(this.feature.properties));
                    });
                }
            }).addTo(map);
            
            // Fit map to parcel bounds
            map.fitBounds(parcelLayer.getBounds(), {
                padding: [20, 20]
            });

            // Create color mode selector UI
            const selectorWrap = document.createElement('div');
            selectorWrap.style.position = 'absolute';
            selectorWrap.style.top = '16px';
            selectorWrap.style.right = '16px';
            selectorWrap.style.background = 'rgba(255,255,255,0.95)';
            selectorWrap.style.border = '1px solid #dee2e6';
            selectorWrap.style.borderRadius = '8px';
            selectorWrap.style.boxShadow = '0 2px 6px rgba(0,0,0,0.15)';
            selectorWrap.style.padding = '8px 12px';
            selectorWrap.style.zIndex = '1200';
            selectorWrap.style.display = 'flex';
            selectorWrap.style.gap = '8px';
            selectorWrap.style.alignItems = 'center';

            const select = document.createElement('select');
            select.id = 'colorModeSelect';
            select.style.fontSize = '12px';
            select.style.padding = '6px 8px';
            select.style.border = '1px solid #ced4da';
            select.style.borderRadius = '6px';
            select.style.background = '#fff';

            const options = [
                { value: 'none', label: 'View Metric' },
                { value: 'tax_sale_date', label: 'Tax Last Sale Date' },
                { value: 'tax_sale_price', label: 'Tax Last Sale Price' },
                { value: 'tax_market_value', label: 'Tax Market Value' },
                { value: 'sold_since_covid', label: 'Sold Since Covid (Jan 1 2020)' },
                { value: 'mls_status', label: 'MLS Status' }
            ];
            options.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt.value;
                o.textContent = opt.label;
                select.appendChild(o);
            });
            select.value = colorMode;

            select.addEventListener('change', function() {
                colorMode = this.value;
                recomputeThresholdsIfNeeded(geojsonData.features);
                updateParcelStyles();
            });

            selectorWrap.appendChild(select);
            mapContainer.parentElement.appendChild(selectorWrap);

            // Initial thresholds + legend render
            recomputeThresholdsIfNeeded(geojsonData.features);
            renderLegend();
        }
        
        // Get status color for styling
        function getStatusColor(status) {
            if (!status) return '#6c757d';
            
            const statusLower = status.toLowerCase();
            if (statusLower.includes('active')) return '#e74c3c';
            if (statusLower.includes('sold') || statusLower.includes('closed')) return '#27ae60';
            if (statusLower.includes('pending') || statusLower.includes('contract')) return '#f39c12';
            return '#6c757d';
        }
        
        // Show map error
        function showMapError(message) {
            const modal = document.getElementById('mapModal');
            const loading = document.getElementById('mapLoading');
            const error = document.getElementById('mapError');
            const errorMessage = document.getElementById('mapErrorMessage');
            
            modal.style.display = 'block';
            loading.style.display = 'none';
            error.style.display = 'flex';
            errorMessage.textContent = message;
        }
        
        // Get current report data
        function getCurrentReportData() {
            // This function should return the current report data
            // For now, we'll try to extract it from the DOM or use a global variable
            const developmentElement = document.querySelector('#propertyAddress');
            if (developmentElement) {
                // Try to extract development name from the styled address
                const addressHtml = developmentElement.innerHTML;
                const italicMatches = addressHtml.match(/<div[^>]*font-style:\s*italic[^>]*>([^<]+)<\/div>/g);
                if (italicMatches && italicMatches.length > 0) {
                    // Get the first italic line (development)
                    const developmentMatch = italicMatches[0].match(/>([^<]+)</);
                    if (developmentMatch) {
                        return { development: developmentMatch[1].trim() };
                    }
                }
            }
            
            // Fallback: return null if no development found
            return null;
        }
        
        // Close map modal
        function closeMapModal() {
            const modal = document.getElementById('mapModal');
            modal.style.display = 'none';
            
            // Clean up map
            if (map) {
                map.remove();
                map = null;
            }
        }
        
        // Initialize map modal close handler
        function initializeMapModal() {
            const closeButton = document.getElementById('closeMapModal');
            if (closeButton) {
                closeButton.addEventListener('click', closeMapModal);
            }
            
            // Close modal when clicking outside
            const modal = document.getElementById('mapModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeMapModal();
                    }
                });
            }
            
            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.style.display === 'block') {
                    closeMapModal();
                }
            });
        }
        
        // Global function to update counties (called from inline onchange)
        window.updateCounties = updateCounties;
        
        // Load report on page load
        loadReport();
        
        // Initialize map functionality
        initializeMapButton();
        
        // Initialize map modal after DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeMapModal();
            // Set header logo src relative to report app root
            try {
                var headerLogo = document.getElementById('headerLogo');
                if (headerLogo) {
                    var base = window.location.pathname.startsWith('/report/') ? '/report' : '';
                    headerLogo.src = base + '/logo.png';
                }
            } catch (e) { /* noop */ }
        });
        
        // Also try initializing immediately in case DOMContentLoaded already fired
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeMapModal);
        } else {
            // DOM is already loaded
            setTimeout(initializeMapModal, 100);
        }
        
        // Initialize FRED comparison after report loads
        function waitForElements() {
            const seriesSelect = document.getElementById('series-select');
            if (seriesSelect) {
                initializeFredComparison();
            } else {
                console.log('Waiting for FRED elements to load...');
                setTimeout(waitForElements, 500);
            }
        }
        setTimeout(waitForElements, 1000);

        // API base path (supports reverse-proxy /report prefix)
        // Already defined at top; reuse to avoid redeclaration
        // const API_BASE = window.location.pathname.startsWith('/report/') ? '/report/api' : '/api';

        // Development/Zone Comparison Functionality
        let selectionMode = 'development'; // 'development' | 'zone'
        // Track last mouse position as a reliable fallback for popup placement
        (function trackLastMousePosition(){
            try {
                window.__lastMouse = { x: 0, y: 0 };
                document.addEventListener('mousemove', function(e){
                    if (e && typeof e.clientX === 'number' && typeof e.clientY === 'number') {
                        window.__lastMouse.x = e.clientX;
                        window.__lastMouse.y = e.clientY;
                    }
                }, { passive: true });
            } catch (err) {
                console.warn('Unable to attach mousemove listener for popup placement fallback:', err);
            }
        })();

        let developmentSelectionCount = 1;
        let developmentsList = [];
        let zonesList = [];
        let __suppressNextDocumentClick = false;

        // Helper: Try direct-render neighbourhood from complete endpoint (fallback)
        async function tryRenderFromComplete(slug) {
            try {
                const resp = await fetch(`${API_BASE}/reports/complete/${slug}`);
                if (!resp.ok) return false;
                const json = await resp.json();
                const charts = json && json.data && Array.isArray(json.data.charts) ? json.data.charts : [];
                const saved = charts.find(c => c && (c.chart_type === 'neighbourhood_comparison' || c.chart_type === 'neighborhood_comparison'));
                if (!saved || !Array.isArray(saved.locations) || saved.locations.length === 0) return false;

                const selections = saved.locations;
                const url = `${API_BASE}/developments-comparison?developments=${encodeURIComponent(selections.join(','))}`;
                const response = await fetch(url);
                if (!response.ok) return false;
                const result = await response.json();
                const data = (result && result.data && result.data.comparisonData) ? result.data.comparisonData : (result.data || []);

                displayDevelopmentComparisonChart(data, selections);
                showDevelopmentChartView();
                const chartControls = document.getElementById('development-chart-controls');
                if (chartControls) chartControls.style.display = 'block';
                const chartHeader = document.getElementById('dev-comparison-chart-header');
                if (chartHeader) chartHeader.style.display = 'block';
                // Restore chart type (no auto-regenerate)
                if (saved.series_id) {
                    const type = String(saved.series_id);
                    if (type === 'sales' || type === 'price' || type === 'price_per_sqft') {
                        switchDevelopmentChart(type);
                    }
                }
                return true;
            } catch (e) {
                console.warn('tryRenderFromComplete failed:', e);
                return false;
            }
        }

        // Initialize development comparison
        async function initializeDevelopmentComparison() {
            try {
                // 1) Try direct-render from saved neighbourhood comparison first (no dropdown population)
                try {
                    const slugEl = document.getElementById('reportContent');
                    const slug = (typeof urlSlug !== 'undefined') ? urlSlug : (window.location.pathname.split('/').pop());
                    let rendered = false;
                    try {
                        const resp = await fetch(`${API_BASE}/reports/${slug}/neighbourhood-comparison?neigh=1`);
                        if (resp.ok) {
                            const saved = await resp.json();
                            const payload = saved && saved.data ? saved.data : null;
                            if (payload && Array.isArray(payload.locations) && payload.locations.length > 0) {
                                const selections = payload.locations;
                                const url = `${API_BASE}/developments-comparison?developments=${encodeURIComponent(selections.join(','))}`;
                                const response = await fetch(url);
                                if (response.ok) {
                                    const result = await response.json();
                                    const data = (result && result.data && result.data.comparisonData) ? result.data.comparisonData : (result.data || []);
                                    displayDevelopmentComparisonChart(data, selections);
                                    showDevelopmentChartView();
                                    const chartControls = document.getElementById('development-chart-controls');
                                    if (chartControls) chartControls.style.display = 'block';
                                    const chartHeader = document.getElementById('dev-comparison-chart-header');
                                    if (chartHeader) chartHeader.style.display = 'block';
                                    if (payload.series_id) {
                                        const type = String(payload.series_id);
                                        if (type === 'sales' || type === 'price' || type === 'price_per_sqft') {
                                            switchDevelopmentChart(type);
                                        }
                                    }
                                    rendered = true;
                                }
                            }
                        } else if (resp.status === 404) {
                            // Fallback to complete endpoint
                            rendered = await tryRenderFromComplete(slug);
                        }
                    } catch (e) {
                        // If endpoint missing, try fallback
                        rendered = await tryRenderFromComplete(slug);
                    }
                } catch (e) {
                    console.warn('Direct-render from saved neighbourhood comparison skipped:', e);
                }

                // 2) Prepare controls lazily for edits
                await loadDevelopmentsList();
                createSelectionModeToggle();
                populateInitialDevelopmentDropdowns();
                if (selectionMode === 'development') {
                    setTimeout(() => { try { autoSelectReportDevelopment(); } catch {} }, 0);
                }
                setupDevelopmentComparisonEventHandlers();
            } catch (error) {
                console.error('Error initializing development comparison:', error);
            }
        }

        // Load available developments
        async function loadDevelopmentsList() {
            try {
                const response = await fetch(`${API_BASE}/developments`);
                if (!response.ok) {
                    throw new Error(`Failed to load developments: ${response.status}`);
                }
                const result = await response.json();
                
                // Handle different response structures
                if (result && result.success && result.data) {
                    developmentsList = result.data;
                } else if (Array.isArray(result)) {
                    developmentsList = result;
                } else {
                    developmentsList = [];
                }
                
                console.log('Loaded developments:', developmentsList ? developmentsList.length : 0);
            } catch (error) {
                console.error('Error loading developments:', error);
                developmentsList = [];
            }
        }

        // Load available zones
        async function loadZonesList() {
            try {
                const response = await fetch(`${API_BASE}/zones`);
                if (!response.ok) {
                    throw new Error(`Failed to load zones: ${response.status}`);
                }
                const result = await response.json();

                if (result && result.success && result.data) {
                    zonesList = result.data;
                } else if (Array.isArray(result)) {
                    zonesList = result;
                } else {
                    zonesList = [];
                }

                console.log('Loaded zones:', zonesList ? zonesList.length : 0);
            } catch (error) {
                console.error('Error loading zones:', error);
                zonesList = [];
            }
        }

        // Create Development/Zone toggle UI
        function createSelectionModeToggle() {
            const controls = document.getElementById('dev-controls-section');
            const container = document.getElementById('development-selections');
            if (!controls && !container) return;

            // Avoid duplicate creation
            if (document.getElementById('selection-mode-toggle')) return;

            const host = controls || container.parentElement;
            const toggleWrap = document.createElement('div');
            toggleWrap.id = 'selection-mode-toggle';
            toggleWrap.style.display = 'flex';
            toggleWrap.style.alignItems = 'center';
            toggleWrap.style.gap = '10px';
            toggleWrap.style.marginBottom = '12px';

            const label = document.createElement('div');
            label.textContent = 'Compare by:';
            label.style.fontWeight = '600';

            const btnGroup = document.createElement('div');
            btnGroup.style.display = 'inline-flex';
            btnGroup.style.border = '1px solid #ced4da';
            btnGroup.style.borderRadius = '6px';
            btnGroup.style.overflow = 'hidden';

            function makeButton(text, mode) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = text;
                btn.style.padding = '6px 10px';
                btn.style.fontSize = '12px';
                btn.style.border = 'none';
                btn.style.cursor = 'pointer';
                btn.style.background = (selectionMode === mode) ? '#0d6efd' : '#ffffff';
                btn.style.color = (selectionMode === mode) ? '#ffffff' : '#333333';
                btn.addEventListener('click', async () => {
                    if (selectionMode === mode) return;
                    selectionMode = mode;
                    // Update visual state
                    devBtn.style.background = (selectionMode === 'development') ? '#0d6efd' : '#ffffff';
                    devBtn.style.color = (selectionMode === 'development') ? '#ffffff' : '#333333';
                    zoneBtn.style.background = (selectionMode === 'zone') ? '#0d6efd' : '#ffffff';
                    zoneBtn.style.color = (selectionMode === 'zone') ? '#ffffff' : '#333333';

                    // Ensure data is loaded
                    if (selectionMode === 'zone' && zonesList.length === 0) {
                        await loadZonesList();
                    }

                    // Reset UI for current mode
                    resetDevelopmentComparison();

                    // Update any static labels/titles to match mode
                    updateDevZoneStaticLabels();
                });
                return btn;
            }

            const devBtn = makeButton('Development', 'development');
            const zoneBtn = makeButton('Zone', 'zone');

            btnGroup.appendChild(devBtn);
            btnGroup.appendChild(zoneBtn);

            toggleWrap.appendChild(label);
            toggleWrap.appendChild(btnGroup);

            // Insert above the selections container
            if (controls) {
                controls.insertBefore(toggleWrap, controls.firstChild);
            } else if (container && container.parentElement) {
                container.parentElement.insertBefore(toggleWrap, container);
            }
        }

        // Update static labels and button text between Development and Zone
        function updateDevZoneStaticLabels() {
            const noun = (selectionMode === 'development') ? 'Development' : 'Zone';
            const nounPlural = (selectionMode === 'development') ? 'developments' : 'zones';

            const compTitle = document.getElementById('dev-comp-title');
            if (compTitle) compTitle.textContent = `${noun} Comparison Analysis`;

            const controlsTitle = document.getElementById('dev-controls-title');
            if (controlsTitle) controlsTitle.textContent = `${noun} Comparison Analysis`;

            const addBtn = document.getElementById('add-development-btn');
            if (addBtn) addBtn.textContent = `Add ${noun}`;

            const removeBtn = document.getElementById('remove-development-btn');
            if (removeBtn) removeBtn.textContent = `Remove ${noun}`;

            const chartHeaderTitle = document.getElementById('dev-chart-title');
            if (chartHeaderTitle) chartHeaderTitle.textContent = `${noun} Sales Comparison`;

            const chartHeaderSubtitle = document.getElementById('dev-chart-subtitle');
            if (chartHeaderSubtitle) chartHeaderSubtitle.textContent = `Comparative analysis of sales volume and pricing across selected ${nounPlural}`;

            const loadingText = document.getElementById('dev-chart-loading-text');
            if (loadingText) loadingText.textContent = `Generating ${noun.toLowerCase()} comparison analysis...`;
        }

        // Populate initial development dropdowns
        function populateInitialDevelopmentDropdowns() {
            // Create the first development selection
            const container = document.getElementById('development-selections');
            if (container) {
                const selectionDiv = document.createElement('div');
                selectionDiv.className = 'location-selection';
                selectionDiv.id = `development-selection-1`;
                
                selectionDiv.innerHTML = `
                    <div class="location-row">
                        <div class="location-field">
                            <label for="development-select-1">${selectionMode === 'development' ? 'Development' : 'Zone'} 1</label>
                            <select id="development-select-1" class="fred-select">
                                <option value="">Select ${selectionMode === 'development' ? 'Development' : 'Zone'}...</option>
                            </select>
                        </div>
                    </div>
                `;
                
                container.appendChild(selectionDiv);
                
                // Populate the dropdown
                const developmentSelect = document.getElementById('development-select-1');
                if (developmentSelect) {
                    populateDevelopmentDropdown(developmentSelect);
                }
            }
        }

        // Populate a single development dropdown
        function populateDevelopmentDropdown(selectElement) {
            if (!selectElement) return;
            
            // Clear existing options
            selectElement.innerHTML = `<option value="">Select ${selectionMode === 'development' ? 'Development' : 'Zone'}...</option>`;
            
            // Add development options
            const list = selectionMode === 'development' ? developmentsList : zonesList;
            if (list && Array.isArray(list)) {
                list.forEach(item => {
                    const name = item.development_name || item.zone_name || item.name || item.Development || item.Zone;
                    if (!name) return;
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    selectElement.appendChild(option);
                });
            } else {
                console.warn('No options available to populate dropdown for mode:', selectionMode);
            }
        }

        // Auto-select the development from the report's property address
        function autoSelectReportDevelopment() {
            try {
                // Get the current report's development name
                const reportData = getCurrentReportData();
                if (!reportData || !reportData.development) {
                    console.log('No development found in report data for auto-selection');
                    return;
                }

                const reportDevelopment = reportData.development.trim();
                console.log('Attempting to auto-select development:', reportDevelopment);

                // Find the first development dropdown
                const firstDropdown = document.getElementById('development-select-1');
                if (!firstDropdown) {
                    console.warn('First development dropdown not found');
                    return;
                }

                // Look for exact match or partial match
                let matchFound = false;
                for (let i = 0; i < firstDropdown.options.length; i++) {
                    const option = firstDropdown.options[i];
                    if (option.value === reportDevelopment) {
                        // Exact match
                        firstDropdown.selectedIndex = i;
                        matchFound = true;
                        console.log('Exact match found and selected:', reportDevelopment);
                        break;
                    }
                }

                // If no exact match, try partial match
                if (!matchFound) {
                    for (let i = 0; i < firstDropdown.options.length; i++) {
                        const option = firstDropdown.options[i];
                        if (option.value && (
                            option.value.toLowerCase().includes(reportDevelopment.toLowerCase()) ||
                            reportDevelopment.toLowerCase().includes(option.value.toLowerCase())
                        )) {
                            firstDropdown.selectedIndex = i;
                            matchFound = true;
                            console.log('Partial match found and selected:', option.value, 'for report development:', reportDevelopment);
                            break;
                        }
                    }
                }

                if (!matchFound) {
                    console.log('No matching development found in dropdown for:', reportDevelopment);
                }

            } catch (error) {
                console.error('Error auto-selecting report development:', error);
            }
        }

        // Setup event handlers for development comparison
        function setupDevelopmentComparisonEventHandlers() {
            // Add development button
            const addDevelopmentBtn = document.getElementById('add-development-btn');
            if (addDevelopmentBtn) {
                addDevelopmentBtn.addEventListener('click', addDevelopmentSelection);
            }

            // Remove development button
            const removeDevelopmentBtn = document.getElementById('remove-development-btn');
            if (removeDevelopmentBtn) {
                removeDevelopmentBtn.addEventListener('click', () => {
                    // Remove the last development selection
                    const container = document.getElementById('development-selections');
                    if (container && container.children.length > 1) {
                        const lastChild = container.lastElementChild;
                        lastChild.remove();
                        updateDevelopmentButtons();
                    }
                });
            }

            // Reset button
            const resetDevelopmentBtn = document.getElementById('reset-development-comparison-btn');
            if (resetDevelopmentBtn) {
                resetDevelopmentBtn.addEventListener('click', resetDevelopmentComparison);
            }

            // Generate comparison button
            const generateDevelopmentBtn = document.getElementById('compare-developments-btn');
            if (generateDevelopmentBtn) {
                generateDevelopmentBtn.addEventListener('click', generateDevelopmentComparison);
            }

            // Back to controls button
            const backToDevControlsBtn = document.getElementById('back-to-dev-controls-btn');
            if (backToDevControlsBtn) {
                backToDevControlsBtn.addEventListener('click', showDevelopmentControlsView);
            }

            // Handle chart type dropdown changes
            const chartTypeSelect = document.getElementById('development-chart-type-select');
            if (chartTypeSelect) {
                chartTypeSelect.addEventListener('change', (e) => switchDevelopmentChart(e.target.value));
            }
        }

        // Add new development selection
        function addDevelopmentSelection() {
            developmentSelectionCount++;
            const container = document.getElementById('development-selections');
            
            const selectionDiv = document.createElement('div');
            selectionDiv.className = 'location-selection';
            selectionDiv.id = `development-selection-${developmentSelectionCount}`;
            
            selectionDiv.innerHTML = `
                <div class="location-row">
                    <div class="location-field">
                        <label for="development-select-${developmentSelectionCount}">${selectionMode === 'development' ? 'Development' : 'Zone'} ${developmentSelectionCount}</label>
                        <select id="development-select-${developmentSelectionCount}" class="fred-select">
                            <option value="">Select ${selectionMode === 'development' ? 'Development' : 'Zone'}...</option>
                        </select>
                    </div>
                    <button type="button" class="remove-location-btn" onclick="removeDevelopmentSelection(${developmentSelectionCount})" style="margin-left: 10px;">
                        Remove
                    </button>
                </div>
            `;
            
            container.appendChild(selectionDiv);
            
            // Populate the new dropdown
            const newSelect = document.getElementById(`development-select-${developmentSelectionCount}`);
            populateDevelopmentDropdown(newSelect);
            
            // Update button visibility
            updateDevelopmentButtons();
        }

        // Remove development selection
        function removeDevelopmentSelection(selectionId) {
            const selectionDiv = document.getElementById(`development-selection-${selectionId}`);
            if (selectionDiv) {
                selectionDiv.remove();
            }
            
            // Update button visibility
            updateDevelopmentButtons();
        }

        // Update development button visibility
        function updateDevelopmentButtons() {
            const addBtn = document.getElementById('add-development-btn');
            const removeBtn = document.getElementById('remove-development-btn');
            const container = document.getElementById('development-selections');
            const currentSelections = container ? container.children.length : 0;
            
            if (addBtn) {
                addBtn.style.display = currentSelections >= 10 ? 'none' : 'inline-block';
            }
            if (removeBtn) {
                removeBtn.style.display = currentSelections <= 1 ? 'none' : 'inline-block';
            }
        }

        // Reset development comparison to default
        function resetDevelopmentComparison() {
            developmentSelectionCount = 1;
            const container = document.getElementById('development-selections');
            
            // Clear all selections
            if (container) {
                container.innerHTML = '';
            }
            
            // Recreate the first selection
            populateInitialDevelopmentDropdowns();
            updateDevelopmentButtons();

            // Also update static labels to current mode
            updateDevZoneStaticLabels();
            
            // Clear any existing chart and hide chart view
            if (window.developmentChart) {
                window.developmentChart.destroy();
                window.developmentChart = null;
            }
            
            // Clear stored data
            window.developmentComparisonData = null;
            window.selectedDevelopments = null;
            
            // Hide chart elements
            const chartControls = document.getElementById('development-chart-controls');
            if (chartControls) chartControls.style.display = 'none';
            
            const chartHeader = document.getElementById('dev-comparison-chart-header');
            if (chartHeader) chartHeader.style.display = 'none';
            
            // Show controls view
            showDevelopmentControlsView();
        }

        // Generate development comparison
        async function generateDevelopmentComparison() {
            // Collect all selected developments
            const selections = [];
            let hasValidSelections = false;
            
            for (let i = 1; i <= developmentSelectionCount; i++) {
                const developmentSelect = document.getElementById(`development-select-${i}`);
                
                if (developmentSelect && developmentSelect.value) {
                    selections.push(developmentSelect.value);
                    hasValidSelections = true;
                }
            }
            
            if (!hasValidSelections) {
                alert(`Please select at least one ${selectionMode === 'development' ? 'development' : 'zone'} to compare`);
                return;
            }
            
            // Show loading state
            const loadingDiv = document.getElementById('dev-chart-loading');
            const errorDiv = document.getElementById('dev-chart-error');
            const chartContainer = document.getElementById('dev-comparison-chart');
            
            if (loadingDiv) loadingDiv.style.display = 'flex';
            if (errorDiv) errorDiv.style.display = 'none';
            if (chartContainer) chartContainer.innerHTML = '';
            
            try {
                // Fetch comparison data - send as comma-separated string
                const param = selections.join(',');
                const url = selectionMode === 'development'
                    ? `${API_BASE}/developments-comparison?developments=${encodeURIComponent(param)}`
                    : `${API_BASE}/zones-comparison?zones=${encodeURIComponent(param)}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch comparison data: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Development comparison data:', result);
                
                // Extract the actual data array from the response
                let data;
                if (result.success && result.data && result.data.comparisonData) {
                    data = result.data.comparisonData;
                } else if (result.success && result.data) {
                    data = result.data;
                } else if (Array.isArray(result)) {
                    data = result;
                } else {
                    data = [];
                }
                
                // Process and display the data
                displayDevelopmentComparisonChart(data, selections);
                
                // Switch to chart view and show chart elements
                showDevelopmentChartView();
                
                // Show chart controls
                const chartControls = document.getElementById('development-chart-controls');
                if (chartControls) {
                    chartControls.style.display = 'block';
                }
                
                // Show chart header
                const chartHeader = document.getElementById('dev-comparison-chart-header');
                if (chartHeader) {
                    chartHeader.style.display = 'block';
                }

                // Non-blocking save to DB (neighbourhood)
                try {
                    const slug = (typeof urlSlug !== 'undefined') ? urlSlug : (window.location.pathname.split('/').pop());
                    const seriesIdToSave = (typeof currentDevelopmentChart === 'string' && currentDevelopmentChart) ? currentDevelopmentChart : 'sales';
                    await fetch(`${API_BASE}/reports/${slug}/neighbourhood-comparison`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ seriesId: seriesIdToSave, names: selections })
                    });
                } catch (persistErr) {
                    console.warn('Neighbourhood save failed:', persistErr);
                }
                
            } catch (error) {
                console.error('Error generating development comparison:', error);
                if (errorDiv) {
                    errorDiv.style.display = 'block';
                    errorDiv.innerHTML = `
                        <p>Failed to generate comparison chart</p>
                        <p class="error-details">${error.message}</p>
                    `;
                }
            } finally {
                if (loadingDiv) loadingDiv.style.display = 'none';
            }
        }

        // Global variable to store chart data
        let developmentChartData = null;
        let currentDevelopmentChart = 'sales';

        // Display development comparison chart
        function displayDevelopmentComparisonChart(data, developments) {
            console.log('displayDevelopmentComparisonChart called with:', { data, developments });
            developmentChartData = data;
            
            // Process data by development and year
            const processedData = {};
            
            data.forEach(row => {
                const dev = row.development_name || row.zone_name || row.name;
                const year = row.sale_year || row.year; // Support both field names
                
                if (!processedData[dev]) {
                    processedData[dev] = {};
                }
                
                // Calculate price per square foot if both price and sqft are available
                const avgPrice = parseFloat(row.avg_price ?? row.average_price) || 0;
                const avgSqft = parseFloat(row.avg_sqft ?? row.average_sqft) || 0;
                const pricePerSqft = avgSqft > 0 ? avgPrice / avgSqft : 0;
                
                // Debug: Log data availability for first few rows
                if (Object.keys(processedData).length <= 2) {
                    console.log(`Data for ${dev} (${year}):`, {
                        avg_price: avgPrice,
                        avg_sqft: avgSqft,
                        calculated_price_per_sqft: pricePerSqft,
                        raw_row: row
                    });
                }
                
                processedData[dev][year] = {
                    sales_count: parseInt(row.sales_count) || 0,
                    avg_price: avgPrice,
                    avg_price_per_sqft: pricePerSqft
                };
            });
            
            console.log('Processed data:', processedData);
            
            // Store processed data globally
            window.developmentComparisonData = processedData;
            window.selectedDevelopments = developments;
            
            // Check if we have any price per sqft data available
            let hasPricePerSqftData = false;
            Object.values(processedData).forEach(devData => {
                Object.values(devData).forEach(yearData => {
                    if (yearData.avg_price_per_sqft > 0) {
                        hasPricePerSqftData = true;
                    }
                });
            });
            
            // Store data availability for UI decisions
            window.hasPricePerSqftData = hasPricePerSqftData;
            
            // Update dropdown options based on data availability
            updateChartTypeDropdown();
            
            // Display initial chart (sales)
            console.log('About to call renderDevelopmentChart');
            renderDevelopmentChart('sales');
        }

        // Global Chart.js instance
        let developmentChart = null;

        // Render development chart based on type using Chart.js
        function renderDevelopmentChart(chartType) {
            console.log('renderDevelopmentChart called with chartType:', chartType);
            const chartCanvas = document.getElementById('dev-comparison-chart');
            console.log('Chart canvas found:', !!chartCanvas);
            console.log('Development comparison data exists:', !!window.developmentComparisonData);
            
            if (!chartCanvas || !window.developmentComparisonData) {
                console.log('Early return - missing canvas or data');
                return;
            }
            
            const data = window.developmentComparisonData;
            const developments = window.selectedDevelopments;
            console.log('About to process chart with data:', data, 'developments:', developments);
            
            // Get all years across all developments
            const allYears = new Set();
            Object.values(data).forEach(devData => {
                Object.keys(devData).forEach(year => allYears.add(parseInt(year)));
            });
            const years = Array.from(allYears).sort((a, b) => a - b);
            console.log('Years found:', years);
            
            // Destroy existing chart if it exists
            if (developmentChart) {
                developmentChart.destroy();
            }
            
            // Determine data key and formatting
            let dataKey, yAxisLabel;
            if (chartType === 'sales') {
                dataKey = 'sales_count';
                yAxisLabel = 'Number of Sales';
            } else if (chartType === 'price') {
                dataKey = 'avg_price';
                yAxisLabel = 'Average Sale Price';
            } else if (chartType === 'price_per_sqft') {
                dataKey = 'avg_price_per_sqft';
                yAxisLabel = 'Average Price Per Square Foot';
            }
            
            // Prepare datasets for Chart.js
            const datasets = developments.map((dev, index) => {
                const developmentData = years.map(year => {
                    const yearData = data[dev] && data[dev][year] ? data[dev][year][dataKey] : 0;
                    // For price per sqft, only show data points where we have valid calculations
                    if (chartType === 'price_per_sqft' && yearData === 0) {
                        return null; // This will create gaps in the chart for missing data
                    }
                    return yearData;
                });
                
                // Use distinct colors for each development
                const colors = [
                    '#3498db', // Blue
                    '#e74c3c', // Red
                    '#2ecc71', // Green
                    '#f39c12', // Orange
                    '#9b59b6', // Purple
                    '#1abc9c', // Teal
                    '#34495e', // Dark Gray
                    '#e67e22', // Dark Orange
                    '#95a5a6', // Gray
                    '#8e44ad'  // Dark Purple
                ];
                
                return {
                    label: dev,
                    data: developmentData,
                    backgroundColor: colors[index % colors.length] + '20', // 20% opacity for fill
                    borderColor: colors[index % colors.length],
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointBackgroundColor: colors[index % colors.length],
                    pointBorderColor: '#ffffff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointHoverBackgroundColor: colors[index % colors.length],
                    pointHoverBorderColor: '#ffffff'
                };
            });
            
            // Create Chart.js configuration
            const config = {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${selectionMode === 'development' ? 'Development' : 'Zone'} Trends - ${yAxisLabel}`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            onClick: function(e, legendItem, legend) {
                                console.log('Legend onClick triggered:', { e, legendItem, legend });
                                // Suppress the next document click to avoid immediate close
                                __suppressNextDocumentClick = true;
                                // Prevent default legend click behavior (toggling dataset visibility)
                                if (e && e.stopPropagation) {
                                    e.stopPropagation();
                                }
                                // Get the series name and strip icon if present
                                let seriesName = legendItem.text || legendItem.label || 'Unknown';
                                seriesName = String(seriesName).replace(/^üîó\s*/, '');
                                // Always show popup. The popup will adapt to mode (development vs zone)
                                showDevelopmentActionsPopupFromChart(e, seriesName, legend.chart.canvas);
                                return false;
                            },
                            labels: {
                                generateLabels: function(chart) {
                                    const original = Chart.defaults.plugins.legend.labels.generateLabels;
                                    const labels = original.call(this, chart);
                                    
                                    // Make legend items look clickable
                                    labels.forEach(label => {
                                        label.text = 'üîó ' + label.text; // Add link icon
                                    });
                                    
                                    return labels;
                                },
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    weight: '500'
                                }
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#ffffff',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    let formattedValue;
                                    if (chartType === 'sales') {
                                        formattedValue = value.toLocaleString() + ' sales';
                                    } else if (chartType === 'price') {
                                        formattedValue = '$' + value.toLocaleString();
                                    } else if (chartType === 'price_per_sqft') {
                                        formattedValue = '$' + value.toFixed(0) + '/sqft';
                                    }
                                    return `${context.dataset.label}: ${formattedValue}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            },
                            grid: {
                                display: true,
                                color: '#f0f0f0',
                                borderDash: [2, 2]
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yAxisLabel
                            },
                            beginAtZero: true,
                            grid: {
                                display: true,
                                color: '#f0f0f0',
                                borderDash: [2, 2]
                            },
                            ticks: {
                                callback: function(value) {
                                    if (chartType === 'sales') {
                                        return value.toLocaleString();
                                    } else if (chartType === 'price') {
                                        return '$' + (value / 1000).toFixed(0) + 'K';
                                    } else if (chartType === 'price_per_sqft') {
                                        return '$' + value.toFixed(0);
                                    }
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            };
            
            // Create the chart
            const ctx = chartCanvas.getContext('2d');
            developmentChart = new Chart(ctx, config);
            
            console.log('Chart.js chart created successfully');
        }

        // Show the development actions popup from chart legend click
        function showDevelopmentActionsPopupFromChart(event, developmentName, canvas) {
            console.log('Chart legend clicked:', { event, developmentName, canvas });
            
            // Get the actual mouse/click coordinates relative to viewport (for fixed positioning)
            const rect = canvas.getBoundingClientRect();
            let x, y;
            
            // Try different ways to get coordinates depending on the event
            if (event && event.native) {
                // Chart.js provides native event - use client coordinates for fixed positioning
                x = (typeof event.native.clientX === 'number') ? event.native.clientX : (rect.left + (event.native.offsetX || rect.width / 2));
                y = (typeof event.native.clientY === 'number') ? event.native.clientY : (rect.top + (event.native.offsetY || 50));
            } else if (event && typeof event.clientX === 'number' && typeof event.clientY === 'number') {
                // Direct client coordinates (viewport relative)
                x = event.clientX;
                y = event.clientY;
            } else if (event && typeof event.pageX === 'number' && typeof event.pageY === 'number') {
                // Convert page coordinates to client coordinates
                x = event.pageX - window.pageXOffset;
                y = event.pageY - window.pageYOffset;
            } else {
                // Fallback - center of canvas with offset (viewport relative)
                // If we have a tracked last mouse position, prefer that
                if (window.__lastMouse && typeof window.__lastMouse.x === 'number' && typeof window.__lastMouse.y === 'number') {
                    x = window.__lastMouse.x;
                    y = window.__lastMouse.y;
                } else {
                    x = rect.left + rect.width / 2;
                    y = rect.top + 50; // Near top of canvas
                }
            }
            
            console.log('Calculated popup position (viewport relative):', { x, y });
            
            // Show popup with calculated coordinates (using clientX/Y instead of pageX/Y)
            showDevelopmentActionsPopup({ clientX: x + 10, clientY: y - 50 }, developmentName);
        }
        
        // Show the development actions popup
        function showDevelopmentActionsPopup(event, developmentName) {
            console.log('showDevelopmentActionsPopup called:', { event, developmentName });
            
            // Remove the link emoji from the development name if it exists
            const cleanDevelopmentName = String(developmentName || '').replace(/^üîó\s*/, '').trim();
            console.log('Clean development name:', cleanDevelopmentName);
            
            const popup = document.getElementById('developmentActionsPopup');
            const title = document.getElementById('developmentPopupTitle');
            const mapBtn = document.getElementById('developmentPopupMapBtn');
            const chartBtn = document.getElementById('developmentPopupChartBtn');
            
            console.log('Popup elements found:', { popup: !!popup, title: !!title, mapBtn: !!mapBtn, chartBtn: !!chartBtn });
            
            if (!popup || !title || !mapBtn || !chartBtn) {
                console.error('Missing popup elements');
                return;
            }
            
            // Set the development name
            title.textContent = cleanDevelopmentName;

            // Always show Map button (works for Development and Zone)
            try {
                mapBtn.style.display = 'flex';
            } catch (err) {
                console.warn('Error adjusting Map button visibility:', err);
            }
            
            // Position the popup near the mouse click (use clientX/Y for fixed positioning)
            let x = (typeof event.clientX === 'number' ? event.clientX : (typeof event.pageX === 'number' ? (event.pageX - window.pageXOffset) : (window.__lastMouse ? window.__lastMouse.x : 200))) + 10; // Default to 200 if no coordinates
            let y = (typeof event.clientY === 'number' ? event.clientY : (typeof event.pageY === 'number' ? (event.pageY - window.pageYOffset) : (window.__lastMouse ? window.__lastMouse.y : 200))) - 50; // Default to 200 if no coordinates
            
            // For debugging: always show at a visible location
            if (x < 50 || y < 50) {
                console.log('Using fallback position due to invalid coordinates');
                x = 200;
                y = 200;
            }
            
            // Ensure popup stays within viewport boundaries
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const popupWidth = 180; // Approximate popup width
            const popupHeight = 120; // Approximate popup height
            
            if (x + popupWidth > viewportWidth) {
                x = viewportWidth - popupWidth - 10;
            }
            if (y < 0) {
                y = 10;
            }
            if (y + popupHeight > viewportHeight) {
                y = viewportHeight - popupHeight - 10;
            }
            
            console.log('Final popup position:', { x, y });
            
            popup.style.left = Math.round(x) + 'px';
            popup.style.top = Math.round(y) + 'px';
            popup.style.display = 'block';
            popup.style.position = 'fixed';
            popup.style.zIndex = '9999';
            
            console.log('Popup should now be visible at:', popup.style.left, popup.style.top);
            
            // Debug: Check computed styles
            const computedStyle = window.getComputedStyle(popup);
            console.log('Popup computed styles:', {
                display: computedStyle.display,
                position: computedStyle.position,
                zIndex: computedStyle.zIndex,
                left: computedStyle.left,
                top: computedStyle.top,
                visibility: computedStyle.visibility,
                opacity: computedStyle.opacity
            });
            
            // Debug: Check if popup is actually in the DOM
            console.log('Popup in DOM:', document.contains(popup));
            console.log('Popup dimensions:', {
                offsetWidth: popup.offsetWidth,
                offsetHeight: popup.offsetHeight,
                clientWidth: popup.clientWidth,
                clientHeight: popup.clientHeight
            });
            
            // Add event listeners for the buttons
            mapBtn.onclick = function() {
                hideDevelopmentActionsPopup();
                openDevelopmentMapForName(cleanDevelopmentName);
            };
            
            chartBtn.onclick = function() {
                hideDevelopmentActionsPopup();
                showChartOverlay(cleanDevelopmentName);
            };
            
            // Add hover effects
            [mapBtn, chartBtn].forEach(btn => {
                btn.onmouseenter = function() {
                    this.style.backgroundColor = '#f8f9fa';
                    this.style.transform = 'translateY(-1px)';
                };
                
                btn.onmouseleave = function() {
                    this.style.backgroundColor = '#ffffff';
                    this.style.transform = 'translateY(0)';
                };
            });
        }
        
        // Hide the development actions popup
        function hideDevelopmentActionsPopup() {
            const popup = document.getElementById('developmentActionsPopup');
            popup.style.display = 'none';
        }
        
        // Open development map for a specific development name
        async function openDevelopmentMapForName(developmentName) {
            const modal = document.getElementById('mapModal');
            const loading = document.getElementById('mapLoading');
            const error = document.getElementById('mapError');
            const subtitle = document.getElementById('mapSubtitle');
            const title = document.getElementById('mapTitle');
            const loadingText = document.getElementById('mapLoadingText');
            const errorContext = document.getElementById('mapErrorContext');
            
            if (!developmentName || !developmentName.trim()) {
                showMapError('No development name provided.');
                return;
            }
            
            const cleanDevelopmentName = developmentName.trim();
            const inZoneMode = (typeof selectionMode !== 'undefined' && selectionMode === 'zone');
            title.textContent = inZoneMode ? 'Zone Parcels Map' : 'Development Parcels Map';
            subtitle.textContent = `Showing parcels for ${cleanDevelopmentName}`;
            loadingText.textContent = inZoneMode ? 'Loading zone parcels...' : 'Loading development parcels...';
            errorContext.textContent = inZoneMode ? 'Could not load parcel data for this zone.' : 'Could not load parcel data for this development.';
            
            // Show modal and loading state
            modal.style.display = 'block';
            loading.style.display = 'flex';
            error.style.display = 'none';
            
            try {
                // Fetch parcel data
                const url = inZoneMode
                    ? `${API_BASE}/zone-parcels/${encodeURIComponent(cleanDevelopmentName)}`
                    : `${API_BASE}/development-parcels/${encodeURIComponent(cleanDevelopmentName)}`;
                const response = await fetch(url);
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Failed to load parcel data');
                }
                
                if (!result.data || !result.data.features || result.data.features.length === 0) {
                    throw new Error(inZoneMode ? 'No parcel data found for this zone' : 'No parcel data found for this development');
                }
                
                // Hide loading
                loading.style.display = 'none';
                
                // Initialize or update map with the new development
                currentDevelopmentName = cleanDevelopmentName;
                initializeMap(result.data);
                
            } catch (error) {
                console.error('Error loading development map:', error);
                showMapError(error.message || 'Unable to load map data for this development.');
            }
        }

        // Update chart type dropdown based on data availability
        function updateChartTypeDropdown() {
            const chartTypeSelect = document.getElementById('development-chart-type-select');
            if (!chartTypeSelect) return;
            
            const pricePerSqftOption = chartTypeSelect.querySelector('option[value="price_per_sqft"]');
            if (pricePerSqftOption) {
                if (window.hasPricePerSqftData) {
                    pricePerSqftOption.disabled = false;
                    pricePerSqftOption.style.color = '';
                } else {
                    pricePerSqftOption.disabled = true;
                    pricePerSqftOption.style.color = '#999';
                    pricePerSqftOption.textContent = 'Price Per Square Foot (No Data Available)';
                }
            }
        }

        // Switch between chart types
        function switchDevelopmentChart(chartType) {
            // If trying to switch to price_per_sqft but no data available, fall back to sales
            if (chartType === 'price_per_sqft' && !window.hasPricePerSqftData) {
                console.warn('Price per sqft data not available, falling back to sales chart');
                chartType = 'sales';
            }
            
            currentDevelopmentChart = chartType;
            
            // Update dropdown selection
            const chartTypeSelect = document.getElementById('development-chart-type-select');
            if (chartTypeSelect && chartTypeSelect.value !== chartType) {
                chartTypeSelect.value = chartType;
            }
            
            // Render the appropriate chart
            renderDevelopmentChart(chartType);
        }

        // Show the development controls view and hide the chart view
        function showDevelopmentControlsView() {
            document.getElementById('dev-controls-section').style.display = 'block';
            document.getElementById('dev-chart-section').style.display = 'none';

            // Restore current selections (if any) instead of defaulting to one
            try {
                const current = (typeof window !== 'undefined') ? window.selectedDevelopments : null;
                const list = Array.isArray(current) ? current.filter(Boolean) : [];
                if (list.length > 0) {
                    const container = document.getElementById('development-selections');
                    if (container) container.innerHTML = '';
                    // Recreate the exact number of selects
                    developmentSelectionCount = list.length;
                    // First one
                    populateInitialDevelopmentDropdowns();
                    // Additional ones
                    for (let i = 2; i <= developmentSelectionCount; i++) {
                        addDevelopmentSelection();
                    }
                    // Preselect values (using chunked population auto-select via data-preselect)
                    list.forEach((name, idx) => {
                        const selectEl = document.getElementById(`development-select-${idx + 1}`);
                        if (selectEl) {
                            selectEl.dataset.preselect = String(name);
                            // Ensure options are populated (chunked)
                            populateDevelopmentDropdown(selectEl);
                        }
                    });
                    updateDevelopmentButtons();
                }
            } catch (e) {
                console.warn('Failed to restore development selections on back:', e);
            }
        }
        
        // Show the development chart view and hide the controls view  
        function showDevelopmentChartView() {
            document.getElementById('dev-controls-section').style.display = 'none';
            document.getElementById('dev-chart-section').style.display = 'block';
        }

        // Initialize development comparison when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeDevelopmentComparison, 1500);
        });
    </script>

    <!-- Map Modal -->
    <div id="mapModal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        overflow: hidden;
    ">
        <div style="
            position: relative;
            width: 95%;
            height: 95%;
            margin: 2.5% auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        ">
            <!-- Modal Header -->
            <div style="
                padding: 20px 30px;
                border-bottom: 1px solid #e9ecef;
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: #f8f9fa;
                border-radius: 12px 12px 0 0;
            ">
                <div>
                    <h2 id="mapTitle" style="margin: 0; color: #2c3e50; font-size: 24px; font-weight: 600;">Development Parcels Map</h2>
                    <p style="margin: 5px 0 0; color: #6c757d; font-size: 14px;" id="mapSubtitle">Loading development data...</p>
                </div>
                <button id="closeMapModal" style="
                    background: none;
                    border: none;
                    font-size: 28px;
                    color: #6c757d;
                    cursor: pointer;
                    padding: 0;
                    width: 40px;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 8px;
                    transition: all 0.2s ease;
                " onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='none'">
                    √ó
                </button>
            </div>

            <!-- Map Container -->
            <div style="flex: 1; position: relative; overflow: hidden;">
                <div id="developmentMap" style="width: 100%; height: 100%;"></div>
                
                <!-- Loading Overlay -->
                <div id="mapLoading" style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(255, 255, 255, 0.9);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                ">
                    <div style="text-align: center;">
                        <div style="
                            border: 4px solid #f3f3f3;
                            border-top: 4px solid #3498db;
                            border-radius: 50%;
                            width: 50px;
                            height: 50px;
                            animation: spin 1s linear infinite;
                            margin: 0 auto 20px;
                        "></div>
                        <p id="mapLoadingText" style="margin: 0; color: #2c3e50; font-size: 16px; font-weight: 500;">Loading development parcels...</p>
                    </div>
                </div>

                <!-- Error Message -->
                <div id="mapError" style="
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: white;
                    display: none;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                ">
                    <div style="text-align: center; max-width: 400px; padding: 40px;">
                        <div style="color: #e74c3c; font-size: 48px; margin-bottom: 20px;">üó∫Ô∏è</div>
                        <h3 style="margin: 0 0 15px; color: #2c3e50; font-size: 20px;">Unable to Load Map</h3>
                        <p style="margin: 0; color: #6c757d; font-size: 14px;" id="mapErrorMessage">
                            <span id="mapErrorContext">Could not load parcel data for this development.</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

