<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Area Analysis Report</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <div class="letterhead">
            <div class="header-info">
                <div class="header-item">
                    <div class="header-label">Prepared by</div>
                    <div class="header-value" id="agentName">Agent Name</div>
                </div>
                <div class="header-item">
                    <div class="header-label">Prepared for</div>
                    <div class="header-value" id="buyerName">Buyer Name</div>
                </div>
                <div class="header-item">
                    <div class="header-label">Zip</div>
                    <div class="header-value" id="zipCode">ZIP Code</div>
                </div>
            </div>
        </div>

        <div class="content">
            
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Loading comprehensive market analysis...</p>
            </div>

            <div id="error" class="error" style="display: none;">
                <h3>Analysis Not Found</h3>
                <p>The requested area analysis could not be located. Please verify the report URL.</p>
            </div>

            <div id="reportContent" style="display: none;">

                <div class="section">
                    <h2>Home Stats</h2>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">Property Value</div>
                                <div class="info-value">Estimated market value and comparable sales data</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Property Details</div>
                                <div class="info-value">Square footage, bedrooms, bathrooms, and lot size</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Market Trends</div>
                                <div class="info-value">Local market appreciation and sales velocity</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Neighborhood Stats</div>
                                <div class="info-value">Area demographics and community information</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Area Charts</h2>
                    <div class="section-content">
                        <div id="chartsContent">
                            <div class="info-item">
                                <div class="info-label">Market Data Visualization</div>
                                <div class="info-value">Interactive charts showing market trends and comparative analysis</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Areas of Interest</h2>
                    <div class="section-content">
                        <div id="interestAreasContent">
                            <div class="info-item">
                                <div class="info-label">Coverage Areas</div>
                                <div class="info-value">Market analysis encompasses primary and secondary coverage areas</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="confidential">
                    <div class="confidential-title">Confidential Information</div>
                    <div class="confidential-text">
                        This area analysis has been prepared exclusively for authorized personnel and contains confidential and proprietary information. 
                        Distribution, reproduction, or disclosure to third parties is strictly prohibited without written consent.
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-content">
                <p>Â© 2025 Professional Area Analysis Services. All rights reserved.</p>
                <p>This report contains confidential and proprietary information intended solely for authorized personnel.</p>
            </div>
        </div>
    </div>

    <script>
        // Get report identifier from URL (could be lastname-id format or just ID)
        const urlParams = new URLSearchParams(window.location.search);
        let urlSlug = urlParams.get('id');
        
        // If no query parameter, extract from path
        if (!urlSlug) {
            const pathParts = window.location.pathname.split('/');
            urlSlug = pathParts[pathParts.length - 1]; // Get last part of path
        }
        
        // If still no slug or it's empty, show error
        if (!urlSlug || urlSlug === 'report.html') {
            console.error('No report identifier found in URL');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }

        async function loadReport() {
            // Don't load if no URL slug
            if (!urlSlug || urlSlug === 'report.html') {
                return;
            }
            
            try {
                console.log('Loading report with slug:', urlSlug);
                const response = await fetch(`/api/reports/complete/${urlSlug}`);
                const result = await response.json();

                console.log('API Response:', { status: response.status, result });
                document.getElementById('loading').style.display = 'none';

                if (response.ok && result.success) {
                    displayReport(result.data);
                } else {
                    console.error('API Error:', result.error || 'Unknown error');
                    document.getElementById('error').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading report:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        function displayReport(data) {
            console.log('Displaying report data:', data);
            document.getElementById('reportContent').style.display = 'block';
            
            // Update header information
            document.getElementById('agentName').textContent = data.agent_name || 'Agent Name';
            document.getElementById('buyerName').textContent = `${data.first_name} ${data.last_name}` || 'Buyer Name';
            document.getElementById('zipCode').textContent = data.zip_code || 'ZIP Code';
            
            // Charts
            if (data.charts && data.charts.length > 0) {
                const chartsHtml = data.charts.map(chart => `
                    <div class="info-item">
                        <div class="info-label">Chart ${chart.chart_id}</div>
                        <div class="info-value">${chart.chart_type} - ${chart.stats_category}</div>
                    </div>
                `).join('');
                document.getElementById('chartsContent').innerHTML = `<div class="info-grid">${chartsHtml}</div>`;
            }
            
            // Interest areas
            if (data.interest_areas && data.interest_areas.length > 0) {
                const areasHtml = data.interest_areas.map(area => `
                    <div class="info-item">
                        <div class="info-label">Interest ${area.interest_id}</div>
                        <div class="info-value">${area.city}, ${area.state}</div>
                    </div>
                `).join('');
                document.getElementById('interestAreasContent').innerHTML = `<div class="info-grid">${areasHtml}</div>`;
            }
        }

        // Load report on page load
        loadReport();
    </script>
</body>
</html>
