<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Area Analysis Report</title>
    <link rel="stylesheet" href="/styles.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="letterhead">
            <div class="header-info">
                <div class="header-item">
                    <div class="header-label">Prepared by</div>
                    <div class="header-value" id="agentName">Agent Name</div>
                </div>
                <div class="header-item">
                    <div class="header-label">Prepared for</div>
                    <div class="header-value" id="buyerName">Buyer Name</div>
                </div>
                <div class="header-item">
                    <div class="header-label">Zip</div>
                    <div class="header-value" id="zipCode">ZIP Code</div>
                </div>
            </div>
        </div>

        <div class="content">
            
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Loading comprehensive market analysis...</p>
            </div>

            <div id="error" class="error" style="display: none;">
                <h3>Analysis Not Found</h3>
                <p>The requested area analysis could not be located. Please verify the report URL.</p>
            </div>

            <div id="reportContent" style="display: none;">

                <div class="section">
                    <h2>National Charts</h2>
                    <div class="section-content">
                        <div id="fredChartsContent" style="display: flex; gap: 20px; flex-wrap: wrap;">
                            <div class="chart-container" style="flex: 1; min-width: 300px; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h3 style="margin: 0; color: #333; font-size: 16px;" id="leftChartTitle">Housing Price Index</h3>
                                    <select id="leftChartSelect" style="padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">
                                        <option value="USSTHPI">Housing Price Index</option>
                                        <option value="GDP">GDP</option>
                                        <option value="CPIAUCSL">CPI</option>
                                        <option value="PPIACO">PPI</option>
                                        <option value="FEDFUNDS">Fed Funds Rate</option>
                                        <option value="MORTGAGE30US">30-Year Mortgage</option>
                                        <option value="MORTGAGE15US">15-Year Mortgage</option>
                                        <option value="RHVRUSQ156N">Vacancy Rate</option>
                                        <option value="LREM64TTUSM156S">Employment</option>
                                        <option value="POPTHM">Population</option>
                                        <option value="M2REAL">Money Stock</option>
                                        <option value="FPCPITOTLZGUSA">Inflation</option>
                                        <option value="GFDEBTN">Government Debt</option>
                                        <option value="DGS10">10-Year Treasury</option>
                                        <option value="DGS2">2-Year Treasury</option>
                                        <option value="ACTLISCOUUS">Active Listings</option>
                                        <option value="MSPUS">Median Sale Price</option>
                                        <option value="NEWLISCOUUS">New Listings</option>
                                        <option value="MEDDAYONMARUS">Median Days on Market</option>
                                        <option value="UNRATE">Unemployment Rate</option>
                                        <option value="DJIA">Dow Jones Industrial Average</option>
                                    </select>
                                </div>
                                <div id="leftChart" style="width: 100%; height: 300px; display: flex; align-items: center; justify-content: center; background-color: #f9f9f9; border-radius: 4px;">
                                    <div class="loading-spinner" style="text-align: center;">
                                        <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 0 auto;"></div>
                                        <p style="margin-top: 10px; color: #666;">Loading chart data...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="chart-container" style="flex: 1; min-width: 300px; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h3 style="margin: 0; color: #333; font-size: 16px;" id="rightChartTitle">Dow Jones Industrial Average</h3>
                                    <select id="rightChartSelect" style="padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px;">
                                        <option value="DJIA" selected>Dow Jones Industrial Average</option>
                                        <option value="GDP">GDP</option>
                                        <option value="USSTHPI">Housing Price Index</option>
                                        <option value="CPIAUCSL">CPI</option>
                                        <option value="PPIACO">PPI</option>
                                        <option value="FEDFUNDS">Fed Funds Rate</option>
                                        <option value="MORTGAGE30US">30-Year Mortgage</option>
                                        <option value="MORTGAGE15US">15-Year Mortgage</option>
                                        <option value="RHVRUSQ156N">Vacancy Rate</option>
                                        <option value="LREM64TTUSM156S">Employment</option>
                                        <option value="POPTHM">Population</option>
                                        <option value="M2REAL">Money Stock</option>
                                        <option value="FPCPITOTLZGUSA">Inflation</option>
                                        <option value="GFDEBTN">Government Debt</option>
                                        <option value="DGS10">10-Year Treasury</option>
                                        <option value="DGS2">2-Year Treasury</option>
                                        <option value="ACTLISCOUUS">Active Listings</option>
                                        <option value="MSPUS">Median Sale Price</option>
                                        <option value="NEWLISCOUUS">New Listings</option>
                                        <option value="MEDDAYONMARUS">Median Days on Market</option>
                                        <option value="UNRATE">Unemployment Rate</option>
                                    </select>
                                </div>
                                <div id="rightChart" style="width: 100%; height: 300px; display: flex; align-items: center; justify-content: center; background-color: #f9f9f9; border-radius: 4px;">
                                    <div class="loading-spinner" style="text-align: center;">
                                        <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 0 auto;"></div>
                                        <p style="margin-top: 10px; color: #666;">Loading chart data...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Home Stats</h2>
                    <div class="section-content">
                        <div id="homeStatsContent" style="display: flex; gap: 40px; min-height: 200px;">
                            <!-- Left Side - Property Information -->
                            <div style="flex: 1; padding: 25px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 12px; border: 1px solid #e9ecef; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                                <div style="margin-bottom: 20px;">
                                    <div id="propertyAddress" style="color: #34495e; font-size: 16px; font-weight: 500; margin-bottom: 8px; line-height: 1.4;">
                                        Loading address...
                                    </div>
                                    <div id="propertyDevelopment" style="color: #7f8c8d; font-size: 14px; margin-bottom: 6px;">
                                        Development information
                                    </div>
                                    <div id="propertySubdivision" style="color: #7f8c8d; font-size: 14px; margin-bottom: 20px;">
                                        Subdivision details
                                    </div>
                                </div>
                                
                                <!-- Action Icons -->
                                <div style="display: flex; gap: 15px; padding-top: 15px; border-top: 1px solid #e9ecef;">
                                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#3498db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                            <circle cx="12" cy="10" r="3"></circle>
                                        </svg>
                                        <span style="color: #3498db; font-size: 13px; font-weight: 500;">Map</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: #ffffff; border: 1px solid #dee2e6; border-radius: 8px; cursor: pointer; transition: all 0.2s ease;">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#27ae60" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="18" y1="20" x2="18" y2="10"></line>
                                            <line x1="12" y1="20" x2="12" y2="4"></line>
                                            <line x1="6" y1="20" x2="6" y2="14"></line>
                                        </svg>
                                        <span style="color: #27ae60; font-size: 13px; font-weight: 500;">Chart</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Side - Stats -->
                            <div style="flex: 1; padding: 25px; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border-radius: 12px; border: 1px solid #e9ecef; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; min-height: 150px;">
                                    <div style="text-align: center;">
                                        <h3 style="margin: 0; color: #2c3e50; font-size: 24px; font-weight: 300; letter-spacing: 2px; text-transform: uppercase;">Stats</h3>
                                        <div style="width: 60px; height: 2px; background: linear-gradient(90deg, #3498db, #27ae60); margin: 15px auto;"></div>
                                        <p style="margin: 10px 0 0 0; color: #7f8c8d; font-size: 14px; font-style: italic;">Market analytics coming soon</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2 style="text-align: center;">Neighbourhood Charts</h2>
                    <div class="section-content">
                        <div id="interestAreasContent">
                            <div class="info-item">
                                <div class="info-label">Areas of Interest</div>
                                <div class="info-value">Content coming soon</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>County Charts</h2>
                    <div class="section-content">
                        <div id="chartsContent">
                            <!-- Premium FRED Comparison Interface -->
                            <div class="fred-comparison-container">
                                <div class="comparison-controls" id="controls-section">
                                    <div class="control-group">
                                        <label for="series-select">Economic Indicator Selection</label>
                                        <select id="series-select" class="fred-select">
                                            <option value="loading">Loading available metrics...</option>
                                        </select>
                                    </div>
                                    
                                    <div class="locations-container">
                                        <h4>Regional Comparison Analysis</h4>
                                        <div id="location-selections">
                                            <!-- Dynamic location selectors will be added here -->
                                        </div>
                                    </div>
                                    
                                    <div class="action-buttons">
                                        <button id="add-location-btn" class="add-location-btn">Add Location</button>
                                        <button id="remove-location-btn" class="remove-location-btn" style="display: none;">Remove Location</button>
                                        <button id="compare-btn" class="compare-btn">
                                            <span>Generate Analysis</span>
                                        </button>
                                        <button id="reset-comparison-btn" class="reset-btn">Reset to Default</button>
                                    </div>
                                </div>
                                
                                <div class="chart-section" id="chart-section" style="display: none;">
                                    <div class="chart-controls">
                                        <button id="back-to-controls-btn" class="back-to-controls-btn">← Back to Controls</button>
                                    </div>
                                    <div id="comparison-chart-header" class="chart-header" style="display: none;">
                                        <h3>Comparative Market Analysis</h3>
                                        <p>Professional economic indicator comparison across selected regions</p>
                                    </div>
                                    <div id="comparison-chart-container">
                                        <div id="comparison-chart" class="fred-chart"></div>
                                        <div id="chart-loading" class="chart-loading-message" style="display: none;">
                                            <div class="loading-spinner-small"></div>
                                            <p>Generating comprehensive market analysis...</p>
                                        </div>
                                        <div id="chart-error" class="chart-error-message" style="display: none;">
                                            <p>Analysis temporarily unavailable. Please verify your selections and try again.</p>
                                        </div>
                                        <div id="data-availability-notice" class="data-notice" style="display: none;">
                                            <!-- Professional notice for unavailable data will be inserted here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="confidential">
                    <div class="confidential-title">Confidential Information</div>
                    <div class="confidential-text">
                        This area analysis has been prepared exclusively for authorized personnel and contains confidential and proprietary information. 
                        Distribution, reproduction, or disclosure to third parties is strictly prohibited without written consent.
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <div class="footer-content">
                <p>© 2025 Professional Area Analysis Services. All rights reserved.</p>
                <p>This report contains confidential and proprietary information intended solely for authorized personnel.</p>
            </div>
        </div>
    </div>

    <script>
        // Get report identifier from URL (could be lastname-id format or just ID)
        const urlParams = new URLSearchParams(window.location.search);
        let urlSlug = urlParams.get('id');
        
        // If no query parameter, extract from path
        if (!urlSlug) {
            const pathParts = window.location.pathname.split('/');
            urlSlug = pathParts[pathParts.length - 1]; // Get last part of path
        }
        
        // If still no slug or it's empty, show error
        if (!urlSlug || urlSlug === 'report.html') {
            console.error('No report identifier found in URL');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
        }

        async function loadReport() {
            // Don't load if no URL slug
            if (!urlSlug || urlSlug === 'report.html') {
                return;
            }
            
            try {
                console.log('Loading report with slug:', urlSlug);
                const response = await fetch(`/api/reports/complete/${urlSlug}`);
                const result = await response.json();

                console.log('API Response:', { status: response.status, result });
                document.getElementById('loading').style.display = 'none';

                if (response.ok && result.success) {
                    displayReport(result.data);
                } else {
                    console.error('API Error:', result.error || 'Unknown error');
                    document.getElementById('error').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading report:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        function displayReport(data) {
            console.log('Displaying report data:', data);
            document.getElementById('reportContent').style.display = 'block';
            
            // Update header information
            document.getElementById('agentName').textContent = data.agent_name || 'Agent Name';
            document.getElementById('buyerName').textContent = `${data.first_name} ${data.last_name}` || 'Buyer Name';
            document.getElementById('zipCode').textContent = data.zip_code || 'ZIP Code';
            
            // Charts - Skip overwriting chartsContent since it now contains FRED interface
            // Chart data is now handled by the FRED comparison interface in Area Charts section
            
            // Interest areas
            if (data.interest_areas && data.interest_areas.length > 0) {
                const areasHtml = data.interest_areas.map(area => `
                    <div class="info-item">
                        <div class="info-label">Interest ${area.interest_id}</div>
                        <div class="info-value">${area.city}, ${area.state}</div>
                    </div>
                `).join('');
                document.getElementById('interestAreasContent').innerHTML = `<div class="info-grid">${areasHtml}</div>`;
            }
            
            // Home Stats - Display property information
            displayHomeStats(data);
            
            // FRED Charts - Load the charts after displaying the report
            loadFredCharts(data.report_id);
        }
        
        function displayHomeStats(data) {
            // Format address with each component on separate lines
            let addressLines = [];
            
            // Address Line 1
            if (data.address_line_1 && data.address_line_1.trim()) {
                addressLines.push(data.address_line_1);
            }
            
            // Address Line 2 (if exists)
            if (data.address_line_2 && data.address_line_2.trim()) {
                addressLines.push(data.address_line_2);
            }
            
            // City, State, Zip
            let cityStateZip = [];
            if (data.home_city) cityStateZip.push(data.home_city);
            if (data.home_state) cityStateZip.push(data.home_state);
            if (data.zip_code) cityStateZip.push(data.zip_code);
            if (cityStateZip.length > 0) {
                addressLines.push(cityStateZip.join(', '));
            }
            
            // Development
            if (data.development && data.development.trim()) {
                addressLines.push(data.development);
            }
            
            // Subdivision
            if (data.subdivision && data.subdivision.trim()) {
                addressLines.push(data.subdivision);
            }
            
            // Update property details with styled formatting
            const addressElement = document.getElementById('propertyAddress');
            if (addressLines.length > 0) {
                let styledAddress = '';
                addressLines.forEach((line, index) => {
                    // Determine line type based on content pattern rather than position
                    const isCityStateZip = line.includes(',') && /\d{5}/.test(line); // Contains comma and 5-digit zip
                    const isStreetAddress = index === 0 || (index === 1 && !isCityStateZip);
                    
                    if (isStreetAddress) {
                        // Street address lines - larger and bolder
                        styledAddress += `<div style="font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 4px; line-height: 1.3;">${line}</div>`;
                    } else if (isCityStateZip) {
                        // City, State, Zip line - medium weight
                        styledAddress += `<div style="font-size: 15px; font-weight: 500; color: #34495e; margin-bottom: 8px; line-height: 1.3;">${line}</div>`;
                    } else {
                        // Development/Subdivision - lighter styling with subtle separation
                        styledAddress += `<div style="font-size: 14px; font-weight: 400; color: #7f8c8d; margin-bottom: 3px; line-height: 1.4; font-style: italic;">${line}</div>`;
                    }
                });
                addressElement.innerHTML = styledAddress;
            } else {
                addressElement.innerHTML = `<div style="font-size: 16px; color: #95a5a6; font-style: italic;">Address information not available</div>`;
            }
            
            // Hide the development and subdivision elements since they're now in the address
            document.getElementById('propertyDevelopment').style.display = 'none';
            document.getElementById('propertySubdivision').style.display = 'none';
            
            // Load development stats if development name is available
            if (data.development && data.development.trim()) {
                loadDevelopmentStats(data.development.trim());
            }
        }
        
        // Function to load development statistics
        async function loadDevelopmentStats(developmentName) {
            try {
                console.log('Loading stats for development:', developmentName);
                
                // Show loading state in stats section
                const statsSection = document.querySelector('#homeStatsContent > div:last-child');
                if (statsSection) {
                    statsSection.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; min-height: 150px;">
                            <div style="text-align: center;">
                                <div style="border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; margin: 0 auto 15px;"></div>
                                <p style="margin: 0; color: #7f8c8d; font-size: 14px;">Loading ${developmentName} statistics...</p>
                            </div>
                        </div>
                    `;
                }
                
                const response = await fetch(`/api/development-stats/${encodeURIComponent(developmentName)}`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    displayDevelopmentStats(result.data);
                } else {
                    console.error('Error loading development stats:', result.error);
                    displayStatsError('Unable to load development statistics');
                }
            } catch (error) {
                console.error('Error fetching development stats:', error);
                displayStatsError('Error loading statistics');
            }
        }
        
        // Function to display development statistics
        function displayDevelopmentStats(stats) {
            const statsSection = document.querySelector('#homeStatsContent > div:last-child');
            if (!statsSection) return;
            
            // Format large numbers for display
            const formatPrice = (price) => {
                if (!price || price === 0) return 'N/A';
                if (price >= 1000000) {
                    return `$${(price / 1000000).toFixed(1)}M`;
                } else if (price >= 1000) {
                    return `$${(price / 1000).toFixed(0)}K`;
                } else {
                    return `$${price.toLocaleString()}`;
                }
            };
            
            statsSection.innerHTML = `
                <div style="padding: 20px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #2c3e50; font-size: 16px; font-weight: 600; margin-bottom: 5px;">${stats.developmentName}</h3>
                        <div style="width: 60px; height: 2px; background: linear-gradient(90deg, #3498db, #27ae60); margin: 8px auto;"></div>
                        <p style="margin: 0; color: #7f8c8d; font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Development Statistics</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 13px;">
                        <!-- Left Column -->
                        <div>
                            <div style="margin-bottom: 8px;">
                                <strong>Tax:</strong> <span style="color: #2c3e50;">${stats.totalProperties}</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Active:</strong> <span style="color: #e74c3c;">${stats.activeListings}</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Active Under Contract:</strong> <span style="color: #f39c12;">${stats.underContract}</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Closed (&lt; 12 Mos.):</strong> <span style="color: #27ae60;">${stats.closedLast12Months}</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Closed (&lt; 3 Mos.):</strong> <span style="color: #27ae60;">${stats.closedLast3Months}</span>
                            </div>
                            ${stats.closedOlder > 0 ? `<div style="margin-bottom: 8px;"><strong>Closed (Older):</strong> <span style="color: #95a5a6;">${stats.closedOlder}</span></div>` : ''}
                            ${stats.pending > 0 ? `<div style="margin-bottom: 8px;"><strong>Pending:</strong> <span style="color: #8e44ad;">${stats.pending}</span></div>` : ''}
                            <div style="margin-bottom: 8px;">
                                <strong>Active %:</strong> <span style="color: #2c3e50;">${stats.activePercentage}%</span>
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div>
                            <div style="margin-bottom: 12px;">
                                <strong>MLS Median Sale Price (YTD):</strong>
                            </div>
                            ${Object.keys(stats.medianPrices).length > 0 ? 
                                Object.entries(stats.medianPrices)
                                    .sort(([a], [b]) => parseInt(a) - parseInt(b))
                                    .map(([year, price]) => {
                                        const count = stats.saleCounts[year] || 0;
                                        return `<div style="margin-bottom: 6px; margin-left: 10px;">
                                            <strong>${year}:</strong> <span style="color: ${year === '2025' ? '#3498db' : '#2c3e50'};">${formatPrice(price)} (${count})</span>
                                        </div>`;
                                    }).join('') 
                                : '<div style="margin-left: 10px; color: #95a5a6; font-style: italic;">No recent sales data</div>'
                            }
                            
                            <div style="margin-top: 15px;">
                                <div style="margin-bottom: 6px;">
                                    <strong>Months of Inventory (12mo):</strong> <span style="color: #8e44ad;">${stats.inventoryMonths.twelveMonth}</span>
                                </div>
                                <div style="margin-bottom: 6px;">
                                    <strong>Months of Inventory (3mo):</strong> <span style="color: #8e44ad;">${stats.inventoryMonths.threeMonth}</span>
                                </div>
                            </div>
                            
                            ${stats.avgDaysOnMarket > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong>Avg DOM (Active):</strong> <span style="color: #34495e;">${stats.avgDaysOnMarket} days</span>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Function to display stats error
        function displayStatsError(message) {
            const statsSection = document.querySelector('#homeStatsContent > div:last-child');
            if (statsSection) {
                statsSection.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; min-height: 150px;">
                        <div style="text-align: center;">
                            <div style="color: #e74c3c; font-size: 32px; margin-bottom: 15px;">📊</div>
                            <h3 style="margin: 0; color: #2c3e50; font-size: 18px; font-weight: 300; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px;">Stats</h3>
                            <div style="width: 60px; height: 2px; background: linear-gradient(90deg, #3498db, #27ae60); margin: 8px auto 15px;"></div>
                            <p style="margin: 0; color: #e74c3c; font-size: 13px;">${message}</p>
                        </div>
                    </div>
                `;
            }
        }

        // FRED series configuration
        const FRED_SERIES = {
            'GDP': 'GDP',
            'CPIAUCSL': 'CPI',
            'PPIACO': 'PPI',
            'FEDFUNDS': 'Fed Funds Rate',
            'MORTGAGE30US': '30-Year Mortgage',
            'MORTGAGE15US': '15-Year Mortgage',
            'RHVRUSQ156N': 'Vacancy Rate',
            'LREM64TTUSM156S': 'Employment',
            'POPTHM': 'Population',
            'M2REAL': 'Money Stock',
            'FPCPITOTLZGUSA': 'Inflation',
            'GFDEBTN': 'Government Debt',
            'DGS10': '10-Year Treasury',
            'DGS2': '2-Year Treasury',
            'ACTLISCOUUS': 'Active Listings',
            'MSPUS': 'Median Sale Price',
            'NEWLISCOUUS': 'New Listings',
            'MEDDAYONMARUS': 'Median Days on Market',
            'USSTHPI': 'Housing Price Index',
            'UNRATE': 'Unemployment Rate',
            'DJIA': 'Dow Jones Industrial Average'
        };

        // Function to fetch and display FRED charts
        async function loadFredCharts(reportId) {
            let leftSeriesId = 'USSTHPI';  // Default
            let rightSeriesId = 'DJIA';    // Default
            
            try {
                // Load saved FRED charts from database
                const response = await fetch(`/api/reports/${reportId}/fred-charts`);
                const result = await response.json();
                
                if (response.ok && result.success && result.data.length > 0) {
                    // Find left and right charts by chart_id (smaller = left, larger = right)
                    const sortedCharts = result.data.sort((a, b) => a.chart_id - b.chart_id);
                    const leftChart = sortedCharts[0];
                    const rightChart = sortedCharts[1];
                    
                    if (leftChart) leftSeriesId = leftChart.series_id;
                    if (rightChart) rightSeriesId = rightChart.series_id;
                }
            } catch (error) {
                console.error('Error loading FRED charts from database:', error);
                // Continue with defaults
            }
            
            // Set dropdown values and titles
            document.getElementById('leftChartSelect').value = leftSeriesId;
            document.getElementById('rightChartSelect').value = rightSeriesId;
            document.getElementById('leftChartTitle').textContent = FRED_SERIES[leftSeriesId] || leftSeriesId;
            document.getElementById('rightChartTitle').textContent = FRED_SERIES[rightSeriesId] || rightSeriesId;
            
            // Setup dropdown event listeners with save functionality
            document.getElementById('leftChartSelect').addEventListener('change', async function() {
                const seriesId = this.value;
                const title = FRED_SERIES[seriesId] || seriesId;
                document.getElementById('leftChartTitle').textContent = title;
                loadChartData('leftChart', seriesId, '#2E8B57');
                
                // Save to database
                await saveFredCharts(reportId);
            });
            
            document.getElementById('rightChartSelect').addEventListener('change', async function() {
                const seriesId = this.value;
                const title = FRED_SERIES[seriesId] || seriesId;
                document.getElementById('rightChartTitle').textContent = title;
                loadChartData('rightChart', seriesId, '#1E90FF');
                
                // Save to database
                await saveFredCharts(reportId);
            });

            // Load initial charts
            loadChartData('leftChart', leftSeriesId, '#2E8B57');
            loadChartData('rightChart', rightSeriesId, '#1E90FF');
        }
        
        // Function to save FRED charts to database
        async function saveFredCharts(reportId) {
            try {
                const leftSeriesId = document.getElementById('leftChartSelect').value;
                const rightSeriesId = document.getElementById('rightChartSelect').value;
                
                const response = await fetch(`/api/reports/${reportId}/fred-charts`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        leftSeriesId: leftSeriesId,
                        rightSeriesId: rightSeriesId
                    })
                });
                
                const result = await response.json();
                if (!response.ok || !result.success) {
                    console.error('Error saving FRED charts:', result.error);
                }
            } catch (error) {
                console.error('Error saving FRED charts:', error);
            }
        }

        // Function to load chart data
        function loadChartData(containerId, seriesId, color) {
            const currentDate = new Date();
            const fiveYearsAgo = new Date(currentDate.getFullYear() - 5, currentDate.getMonth(), currentDate.getDate());
            
            const startDate = fiveYearsAgo.toISOString().split('T')[0];
            const endDate = currentDate.toISOString().split('T')[0];
            
            const title = FRED_SERIES[seriesId] || seriesId;
            loadFredChart(seriesId, containerId, startDate, endDate, title, color);
        }

        // Function to load individual FRED chart
        async function loadFredChart(seriesId, containerId, startDate, endDate, title, color) {
            try {
                const response = await fetch(`/api/fred-data?seriesId=${seriesId}&startDate=${startDate}&endDate=${endDate}`);
                const data = await response.json();
                
                if (data.observations && data.observations.length > 0) {
                    renderChart(containerId, data.observations, title, color);
                } else {
                    document.getElementById(containerId).innerHTML = `
                        <div style="text-align: center; color: #666; padding: 20px;">
                            <p>No data available for ${title}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(`Error loading ${seriesId} data:`, error);
                document.getElementById(containerId).innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 20px;">
                        <p>Error loading ${title} data</p>
                    </div>
                `;
            }
        }

        // Function to render a simple line chart
        function renderChart(containerId, observations, title, color) {
            const container = document.getElementById(containerId);
            const validData = observations.filter(obs => obs.value !== '.' && !isNaN(parseFloat(obs.value)));
            
            if (validData.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 20px;">
                        <p>No valid data available for ${title}</p>
                    </div>
                `;
                return;
            }

            const values = validData.map(obs => parseFloat(obs.value));
            const dates = validData.map(obs => obs.date);
            const minValue = Math.min(...values);
            const maxValue = Math.max(...values);
            const range = maxValue - minValue;
            
            const svgWidth = container.offsetWidth - 40;
            const svgHeight = 260;
            const padding = 40;
            
            let svgContent = `
                <svg width="100%" height="${svgHeight}" style="background: white; border-radius: 4px;">
                    <defs>
                        <linearGradient id="gradient-${containerId}" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:${color};stop-opacity:0.3" />
                            <stop offset="100%" style="stop-color:${color};stop-opacity:0.1" />
                        </linearGradient>
                    </defs>
            `;
            
            // Create path for line chart
            let pathData = '';
            let areaPath = '';
            
            validData.forEach((obs, index) => {
                const x = padding + (index / (validData.length - 1)) * (svgWidth - 2 * padding);
                const y = svgHeight - padding - ((parseFloat(obs.value) - minValue) / range) * (svgHeight - 2 * padding);
                
                if (index === 0) {
                    pathData += `M ${x} ${y}`;
                    areaPath += `M ${x} ${svgHeight - padding} L ${x} ${y}`;
                } else {
                    pathData += ` L ${x} ${y}`;
                    areaPath += ` L ${x} ${y}`;
                }
                
                if (index === validData.length - 1) {
                    areaPath += ` L ${x} ${svgHeight - padding} Z`;
                }
            });
            
            svgContent += `
                <path d="${areaPath}" fill="url(#gradient-${containerId})" />
                <path d="${pathData}" stroke="${color}" stroke-width="2" fill="none" />
                
                <!-- Y-axis labels -->
                <text x="10" y="30" font-size="10" fill="#666">${maxValue.toLocaleString()}</text>
                <text x="10" y="${svgHeight - 10}" font-size="10" fill="#666">${minValue.toLocaleString()}</text>
                
                <!-- X-axis labels -->
                <text x="${padding}" y="${svgHeight - 5}" font-size="10" fill="#666">${dates[0]}</text>
                <text x="${svgWidth - padding - 60}" y="${svgHeight - 5}" font-size="10" fill="#666">${dates[dates.length - 1]}</text>
                
                <!-- Latest value -->
                <circle cx="${padding + ((validData.length - 1) / (validData.length - 1)) * (svgWidth - 2 * padding)}" 
                        cy="${svgHeight - padding - ((values[values.length - 1] - minValue) / range) * (svgHeight - 2 * padding)}" 
                        r="4" fill="${color}" />
                
                </svg>
            `;
            
            container.innerHTML = svgContent;
        }

        // FRED Comparison Functionality for Area Charts
        let seriesOptionsCache = null;
        let selectionCount = 1;
        const maxSelections = 5;
        
        // Available states for county selection (alphabetically sorted)
        const availableStates = [
            'Alabama', 'Arizona', 'California', 'Colorado', 'Connecticut', 'Florida',
            'Georgia', 'Illinois', 'Indiana', 'Kentucky', 'Louisiana', 'Maryland',
            'Massachusetts', 'Michigan', 'Minnesota', 'Missouri', 'New Jersey', 'New York',
            'North Carolina', 'Ohio', 'Oklahoma', 'Oregon', 'Pennsylvania', 'South Carolina',
            'Tennessee', 'Texas', 'Utah', 'Virginia', 'Washington', 'Wisconsin'
        ];
        
        // Initialize FRED comparison functionality
        async function initializeFredComparison() {
            try {
                // Load series options
                await loadSeriesOptions();
                
                // Load saved comparison data for this report
                await loadSavedComparison();
                
                // Setup event listeners
                setupEventListeners();
                
            } catch (error) {
                console.error('Error initializing FRED comparison:', error);
                document.getElementById('chartsContent').innerHTML = `
                    <div class="info-item">
                        <div class="info-label">Area Charts</div>
                        <div class="info-value">Unable to load comparison tools. Please try refreshing the page.</div>
                    </div>
                `;
            }
        }
        
        // Load available FRED series from database
        async function loadSeriesOptions() {
            try {
                const response = await fetch('/api/fred-series?level=COUNTY');
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error('Failed to fetch series options');
                }
                
                const seriesSelect = document.getElementById('series-select');
                if (!seriesSelect) {
                    console.error('series-select element not found');
                    throw new Error('series-select element not found in DOM');
                }
                seriesSelect.innerHTML = '';
                
                // Convert to the expected format
                const options = {};
                result.data.forEach(item => {
                    options[item.key_name] = {
                        series: item.series_pattern,
                        lead_zero: item.lead_zero,
                        display_name: item.display_name,
                        sort_order: item.sort_order || 999,
                        description: item.description || ''
                    };
                    
                    // Add option to select element
                    const option = document.createElement('option');
                    option.value = item.key_name;
                    option.textContent = item.display_name;
                    seriesSelect.appendChild(option);
                });
                
                seriesOptionsCache = options;
                
                // Set default selection to Active County Inventory or first available
                const defaultSeries = 'ACTIVE_COUNTY_INVENTORY';
                if (options[defaultSeries]) {
                    seriesSelect.value = defaultSeries;
                } else if (result.data.length > 0) {
                    seriesSelect.value = result.data[0].key_name;
                }
                
            } catch (error) {
                console.error('Error loading series options:', error);
                // Fallback options
                const seriesSelect = document.getElementById('series-select');
                if (seriesSelect) {
                    seriesSelect.innerHTML = `
                        <option value="ACTLISCOU{COUNTY}">Active County Inventory</option>
                        <option value="ATNHPIUS{COUNTY}A">All Transactions HPI</option>
                        <option value="GDPALL{COUNTY}">County GDP</option>
                    `;
                }
            }
        }
        
        // Load saved comparison data for this report
        async function loadSavedComparison() {
            try {
                console.log('Loading saved comparison for report:', urlSlug);
                const response = await fetch(`/api/reports/${urlSlug}/area-comparison`);
                const result = await response.json();
                
                if (response.ok && result.success && result.data) {
                    const savedData = result.data;
                    console.log('Found saved comparison:', savedData);
                    
                    // Set the series selection
                    if (savedData.series_id) {
                        document.getElementById('series-select').value = savedData.series_id;
                    }
                    
                    // Load the county locations and populate dropdowns
                    if (savedData.locations && savedData.locations.length > 0) {
                        await loadSavedLocations(savedData.locations);
                        // Auto-generate the chart with the loaded data
                        await generateComparison();
                    } else {
                        // No saved data, initialize with default Palm Beach County
                        resetToDefault();
                    }
                } else {
                    console.log('No saved comparison found, using defaults');
                    // No saved data, initialize with default Palm Beach County
                    resetToDefault();
                }
            } catch (error) {
                console.error('Error loading saved comparison:', error);
                // Fallback to default
                resetToDefault();
            }
        }
        
        // Load saved locations and populate the dropdowns
        async function loadSavedLocations(countyIds) {
            try {
                // Set the selection count based on saved locations
                selectionCount = countyIds.length;
                
                // Update the location selections UI
                await updateLocationSelections();
                
                // For each saved county ID, we need to find the state and set the dropdowns
                for (let i = 0; i < countyIds.length; i++) {
                    const countyId = countyIds[i];
                    const selectionIndex = i + 1;
                    
                    // Get state and county info for this county ID
                    await loadCountyById(countyId, selectionIndex);
                }
                
                updateButtons();
                
            } catch (error) {
                console.error('Error loading saved locations:', error);
                await resetToDefault();
            }
        }
        
        // Load county info by ID and set the appropriate dropdowns
        async function loadCountyById(countyId, selectionIndex) {
            try {
                // We need to find which state this county belongs to
                // We'll try each state until we find the county
                for (const state of availableStates) {
                    const response = await fetch(`/api/counties?state=${encodeURIComponent(state)}`);
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        const county = result.data.find(c => c.id === countyId);
                        if (county) {
                            // Found the county in this state
                            const stateSelect = document.getElementById(`state-select-${selectionIndex}`);
                            const countySelect = document.getElementById(`county-select-${selectionIndex}`);
                            
                            if (stateSelect && countySelect) {
                                // Set the state
                                stateSelect.value = state;
                                
                                // Populate and set the county
                                countySelect.innerHTML = '<option value="">Select County</option>';
                                const sortedCounties = result.data.sort((a, b) => a.name.localeCompare(b.name));
                                sortedCounties.forEach(countyOption => {
                                    const option = document.createElement('option');
                                    option.value = countyOption.id;
                                    option.textContent = countyOption.name;
                                    if (countyOption.id === countyId) {
                                        option.selected = true;
                                    }
                                    countySelect.appendChild(option);
                                });
                            }
                            
                            return; // Found and set, exit the function
                        }
                    }
                }
                
                console.warn(`County ID ${countyId} not found in any state`);
            } catch (error) {
                console.error(`Error loading county by ID ${countyId}:`, error);
            }
        }
        
        // Setup event listeners for the comparison controls
        function setupEventListeners() {
            document.getElementById('add-location-btn').addEventListener('click', async () => {
                await addLocationSelection();
            });
            document.getElementById('remove-location-btn').addEventListener('click', async () => {
                await removeLocationSelection();
            });
            document.getElementById('compare-btn').addEventListener('click', generateComparison);
            document.getElementById('reset-comparison-btn').addEventListener('click', resetToDefault);
            document.getElementById('back-to-controls-btn').addEventListener('click', showControlsView);
        }
        
        // Show the controls view and hide the chart view
        function showControlsView() {
            document.getElementById('controls-section').style.display = 'block';
            document.getElementById('chart-section').style.display = 'none';
        }
        
        // Show the chart view and hide the controls view  
        function showChartView() {
            document.getElementById('controls-section').style.display = 'none';
            document.getElementById('chart-section').style.display = 'block';
        }
        
        // Add a new location selection dropdown
        async function addLocationSelection() {
            if (selectionCount >= maxSelections) return;
            
            selectionCount++;
            await updateLocationSelections();
            updateButtons();
        }
        
        // Remove the last location selection
        async function removeLocationSelection() {
            if (selectionCount <= 1) return;
            
            selectionCount--;
            await updateLocationSelections();
            updateButtons();
        }
        
        // Update the location selection interface
        async function updateLocationSelections() {
            const container = document.getElementById('location-selections');
            
            // Store current selections before updating
            const currentSelections = {};
            for (let i = 1; i <= Math.max(selectionCount, container.children.length); i++) {
                const stateSelect = document.getElementById(`state-select-${i}`);
                const countySelect = document.getElementById(`county-select-${i}`);
                if (stateSelect && countySelect) {
                    currentSelections[i] = {
                        state: stateSelect.value,
                        county: countySelect.value
                    };
                }
            }
            
            // Only rebuild if we need more elements or fewer elements
            const currentCount = container.children.length;
            
            if (selectionCount > currentCount) {
                // Add new location selections
                for (let i = currentCount + 1; i <= selectionCount; i++) {
                    const locationDiv = document.createElement('div');
                    locationDiv.className = 'location-selection';
                    locationDiv.id = `location-${i}`;
                    locationDiv.innerHTML = `
                        <div>
                            <label>State Selection</label>
                            <select id="state-select-${i}" onchange="updateCounties(${i})">
                                <option value="">Choose State</option>
                                ${availableStates.map(state => 
                                    `<option value="${state}"${state === 'Florida' && i === 1 ? ' selected' : ''}>${state}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div>
                            <label>County Selection</label>
                            <select id="county-select-${i}">
                                <option value="">Choose County</option>
                            </select>
                        </div>
                    `;
                    container.appendChild(locationDiv);
                }
            } else if (selectionCount < currentCount) {
                // Remove excess location selections
                for (let i = currentCount; i > selectionCount; i--) {
                    const locationDiv = document.getElementById(`location-${i}`);
                    if (locationDiv) {
                        locationDiv.remove();
                    }
                }
            }
            
            // Restore previous selections
            for (let i = 1; i <= selectionCount; i++) {
                const stateSelect = document.getElementById(`state-select-${i}`);
                const countySelect = document.getElementById(`county-select-${i}`);
                
                if (currentSelections[i] && currentSelections[i].state) {
                    // Restore state selection
                    stateSelect.value = currentSelections[i].state;
                    
                    // Load counties for this state and then restore county selection
                    await updateCounties(i);
                    
                    // Restore county selection
                    if (currentSelections[i].county) {
                        countySelect.value = currentSelections[i].county;
                    }
                } else if (i === 1 && !currentSelections[i]) {
                    // Default first selection to Florida if no previous selection
                    stateSelect.value = 'Florida';
                    await updateCounties(i);
                }
            }
        }
        
        // Update counties dropdown when state changes
        async function updateCounties(selectionIndex) {
            const stateSelect = document.getElementById(`state-select-${selectionIndex}`);
            const countySelect = document.getElementById(`county-select-${selectionIndex}`);
            
            if (!stateSelect.value) {
                countySelect.innerHTML = '<option value="">Select County</option>';
                return;
            }
            
            try {
                const response = await fetch(`/api/counties?state=${encodeURIComponent(stateSelect.value)}`);
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error('Failed to fetch counties');
                }
                
                countySelect.innerHTML = '<option value="">Select County</option>';
                
                // Sort counties alphabetically by name
                const sortedCounties = result.data.sort((a, b) => a.name.localeCompare(b.name));
                
                sortedCounties.forEach(county => {
                    const option = document.createElement('option');
                    option.value = county.id;
                    option.textContent = county.name;
                    
                    // Default Palm Beach County for Florida
                    if (selectionIndex === 1 && stateSelect.value === 'Florida' && county.name === 'Palm Beach County') {
                        option.selected = true;
                    }
                    
                    countySelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error fetching counties:', error);
                countySelect.innerHTML = '<option value="">Error loading counties</option>';
            }
        }
        
        // Update button visibility
        function updateButtons() {
            const addBtn = document.getElementById('add-location-btn');
            const removeBtn = document.getElementById('remove-location-btn');
            
            addBtn.style.display = selectionCount >= maxSelections ? 'none' : 'inline-block';
            removeBtn.style.display = selectionCount <= 1 ? 'none' : 'inline-block';
        }
        
        // Reset to default (Palm Beach County only)
        async function resetToDefault() {
            selectionCount = 1;
            await updateLocationSelections();
            updateButtons();
            
            // Clear any existing chart, header, and notices
            document.getElementById('comparison-chart').innerHTML = '';
            document.getElementById('chart-loading').style.display = 'none';
            document.getElementById('chart-error').style.display = 'none';
            document.getElementById('comparison-chart-header').style.display = 'none';
            document.getElementById('data-availability-notice').style.display = 'none';
            
            // Reset series selection to default
            const seriesSelect = document.getElementById('series-select');
            const defaultSeries = 'ACTIVE_COUNTY_INVENTORY';
            if (seriesOptionsCache && seriesOptionsCache[defaultSeries]) {
                seriesSelect.value = defaultSeries;
            } else if (seriesSelect.options.length > 1) {
                seriesSelect.selectedIndex = 1; // First non-empty option
            }
            
            // Clear saved comparison data
            await clearSavedComparison();
            
            // Switch back to controls view
            showControlsView();
        }
        
        // Clear saved comparison data from database
        async function clearSavedComparison() {
            try {
                // Save empty data to effectively clear the comparison
                const response = await fetch(`/api/reports/${urlSlug}/area-comparison`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        seriesId: 'ACTIVE_COUNTY_INVENTORY',
                        countyIds: ['12099'] // Default Palm Beach County
                    })
                });
                
                if (!response.ok) {
                    console.warn('Failed to clear saved comparison data');
                }
            } catch (error) {
                console.error('Error clearing saved comparison data:', error);
            }
        }
        
        // Generate the comparison chart
        async function generateComparison() {
            const seriesSelect = document.getElementById('series-select');
            const selectedSeries = seriesSelect.value;
            
            if (!selectedSeries || !seriesOptionsCache) {
                alert('Please select a metric to compare');
                return;
            }
            
            // Collect all selections  
            const selections = [];
            let hasValidSelections = false;
            
            for (let i = 1; i <= selectionCount; i++) {
                const stateSelect = document.getElementById(`state-select-${i}`);
                const countySelect = document.getElementById(`county-select-${i}`);
                
                if (stateSelect && countySelect && stateSelect.value && countySelect.value) {
                    selections.push({
                        state: stateSelect.value,
                        county: countySelect.value,
                        countyName: countySelect.options[countySelect.selectedIndex].text
                    });
                    hasValidSelections = true;
                }
            }
            
            if (!hasValidSelections) {
                alert('Please select at least one location to compare');
                return;
            }
            
            // Save the comparison data before generating chart
            await saveComparisonData(selectedSeries, selections);
            
            // Switch to chart view and show loading state
            showChartView();
            document.getElementById('chart-loading').style.display = 'flex';
            document.getElementById('chart-error').style.display = 'none';
            document.getElementById('comparison-chart').innerHTML = '';
            
            try {
                const seriesOption = seriesOptionsCache[selectedSeries];
                const chartData = {};
                const countyNames = {};
                const unavailableLocations = [];
                
                // Fetch data for each selected location
                for (const selection of selections) {
                    // Apply leading zeros based on series configuration
                    const countyCode = seriesOption.lead_zero ? 
                        selection.county.padStart(5, '0') : 
                        selection.county.replace(/^0+/, '');
                    
                    // Replace {COUNTY} placeholder with actual county code
                    const seriesId = seriesOption.series.replace('{COUNTY}', countyCode);
                    
                    try {
                        const fredData = await fetchFredData(seriesId);
                        if (fredData && fredData.length > 0) {
                            chartData[selection.county] = fredData.map(obs => ({
                                date: new Date(obs.date),
                                value: parseFloat(obs.value)
                            })).filter(obs => !isNaN(obs.value));
                            countyNames[selection.county] = selection.countyName;
                        } else {
                            unavailableLocations.push({
                                name: selection.countyName,
                                seriesId: seriesId
                            });
                        }
                    } catch (error) {
                        console.warn(`Failed to fetch data for ${selection.countyName}:`, error);
                        unavailableLocations.push({
                            name: selection.countyName,
                            seriesId: seriesId,
                            error: error.message
                        });
                    }
                }
                
                // Hide loading state
                document.getElementById('chart-loading').style.display = 'none';
                
                if (Object.keys(chartData).length === 0) {
                    document.getElementById('chart-error').style.display = 'flex';
                    document.getElementById('comparison-chart-header').style.display = 'none';
                    return;
                }
                
                // Show chart header and create the comparison chart
                document.getElementById('comparison-chart-header').style.display = 'block';
                createSimpleComparisonChart(chartData, countyNames, seriesOption.display_name);
                
                // Display professional notification for unavailable data
                if (unavailableLocations.length > 0) {
                    displayDataAvailabilityNotice(unavailableLocations, seriesOption.display_name);
                }
                
            } catch (error) {
                console.error('Error generating comparison:', error);
                document.getElementById('chart-loading').style.display = 'none';
                document.getElementById('chart-error').style.display = 'flex';
            }
        }
        
        // Save comparison data to database
        async function saveComparisonData(seriesId, selections) {
            try {
                console.log('Saving comparison data:', { seriesId, selections });
                
                // Extract county IDs from selections
                const countyIds = selections.map(selection => selection.county);
                
                const response = await fetch(`/api/reports/${urlSlug}/area-comparison`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        seriesId: seriesId,
                        countyIds: countyIds
                    })
                });
                
                const result = await response.json();
                if (!response.ok || !result.success) {
                    console.error('Error saving comparison data:', result.error);
                } else {
                    console.log('Comparison data saved successfully');
                }
            } catch (error) {
                console.error('Error saving comparison data:', error);
                // Don't block the chart generation if save fails
            }
        }
        
        // Fetch FRED data for a specific series
        async function fetchFredData(seriesId) {
            const endDate = new Date().toISOString().split('T')[0];
            const startDate = new Date(new Date().setFullYear(new Date().getFullYear() - 5))
                .toISOString().split('T')[0];
            
            const response = await fetch(`/api/fred-data?seriesId=${seriesId}&startDate=${startDate}&endDate=${endDate}`);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to fetch FRED data');
            }
            
            return data.observations || [];
        }
        
        // Create a simple comparison chart using SVG
        function createSimpleComparisonChart(data, countyNames, title) {
            const container = document.getElementById('comparison-chart');
            const containerWidth = container.offsetWidth || 500;
            const containerHeight = Math.max(container.offsetHeight || 450, 450);
            const margin = { top: 40, right: 120, bottom: 60, left: 80 };
            const width = containerWidth - margin.left - margin.right;
            const height = containerHeight - margin.top - margin.bottom;
            
            // Luxury color palette for different counties
            const colors = ['#1a365d', '#c6a96a', '#2d3748', '#d4af37', '#4a5568'];
            
            // Combine all data to find extents
            const allData = Object.values(data).flat();
            if (allData.length === 0) return;
            
            const xExtent = d3.extent(allData, d => d.date);
            const yExtent = d3.extent(allData, d => d.value);
            
            // Create scales
            const xScale = d3.scaleTime()
                .domain(xExtent)
                .range([0, width]);
                
            const yScale = d3.scaleLinear()
                .domain(yExtent)
                .range([height, 0]);
            
            // Create line generator
            const line = d3.line()
                .x(d => xScale(d.date))
                .y(d => yScale(d.value))
                .curve(d3.curveMonotoneX);
            
            // Create SVG
            let svgContent = `
                <svg width="100%" height="${containerHeight}">
                    <g transform="translate(${margin.left},${margin.top})">
                        <!-- Grid lines -->
                        <defs>
                            <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
                                <path d="M 50 0 L 0 0 0 50" fill="none" stroke="#f0f0f0" stroke-width="1"/>
                            </pattern>
                        </defs>
                        <rect width="${width}" height="${height}" fill="url(#grid)" />
                        
                        <!-- Y-axis -->
                        <g>
                            ${yScale.ticks(6).map(tick => `
                                <g>
                                    <line x1="0" y1="${yScale(tick)}" x2="${width}" y2="${yScale(tick)}" stroke="#e0e0e0" stroke-width="1"/>
                                    <text x="-10" y="${yScale(tick)}" text-anchor="end" dy="0.35em" font-size="12" fill="#666">
                                        ${tick.toLocaleString()}
                                    </text>
                                </g>
                            `).join('')}
                        </g>
                        
                        <!-- X-axis -->
                        <g transform="translate(0,${height})">
                            ${xScale.ticks(6).map(tick => `
                                <g>
                                    <line x1="${xScale(tick)}" y1="0" x2="${xScale(tick)}" y2="-${height}" stroke="#e0e0e0" stroke-width="1"/>
                                    <text x="${xScale(tick)}" y="20" text-anchor="middle" font-size="12" fill="#666">
                                        ${tick.getFullYear()}
                                    </text>
                                </g>
                            `).join('')}
                        </g>
                        
                        <!-- Data lines -->
                        ${Object.entries(data).map(([countyId, countyData], index) => `
                            <path d="${line(countyData)}" 
                                  fill="none" 
                                  stroke="${colors[index % colors.length]}" 
                                  stroke-width="3" 
                                  opacity="0.8"/>
                        `).join('')}
                        
                        <!-- Legend -->
                        ${Object.entries(countyNames).map(([countyId, name], index) => `
                            <g transform="translate(${width + 15}, ${index * 20 + 20})">
                                <rect x="0" y="-7" width="14" height="4" fill="${colors[index % colors.length]}"/>
                                <text x="20" y="0" font-size="11" fill="#333">${name.replace(' County', '')}</text>
                            </g>
                        `).join('')}
                        
                        <!-- Title -->
                        <text x="${width/2}" y="-15" text-anchor="middle" font-size="16" font-weight="bold" fill="#333">
                            ${title}
                        </text>
                    </g>
                </svg>
            `;
            
            container.innerHTML = svgContent;
        }
        
        // Display professional notice for unavailable data series
        function displayDataAvailabilityNotice(unavailableLocations, seriesName) {
            const noticeContainer = document.getElementById('data-availability-notice');
            
            if (unavailableLocations.length === 0) {
                noticeContainer.style.display = 'none';
                return;
            }
            
            const locationsList = unavailableLocations.map(location => 
                `<li>${location.name}</li>`
            ).join('');
            
            const pluralText = unavailableLocations.length === 1 ? 'location' : 'locations';
            const verbText = unavailableLocations.length === 1 ? 'is' : 'are';
            
            noticeContainer.innerHTML = `
                <div class="data-notice-header">
                    <svg class="data-notice-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>
                    <h4 class="data-notice-title">Data Availability Notice</h4>
                </div>
                <p class="data-notice-content">
                    The <strong>${seriesName}</strong> indicator ${verbText} currently unavailable for the following ${pluralText}. 
                    This may be due to data collection schedules or regional reporting variations. 
                    The analysis above reflects all available data sources.
                </p>
                <ul class="unavailable-locations">
                    ${locationsList}
                </ul>
            `;
            
            noticeContainer.style.display = 'block';
        }
        
        // Global function to update counties (called from inline onchange)
        window.updateCounties = updateCounties;
        
        // Load report on page load
        loadReport();
        
        // Initialize FRED comparison after report loads
        function waitForElements() {
            const seriesSelect = document.getElementById('series-select');
            if (seriesSelect) {
                initializeFredComparison();
            } else {
                console.log('Waiting for FRED elements to load...');
                setTimeout(waitForElements, 500);
            }
        }
        setTimeout(waitForElements, 1000);
    </script>
</body>
</html>
